<!DOCTYPE html>
<html class="no-js"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><style type="text/css">.swal-icon--error{border-color:#f27474;-webkit-animation:animateErrorIcon .5s;animation:animateErrorIcon .5s}.swal-icon--error__x-mark{position:relative;display:block;-webkit-animation:animateXMark .5s;animation:animateXMark .5s}.swal-icon--error__line{position:absolute;height:5px;width:47px;background-color:#f27474;display:block;top:37px;border-radius:2px}.swal-icon--error__line--left{-webkit-transform:rotate(45deg);transform:rotate(45deg);left:17px}.swal-icon--error__line--right{-webkit-transform:rotate(-45deg);transform:rotate(-45deg);right:16px}@-webkit-keyframes animateErrorIcon{0%{-webkit-transform:rotateX(100deg);transform:rotateX(100deg);opacity:0}to{-webkit-transform:rotateX(0deg);transform:rotateX(0deg);opacity:1}}@keyframes animateErrorIcon{0%{-webkit-transform:rotateX(100deg);transform:rotateX(100deg);opacity:0}to{-webkit-transform:rotateX(0deg);transform:rotateX(0deg);opacity:1}}@-webkit-keyframes animateXMark{0%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}50%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}80%{-webkit-transform:scale(1.15);transform:scale(1.15);margin-top:-6px}to{-webkit-transform:scale(1);transform:scale(1);margin-top:0;opacity:1}}@keyframes animateXMark{0%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}50%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}80%{-webkit-transform:scale(1.15);transform:scale(1.15);margin-top:-6px}to{-webkit-transform:scale(1);transform:scale(1);margin-top:0;opacity:1}}.swal-icon--warning{border-color:#f8bb86;-webkit-animation:pulseWarning .75s infinite alternate;animation:pulseWarning .75s infinite alternate}.swal-icon--warning__body{width:5px;height:47px;top:10px;border-radius:2px;margin-left:-2px}.swal-icon--warning__body,.swal-icon--warning__dot{position:absolute;left:50%;background-color:#f8bb86}.swal-icon--warning__dot{width:7px;height:7px;border-radius:50%;margin-left:-4px;bottom:-11px}@-webkit-keyframes pulseWarning{0%{border-color:#f8d486}to{border-color:#f8bb86}}@keyframes pulseWarning{0%{border-color:#f8d486}to{border-color:#f8bb86}}.swal-icon--success{border-color:#a5dc86}.swal-icon--success:after,.swal-icon--success:before{content:"";border-radius:50%;position:absolute;width:60px;height:120px;background:#fff;-webkit-transform:rotate(45deg);transform:rotate(45deg)}.swal-icon--success:before{border-radius:120px 0 0 120px;top:-7px;left:-33px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);-webkit-transform-origin:60px 60px;transform-origin:60px 60px}.swal-icon--success:after{border-radius:0 120px 120px 0;top:-11px;left:30px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);-webkit-transform-origin:0 60px;transform-origin:0 60px;-webkit-animation:rotatePlaceholder 4.25s ease-in;animation:rotatePlaceholder 4.25s ease-in}.swal-icon--success__ring{width:80px;height:80px;border:4px solid hsla(98,55%,69%,.2);border-radius:50%;box-sizing:content-box;position:absolute;left:-4px;top:-4px;z-index:2}.swal-icon--success__hide-corners{width:5px;height:90px;background-color:#fff;padding:1px;position:absolute;left:28px;top:8px;z-index:1;-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.swal-icon--success__line{height:5px;background-color:#a5dc86;display:block;border-radius:2px;position:absolute;z-index:2}.swal-icon--success__line--tip{width:25px;left:14px;top:46px;-webkit-transform:rotate(45deg);transform:rotate(45deg);-webkit-animation:animateSuccessTip .75s;animation:animateSuccessTip .75s}.swal-icon--success__line--long{width:47px;right:8px;top:38px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);-webkit-animation:animateSuccessLong .75s;animation:animateSuccessLong .75s}@-webkit-keyframes rotatePlaceholder{0%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}5%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}12%{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}to{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}}@keyframes rotatePlaceholder{0%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}5%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}12%{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}to{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}}@-webkit-keyframes animateSuccessTip{0%{width:0;left:1px;top:19px}54%{width:0;left:1px;top:19px}70%{width:50px;left:-8px;top:37px}84%{width:17px;left:21px;top:48px}to{width:25px;left:14px;top:45px}}@keyframes animateSuccessTip{0%{width:0;left:1px;top:19px}54%{width:0;left:1px;top:19px}70%{width:50px;left:-8px;top:37px}84%{width:17px;left:21px;top:48px}to{width:25px;left:14px;top:45px}}@-webkit-keyframes animateSuccessLong{0%{width:0;right:46px;top:54px}65%{width:0;right:46px;top:54px}84%{width:55px;right:0;top:35px}to{width:47px;right:8px;top:38px}}@keyframes animateSuccessLong{0%{width:0;right:46px;top:54px}65%{width:0;right:46px;top:54px}84%{width:55px;right:0;top:35px}to{width:47px;right:8px;top:38px}}.swal-icon--info{border-color:#c9dae1}.swal-icon--info:before{width:5px;height:29px;bottom:17px;border-radius:2px;margin-left:-2px}.swal-icon--info:after,.swal-icon--info:before{content:"";position:absolute;left:50%;background-color:#c9dae1}.swal-icon--info:after{width:7px;height:7px;border-radius:50%;margin-left:-3px;top:19px}.swal-icon{width:80px;height:80px;border-width:4px;border-style:solid;border-radius:50%;padding:0;position:relative;box-sizing:content-box;margin:20px auto}.swal-icon:first-child{margin-top:32px}.swal-icon--custom{width:auto;height:auto;max-width:100%;border:none;border-radius:0}.swal-icon img{max-width:100%;max-height:100%}.swal-title{color:rgba(0,0,0,.65);font-weight:600;text-transform:none;position:relative;display:block;padding:13px 16px;font-size:27px;line-height:normal;text-align:center;margin-bottom:0}.swal-title:first-child{margin-top:26px}.swal-title:not(:first-child){padding-bottom:0}.swal-title:not(:last-child){margin-bottom:13px}.swal-text{font-size:16px;position:relative;float:none;line-height:normal;vertical-align:top;text-align:left;display:inline-block;margin:0;padding:0 10px;font-weight:400;color:rgba(0,0,0,.64);max-width:calc(100% - 20px);overflow-wrap:break-word;box-sizing:border-box}.swal-text:first-child{margin-top:45px}.swal-text:last-child{margin-bottom:45px}.swal-footer{text-align:right;padding-top:13px;margin-top:13px;padding:13px 16px;border-radius:inherit;border-top-left-radius:0;border-top-right-radius:0}.swal-button-container{margin:5px;display:inline-block;position:relative}.swal-button{background-color:#7cd1f9;color:#fff;border:none;box-shadow:none;border-radius:5px;font-weight:600;font-size:14px;padding:10px 24px;margin:0;cursor:pointer}.swal-button:not([disabled]):hover{background-color:#78cbf2}.swal-button:active{background-color:#70bce0}.swal-button:focus{outline:none;box-shadow:0 0 0 1px #fff,0 0 0 3px rgba(43,114,165,.29)}.swal-button[disabled]{opacity:.5;cursor:default}.swal-button::-moz-focus-inner{border:0}.swal-button--cancel{color:#555;background-color:#efefef}.swal-button--cancel:not([disabled]):hover{background-color:#e8e8e8}.swal-button--cancel:active{background-color:#d7d7d7}.swal-button--cancel:focus{box-shadow:0 0 0 1px #fff,0 0 0 3px rgba(116,136,150,.29)}.swal-button--danger{background-color:#e64942}.swal-button--danger:not([disabled]):hover{background-color:#df4740}.swal-button--danger:active{background-color:#cf423b}.swal-button--danger:focus{box-shadow:0 0 0 1px #fff,0 0 0 3px rgba(165,43,43,.29)}.swal-content{padding:0 20px;margin-top:20px;font-size:medium}.swal-content:last-child{margin-bottom:20px}.swal-content__input,.swal-content__textarea{-webkit-appearance:none;background-color:#fff;border:none;font-size:14px;display:block;box-sizing:border-box;width:100%;border:1px solid rgba(0,0,0,.14);padding:10px 13px;border-radius:2px;transition:border-color .2s}.swal-content__input:focus,.swal-content__textarea:focus{outline:none;border-color:#6db8ff}.swal-content__textarea{resize:vertical}.swal-button--loading{color:transparent}.swal-button--loading~.swal-button__loader{opacity:1}.swal-button__loader{position:absolute;height:auto;width:43px;z-index:2;left:50%;top:50%;-webkit-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);text-align:center;pointer-events:none;opacity:0}.swal-button__loader div{display:inline-block;float:none;vertical-align:baseline;width:9px;height:9px;padding:0;border:none;margin:2px;opacity:.4;border-radius:7px;background-color:hsla(0,0%,100%,.9);transition:background .2s;-webkit-animation:swal-loading-anim 1s infinite;animation:swal-loading-anim 1s infinite}.swal-button__loader div:nth-child(3n+2){-webkit-animation-delay:.15s;animation-delay:.15s}.swal-button__loader div:nth-child(3n+3){-webkit-animation-delay:.3s;animation-delay:.3s}@-webkit-keyframes swal-loading-anim{0%{opacity:.4}20%{opacity:.4}50%{opacity:1}to{opacity:.4}}@keyframes swal-loading-anim{0%{opacity:.4}20%{opacity:.4}50%{opacity:1}to{opacity:.4}}.swal-overlay{position:fixed;top:0;bottom:0;left:0;right:0;text-align:center;font-size:0;overflow-y:auto;background-color:rgba(0,0,0,.4);z-index:10000;pointer-events:none;opacity:0;transition:opacity .3s}.swal-overlay:before{content:" ";display:inline-block;vertical-align:middle;height:100%}.swal-overlay--show-modal{opacity:1;pointer-events:auto}.swal-overlay--show-modal .swal-modal{opacity:1;pointer-events:auto;box-sizing:border-box;-webkit-animation:showSweetAlert .3s;animation:showSweetAlert .3s;will-change:transform}.swal-modal{width:478px;opacity:0;pointer-events:none;background-color:#fff;text-align:center;border-radius:5px;position:static;margin:20px auto;display:inline-block;vertical-align:middle;-webkit-transform:scale(1);transform:scale(1);-webkit-transform-origin:50% 50%;transform-origin:50% 50%;z-index:10001;transition:opacity .2s,-webkit-transform .3s;transition:transform .3s,opacity .2s;transition:transform .3s,opacity .2s,-webkit-transform .3s}@media (max-width:500px){.swal-modal{width:calc(100% - 20px)}}@-webkit-keyframes showSweetAlert{0%{-webkit-transform:scale(1);transform:scale(1)}1%{-webkit-transform:scale(.5);transform:scale(.5)}45%{-webkit-transform:scale(1.05);transform:scale(1.05)}80%{-webkit-transform:scale(.95);transform:scale(.95)}to{-webkit-transform:scale(1);transform:scale(1)}}@keyframes showSweetAlert{0%{-webkit-transform:scale(1);transform:scale(1)}1%{-webkit-transform:scale(.5);transform:scale(.5)}45%{-webkit-transform:scale(1.05);transform:scale(1.05)}80%{-webkit-transform:scale(.95);transform:scale(.95)}to{-webkit-transform:scale(1);transform:scale(1)}}</style>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="renderer" content="webkit">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>编辑 【DG部署】【单机DB+单实例DG】 - Klaus Blog - Powered by Typecho</title>
        <meta name="robots" content="noindex, nofollow">
        <link rel="stylesheet" href="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/normalize.css">
<link rel="stylesheet" href="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/grid.css">
<link rel="stylesheet" href="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/style.css">
<!--[if lt IE 9]>
<script src="https://lo8ol.com/admin/js/html5shiv.js?v=17.10.30"></script>
<script src="https://lo8ol.com/admin/js/respond.js?v=17.10.30"></script>
<![endif]-->    <script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/zh_CN.js" async="" id="vditorI18nScriptzh_CN"></script><script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/lute.js" async="" id="vditorLuteScript"></script><link id="vditorContentTheme" rel="stylesheet" type="text/css" href="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/light.css"><link id="vditorHljsStyle" rel="stylesheet" type="text/css" href="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/monokai.css"><script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/highlight.js" async="" id="vditorHljsScript"></script><script type="text/javascript" id="vditorIconScript">document.body.insertAdjacentHTML('afterBegin', `<svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <symbol id="vditor-icon-comment" viewBox="0 0 32 32">
      <path d="M28.8 24.272l-1.872-1.872h-23.728v-19.2h25.6v21.072zM28.8 0h-25.6c-1.76 0-3.2 1.44-3.2 3.2v19.2c0 1.76 1.44 3.2 3.2 3.2h22.4l6.4 6.4v-28.8c0-1.76-1.44-3.2-3.2-3.2z"></path>
    </symbol>
    <symbol id="vditor-icon-headings" viewBox="0 0 32 32">
      <path d="M1.050 0.007h6.279v31.993h-6.279v-31.993z"></path>
      <path d="M24.671 0h6.279v31.993h-6.279v-31.993z"></path>
      <path d="M5.159 12.845h21.683v6.317h-21.683v-6.317z"></path>
    </symbol>
    <symbol id="vditor-icon-before" viewBox="0 0 32 32">
      <path d="M1.462 26.507h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M1.462 9.928h16.48v-3.276h-16.48v3.276z"></path>
      <path d="M1.462 18.217h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M24.366 8.29l6.171-5.952-2.43-2.338-8.619 8.29 8.619 8.29 2.43-2.337-6.171-5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-after" viewBox="0 0 32 32">
      <path d="M1.462 5.493h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M1.462 22.072h16.48v3.276h-16.48v-3.276z"></path>
      <path d="M1.462 13.783h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M24.366 23.71l6.171 5.952-2.43 2.338-8.619-8.29 8.619-8.29 2.43 2.337-6.171 5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-delete-column" viewBox="0 0 32 32">
      <path d="M5.279 0v23.265h3.538v-23.265h-3.538z"></path>
      <path d="M23.183 0v23.265h3.538v-23.265h-3.538z"></path>
      <path d="M14.231 0v17.797h3.538v-17.797h-3.538z"></path>
      <path d="M16 28.387l3.613 3.613 2.023-2.023-3.613-3.613 3.613-3.613-2.023-2.023-3.613 3.613-3.613-3.613-2.023 2.023 3.613 3.613-3.613 3.613 2.023 2.023 3.613-3.613z"></path>
    </symbol>
    <symbol id="vditor-icon-delete-row" viewBox="0 0 32 32">
      <path d="M0 5.279h23.265v3.538h-23.265v-3.538z"></path>
      <path d="M0 23.183h23.265v3.538h-23.265v-3.538z"></path>
      <path d="M0 14.231h17.797v3.538h-17.797v-3.538z"></path>
      <path d="M28.387 16l3.613 3.613-2.023 2.023-3.613-3.613-3.613 3.613-2.023-2.023 3.613-3.613-3.613-3.613 2.023-2.023 3.613 3.613 3.613-3.613 2.023 2.023-3.613 3.613z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-row" viewBox="0 0 32 32">
      <path d="M1.462 5.493h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M1.462 22.072h16.48v3.276h-16.48v-3.276z"></path>
      <path d="M1.462 13.783h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M24.366 23.71l6.171 5.952-2.43 2.338-8.619-8.29 8.619-8.29 2.43 2.337-6.171 5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-rowb" viewBox="0 0 32 32">
      <path d="M1.462 26.507h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M1.462 9.928h16.48v-3.276h-16.48v3.276z"></path>
      <path d="M1.462 18.217h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M24.366 8.29l6.171-5.952-2.43-2.338-8.619 8.29 8.619 8.29 2.43-2.337-6.171-5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-column" viewBox="0 0 32 32">
      <path d="M5.493 1.462v21.543h3.276v-21.543h-3.276z"></path>
      <path d="M22.072 1.462v16.48h3.276v-16.48h-3.276z"></path>
      <path d="M13.783 1.462v21.543h3.276v-21.543h-3.276z"></path>
      <path d="M23.71 24.366l5.952 6.171 2.338-2.43-8.29-8.619-8.29 8.619 2.337 2.43 5.953-6.171z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-columnb" viewBox="0 0 32 32">
      <path d="M26.507 1.462v21.543h-3.276v-21.543h3.276z"></path>
      <path d="M9.928 1.462v16.48h-3.276v-16.48h3.276z"></path>
      <path d="M18.217 1.462v21.543h-3.276v-21.543h3.276z"></path>
      <path d="M8.29 24.366l-5.952 6.171-2.338-2.43 8.29-8.619 8.29 8.619-2.337 2.43-5.953-6.171z"></path>
    </symbol>
    <symbol id="vditor-icon-code-theme" viewBox="0 0 32 32">
        <path d="M28.444 12.444v16h-24.924v-24.889h16v-3.556h-15.964c-1.956 0-3.556 1.6-3.556 3.556v24.889c0 1.956 1.6 3.556 3.556 3.556h24.889c1.956 0 3.556-1.6 3.556-3.556v-16h-3.556zM23.218 8.782l1.671 3.662 1.671-3.662 3.662-1.671-3.662-1.671-1.671-3.662-1.671 3.662-3.662 1.671zM16 8.889l-2.222 4.889-4.889 2.222 4.889 2.222 2.222 4.889 2.222-4.889 4.889-2.222-4.889-2.222z"></path>
    </symbol>
    <symbol id="vditor-icon-code" viewBox="0 0 32 32">
        <path d="M9.946 8.501l-2.204-1.832-7.742 9.331 7.742 9.331 2.204-1.832-6.225-7.499 6.225-7.499zM8.844 17.431h2.862v-2.862h-2.862v2.862zM23.156 14.569h-2.862v2.862h2.862v-2.862zM14.569 17.431h2.862v-2.862h-2.862v2.862zM24.258 6.669l-2.204 1.832 6.225 7.499-6.225 7.499 2.204 1.832 7.742-9.331-7.742-9.331z"></path>
    </symbol>
    <symbol id="vditor-icon-table" viewBox="0 0 32 32">
        <path d="M22.801 2.286h-22.801v27.429h32v-27.429h-9.199zM19.372 5.714v4.571h-6.801v-4.571h6.801zM19.372 13.714v4.571h-6.801v-4.571h6.801zM3.429 5.714h5.714v4.571h-5.714v-4.571zM3.429 13.714h5.714v4.571h-5.714v-4.571zM3.429 26.286v-4.571h5.714v4.571h-5.714zM12.571 26.286v-4.571h6.801v4.571h-6.801zM28.571 26.286h-5.77v-4.571h5.77v4.571zM28.571 18.286h-5.77v-4.571h5.77v4.571zM22.801 10.286v-4.571h5.77v4.571h-5.77z"></path>
    </symbol>
    <symbol id="vditor-icon-export" viewBox="0 0 32 32">
        <path d="M28.444 28.444h-24.889v-24.889h12.444v-3.556h-12.444c-1.973 0-3.556 1.6-3.556 3.556v24.889c0 1.956 1.582 3.556 3.556 3.556h24.889c1.956 0 3.556-1.6 3.556-3.556v-12.444h-3.556v12.444zM19.556 0v3.556h6.382l-17.476 17.476 2.507 2.507 17.476-17.476v6.382h3.556v-12.444h-12.444z"></path>
    </symbol>
    <symbol id="vditor-icon-resize" viewBox="0 0 128 32">
        <path d="M128 32v-5.334h-128v5.334h128zM128 18.666v-5.331h-128v5.331h128zM0 5.334h128v-5.334h-128v5.334z"></path>
    </symbol>
    <symbol id="vditor-icon-edit" viewBox="0 0 32 32">
        <path d="M19.66 10.703l1.635 1.635-16.104 16.104h-1.635v-1.635l16.104-16.104zM26.059 0.002c-0.444 0-0.907 0.178-1.244 0.515l-3.253 3.253 6.666 6.666 3.253-3.253c0.693-0.693 0.693-1.813 0-2.506l-4.159-4.159c-0.355-0.355-0.8-0.515-1.262-0.515zM19.66 5.673l-19.66 19.66v6.666h6.666l19.66-19.66-6.666-6.666z"></path>
    </symbol>
    <symbol id="vditor-icon-quote" viewBox="0 0 32 32">
        <path d="M27.769 26.667h-9.316l3.556-7.111h-4.231v-14.222h14.222v12.871l-4.231 8.462zM24.213 23.111h1.351l2.88-5.76v-8.462h-7.111v7.111h6.436l-3.556 7.111zM9.991 26.667h-9.316l3.556-7.111h-4.231v-14.222h14.222v12.871l-4.231 8.462zM6.436 23.111h1.351l2.88-5.76v-8.462h-7.111v7.111h6.436l-3.556 7.111z"></path>
    </symbol>
    <symbol id="vditor-icon-strike" viewBox="0 0 32 32">
        <path d="M12.444 29.333h7.111v-5.333h-7.111v5.333zM3.556 2.667v5.333h8.889v5.333h7.111v-5.333h8.889v-5.333h-24.889zM0 20.444h32v-3.556h-32v3.556z"></path>
    </symbol>
    <symbol id="vditor-icon-line" viewBox="0 0 32 32">
        <path d="M0 14h32v4h-32v-4z"></path>
    </symbol>
    <symbol id="vditor-icon-both" viewBox="0 0 32 32">
        <path d="M2.909 3.636h26.182c1.6 0 2.909 1.309 2.909 2.909v18.909c0 1.6-1.309 2.909-2.909 2.909h-26.182c-1.6 0-2.909-1.309-2.909-2.909v-18.909c0-1.6 1.309-2.909 2.909-2.909zM29.091 25.455v-18.909h-11.636v18.909h11.636zM2.909 25.455h11.636v-18.909h-11.636v18.909zM13.091 11.636h-8.727v2.182h8.727zM13.091 15.273h-8.727v2.182h8.727zM13.091 18.909h-8.727v2.182h8.727z"></path>
    </symbol>
    <symbol id="vditor-icon-copy" viewBox="0 0 32 32">
      <path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path>
    </symbol>
    <symbol id="vditor-icon-trashcan" viewBox="0 0 32 32">
      <path d="M23.111 10.667v17.778h-14.222v-17.778h14.222zM20.444 0h-8.889l-1.778 1.778h-6.222v3.556h24.889v-3.556h-6.222l-1.778-1.778zM26.667 7.111h-21.333v21.333c0 1.956 1.6 3.556 3.556 3.556h14.222c1.956 0 3.556-1.6 3.556-3.556v-21.333z"></path>
    </symbol>
    <symbol id="vditor-icon-more" viewBox="0 0 32 32">
      <path d="M4 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zM28 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zM16 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4z"></path>
    </symbol>
    <symbol id="vditor-icon-upload" viewBox="0 0 32 32">
      <path d="M25.8 13.387c-0.907-4.6-4.947-8.053-9.8-8.053-3.853 0-7.2 2.187-8.867 5.387-4.013 0.427-7.133 3.827-7.133 7.947 0 4.413 3.587 8 8 8h17.333c3.68 0 6.667-2.987 6.667-6.667 0-3.52-2.733-6.373-6.2-6.613zM25.333 24h-17.333c-2.947 0-5.333-2.387-5.333-5.333 0-2.733 2.040-5.013 4.747-5.293l1.427-0.147 0.667-1.267c1.267-2.44 3.747-3.96 6.493-3.96 3.493 0 6.507 2.48 7.187 5.907l0.4 2 2.040 0.147c2.080 0.133 3.707 1.88 3.707 3.947 0 2.2-1.8 4-4 4zM10.667 17.333h3.4v4h3.867v-4h3.4l-5.333-5.333z"></path>
    </symbol>
    <symbol id="vditor-icon-bug" viewBox="0 0 32 32">
      <path d="M30.222 8.889h-4.996c-0.8-1.387-1.902-2.578-3.236-3.484l2.898-2.898-2.507-2.507-3.858 3.858c-0.818-0.196-1.653-0.302-2.524-0.302s-1.707 0.107-2.507 0.302l-3.876-3.858-2.507 2.507 2.88 2.898c-1.316 0.907-2.418 2.098-3.218 3.484h-4.996v3.556h3.716c-0.089 0.587-0.16 1.173-0.16 1.778v1.778h-3.556v3.556h3.556v1.778c0 0.604 0.071 1.191 0.16 1.778h-3.716v3.556h4.996c1.849 3.182 5.28 5.333 9.227 5.333s7.378-2.151 9.227-5.333h4.996v-3.556h-3.716c0.089-0.587 0.16-1.173 0.16-1.778v-1.778h3.556v-3.556h-3.556v-1.778c0-0.604-0.071-1.191-0.16-1.778h3.716v-3.556zM23.111 16v5.333c0 0.391-0.053 0.836-0.124 1.244l-0.178 1.156-0.658 1.156c-1.28 2.204-3.627 3.556-6.151 3.556s-4.871-1.369-6.151-3.556l-0.658-1.138-0.178-1.156c-0.071-0.409-0.124-0.853-0.124-1.262v-7.111c0-0.409 0.053-0.853 0.124-1.244l0.178-1.156 0.658-1.156c0.533-0.924 1.28-1.724 2.151-2.329l1.013-0.693 1.316-0.32c0.551-0.142 1.12-0.213 1.671-0.213 0.569 0 1.12 0.071 1.689 0.213l1.209 0.284 1.084 0.747c0.889 0.604 1.618 1.387 2.151 2.329l0.676 1.156 0.178 1.156c0.071 0.391 0.124 0.836 0.124 1.227v1.778zM12.444 19.556h7.111v3.556h-7.111zM12.444 12.445h7.111v3.556h-7.111z"></path>
    </symbol>
    <symbol id="vditor-icon-contract" viewBox="0 0 32 32">
      <path d="M32 2.256l-8.464 8.464 5.264 5.28h-12.8v-12.8l5.264 5.264 8.48-8.464 2.256 2.256zM2.256 32l8.464-8.464 5.28 5.264v-12.8h-12.8l5.264 5.264-8.464 8.48 2.256 2.256z"></path>
    </symbol>
    <symbol id="vditor-icon-inline-code" viewBox="0 0 32 32">
      <path d="M11.84 23.36l-7.36-7.36 7.36-7.36-2.24-2.24-9.6 9.6 9.6 9.6 2.24-2.24zM20.16 23.36l7.36-7.36-7.36-7.36 2.24-2.24 9.6 9.6-9.6 9.6-2.24-2.24z"></path>
    </symbol>
    <symbol id="vditor-icon-down" viewBox="0 0 32 32">
      <path d="M3.76 6.12l12.24 12.213 12.24-12.213 3.76 3.76-16 16-16-16 3.76-3.76z"></path>
    </symbol>
    <symbol id="vditor-icon-up" viewBox="0 0 32 32">
      <path d="M3.76 25.88l12.24-12.213 12.24 12.213 3.76-3.76-16-16-16 16 3.76 3.76z"></path>
    </symbol>
    <symbol id="vditor-icon-check" viewBox="0 0 32 32">
      <path d="M28.444 0h-24.889c-1.956 0-3.556 1.6-3.556 3.556v24.889c0 1.956 1.6 3.556 3.556 3.556h24.889c1.956 0 3.556-1.6 3.556-3.556v-24.889c0-1.956-1.6-3.556-3.556-3.556zM28.444 28.445h-24.889v-24.889h24.889v24.889zM26.649 10.667l-2.507-2.524-11.716 11.716-4.587-4.569-2.524 2.507 7.111 7.093z"></path>
    </symbol>
    <symbol id="vditor-icon-theme" viewBox="0 0 32 32">
      <path d="M16 32c-8.816 0-16-7.184-16-16s7.184-16 16-16 16 6.464 16 14.4c0 5.296-4.304 9.6-9.6 9.6h-2.832c-0.448 0-0.8 0.352-0.8 0.8 0 0.192 0.080 0.368 0.208 0.528 0.656 0.752 1.024 1.696 1.024 2.672 0 2.208-1.792 4-4 4zM16 3.2c-7.056 0-12.8 5.744-12.8 12.8s5.744 12.8 12.8 12.8c0.448 0 0.8-0.352 0.8-0.8 0-0.256-0.128-0.448-0.224-0.56-0.656-0.736-1.008-1.68-1.008-2.64 0-2.208 1.792-4 4-4h2.832c3.536 0 6.4-2.864 6.4-6.4 0-6.176-5.744-11.2-12.8-11.2z"></path>
      <path d="M9.6 15.2c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
      <path d="M14.4 8.8c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
      <path d="M22.4 8.8c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
      <path d="M27.2 15.2c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
    </symbol>
    <symbol id="vditor-icon-help" viewBox="0 0 32 32">
      <path d="M14.4 25.6h3.2v-3.2h-3.2v3.2zM16 0c-8.832 0-16 7.168-16 16s7.168 16 16 16 16-7.168 16-16-7.168-16-16-16zM16 28.8c-7.056 0-12.8-5.744-12.8-12.8s5.744-12.8 12.8-12.8 12.8 5.744 12.8 12.8-5.744 12.8-12.8 12.8zM16 6.4c-3.536 0-6.4 2.864-6.4 6.4h3.2c0-1.76 1.44-3.2 3.2-3.2s3.2 1.44 3.2 3.2c0 3.2-4.8 2.8-4.8 8h3.2c0-3.6 4.8-4 4.8-8 0-3.536-2.864-6.4-6.4-6.4z"></path>
    </symbol>
    <symbol id="vditor-icon-info" viewBox="0 0 32 32">
      <path d="M14.4 8h3.2v3.2h-3.2zM14.4 14.4h3.2v9.6h-3.2zM16 0c-8.832 0-16 7.168-16 16s7.168 16 16 16 16-7.168 16-16-7.168-16-16-16zM16 28.8c-7.056 0-12.8-5.744-12.8-12.8s5.744-12.8 12.8-12.8 12.8 5.744 12.8 12.8-5.744 12.8-12.8 12.8z"></path>
    </symbol>
    <symbol id="vditor-icon-fullscreen" viewBox="0 0 32 32">
      <path d="M32 14.222v-14.222h-14.222l5.849 5.849-17.778 17.778-5.849-5.849v14.222h14.222l-5.849-5.849 17.778-17.778z"></path>
    </symbol>
    <symbol id="vditor-icon-preview" viewBox="0 0 32 32">
      <path d="M16 8c5.513 0 10.429 3.098 12.829 8-2.4 4.902-7.302 8-12.829 8s-10.429-3.098-12.829-8c2.4-4.902 7.316-8 12.829-8zM16 5.091c-7.273 0-13.484 4.524-16 10.909 2.516 6.385 8.727 10.909 16 10.909s13.484-4.524 16-10.909c-2.516-6.385-8.727-10.909-16-10.909zM16 12.364c2.007 0 3.636 1.629 3.636 3.636s-1.629 3.636-3.636 3.636-3.636-1.629-3.636-3.636 1.629-3.636 3.636-3.636zM16 9.455c-3.607 0-6.545 2.938-6.545 6.545s2.938 6.545 6.545 6.545 6.545-2.938 6.545-6.545-2.938-6.545-6.545-6.545z"></path>
    </symbol>
    <symbol id="vditor-icon-record" viewBox="0 0 32 32">
      <path d="M24.928 15.17h2.844q0 4.267-2.963 7.467t-7.151 3.832v5.531h-3.319v-5.531q-4.188-0.632-7.151-3.832t-2.963-7.467h2.844q0 3.714 2.647 6.123t6.281 2.41 6.281-2.41 2.647-6.123zM13.946 4.899v10.43q0 0.79 0.593 1.383t1.462 0.593q0.79 0 1.383-0.553t0.593-1.422l0.079-10.43q0-0.869-0.632-1.462t-1.422-0.593-1.422 0.593-0.632 1.462zM16 20.227q-2.054 0-3.556-1.501t-1.501-3.556v-10.114q0-2.054 1.501-3.556t3.556-1.501 3.556 1.501 1.501 3.556v10.114q0 2.054-1.501 3.556t-3.556 1.501z"></path>
    </symbol>
    <symbol id="vditor-icon-pause" viewBox="0 0 32 32">
      <path d="M20.617 0h9.128v32h-9.128v-32zM2.255 32v-32h9.128v32h-9.128z"></path>
    </symbol>
    <symbol id="vditor-icon-play" viewBox="0 0 32 32">
      <path d="M3.436 0l25.128 16-25.128 16v-32z"></path>
    </symbol>
    <symbol id="vditor-icon-emoji" viewBox="0 0 32 32">
      <path d="M16 24.789q-2.779 0-4.995-1.54t-3.192-4.019h2.629q1.878 3.155 5.559 3.155t5.559-3.155h2.629q-0.977 2.479-3.192 4.019t-4.995 1.54zM16 28.845q5.258 0 9.052-3.793t3.793-9.052-3.793-9.052-9.052-3.793-9.052 3.793-3.793 9.052 3.793 9.052 9.052 3.793zM16 0q6.61 0 11.305 4.695t4.695 11.305-4.695 11.305-11.305 4.695-11.305-4.695-4.695-11.305 4.695-11.305 11.305-4.695zM10.366 14.423q-0.977 0-1.69-0.714t-0.714-1.69 0.714-1.69 1.69-0.714 1.69 0.714 0.714 1.69-0.714 1.69-1.69 0.714zM21.634 14.423q-0.977 0-1.69-0.714t-0.714-1.69 0.714-1.69 1.69-0.714 1.69 0.714 0.714 1.69-0.714 1.69-1.69 0.714z"></path>
    </symbol>
    <symbol id="vditor-icon-link" viewBox="0 0 32 32">
      <path d="M24.038 7.962q3.305 0 5.634 2.366t2.329 5.671-2.329 5.671-5.634 2.366h-6.46v-3.080h6.46q2.028 0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.080h6.46zM9.615 17.577v-3.155h12.77v3.155h-12.77zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.080h-6.46q-3.305 0-5.634-2.366t-2.329-5.671 2.329-5.671 5.634-2.366h6.46v3.080h-6.46q-2.028 0-3.493 1.465t-1.465 3.493z"></path>
    </symbol>
    <symbol id="vditor-icon-redo" viewBox="0 0 32 32">
      <path d="M26.422 14.605l5.578-5.651v14.092h-14.092l5.725-5.651q-3.523-2.936-8.073-2.936-3.743 0-7.229 2.495t-4.661 6.092l-3.67-1.174q1.615-4.991 5.908-8.147t9.651-3.156q6.239 0 10.862 4.037z"></path>
    </symbol>
    <symbol id="vditor-icon-undo" viewBox="0 0 32 32">
      <path d="M16.44 10.569q5.358 0 9.615 3.156t5.945 8.147l-3.67 1.174q-1.248-3.817-4.514-6.202t-7.376-2.385q-4.55 0-8.073 2.936l5.725 5.651h-14.092v-14.092l5.578 5.651q4.624-4.037 10.862-4.037z"></path>
    </symbol>
    <symbol id="vditor-icon-align-center" viewBox="0 0 32 32">
      <path d="M0 0h32v3.583h-32v-3.583zM7.083 7.083h17.833v3.583h-17.833v-3.583zM0 17.75v-3.5h32v3.5h-32zM0 32v-3.583h32v3.583h-32zM7.083 21.333h17.833v3.583h-17.833v-3.583z"></path>
    </symbol>
    <symbol id="vditor-icon-align-left" viewBox="0 0 32 32">
      <path d="M0 0h32v3.583h-32v-3.583zM0 32v-3.583h32v3.583h-32zM0 17.75v-3.5h32v3.5h-32zM21.333 7.083v3.583h-21.333v-3.583h21.333zM21.333 21.333v3.583h-21.333v-3.583h21.333z"></path>
    </symbol>
    <symbol id="vditor-icon-align-right" viewBox="0 0 32 32">
      <path d="M0 0h32v3.583h-32v-3.583zM10.667 10.667v-3.583h21.333v3.583h-21.333zM0 17.75v-3.5h32v3.5h-32zM10.667 24.917v-3.583h21.333v3.583h-21.333zM0 32v-3.583h32v3.583h-32z"></path>
    </symbol>
    <symbol id="vditor-icon-bold" viewBox="0 0 32 32">
      <path d="M18.569 26.328q1.498 0 2.462-1.017t0.963-2.408-0.963-2.408-2.462-1.017h-8.027v6.849h8.027zM10.542 5.779v6.85h6.85q1.391 0 2.408-1.017t1.017-2.408-1.017-2.408-2.408-1.017h-6.849zM23.385 15.518q4.923 2.248 4.923 7.813 0 3.639-2.408 6.154t-6.047 2.515h-16.161v-32h14.341q3.853 0 6.475 2.676t2.622 6.528-3.746 6.314z"></path>
    </symbol>
    <symbol id="vditor-icon-indent" viewBox="0 0 32 32">
      <path d="M14.25 17.75v-3.5h17.75v3.5h-17.75zM14.25 10.667v-3.583h17.75v3.583h-17.75zM0 0h32v3.583h-32v-3.583zM0 32v-3.583h32v3.583h-32zM0 16l7.083-7.083v14.167zM14.25 24.917v-3.583h17.75v3.583h-17.75z"></path>
    </symbol>
    <symbol id="vditor-icon-outdent" viewBox="0 0 32 32">
      <path d="M14.25 17.75v-3.5h17.75v3.5h-17.75zM14.25 10.667v-3.583h17.75v3.583h-17.75zM0 0h32v3.583h-32v-3.583zM14.25 24.917v-3.583h17.75v3.583h-17.75zM0 8.917l7.083 7.083-7.083 7.083v-14.167zM0 32v-3.583h32v3.583h-32z"></path>
    </symbol>
    <symbol id="vditor-icon-italic" viewBox="0 0 32 32">
      <path d="M11.398 0h18.301v6.849h-6.421l-7.706 18.301h5.030v6.849h-18.301v-6.849h6.421l7.706-18.301h-5.030v-6.849z"></path>
    </symbol>
    <symbol id="vditor-icon-list" viewBox="0 0 32 32">
      <path d="M7.777 3.929h24.223v3.403h-24.223v-3.403zM7.777 17.701v-3.403h24.223v3.403h-24.223zM7.777 28.071v-3.403h24.223v3.403h-24.223zM2.592 23.777q1.053 0 1.823 0.77t0.77 1.823-0.77 1.823-1.823 0.77-1.823-0.77-0.77-1.823 0.77-1.823 1.823-0.77zM2.592 3.038q1.053 0 1.823 0.729t0.77 1.863-0.77 1.863-1.823 0.729-1.823-0.729-0.77-1.863 0.77-1.863 1.823-0.729zM2.592 13.408q1.053 0 1.823 0.729t0.77 1.863-0.77 1.863-1.823 0.729-1.823-0.729-0.77-1.863 0.77-1.863 1.823-0.729z"></path>
    </symbol>
    <symbol id="vditor-icon-ordered-list" viewBox="0 0 32 32">
      <path d="M8.375 17.659v-3.319h23.625v3.319h-23.625zM8.375 27.773v-3.319h23.625v3.319h-23.625zM8.375 4.227h23.625v3.319h-23.625v-3.319zM0 14.341v-1.738h5.057v1.58l-3.081 3.477h3.081v1.738h-5.057v-1.58l3.002-3.477h-3.002zM1.659 9.284v-5.057h-1.659v-1.738h3.319v6.795h-1.659zM0 24.454v-1.738h5.057v6.795h-5.057v-1.738h3.319v-0.79h-1.659v-1.738h1.659v-0.79h-3.319z"></path>
    </symbol>
    <symbol id="vditor-icon-mp-wechat" viewBox="0 0 32 32">
      <path d="M6.927 17.719s-3.040-3.431-2.915-6.942c0.16-4.453 4.738-10.257 11.359-10.257 1.884 0 5.653 0 10.328 5.52 0.249 0.302-15.075-3.84-18.772 11.679z"></path>
      <path d="M17.477 9.301s3.946-1.298 7.271-0.178c4.222 1.422 8.693 6.826 6.809 13.182-0.533 1.804-1.609 5.413-8.231 8.32-0.356 0.16 10.613-13.351-5.849-21.323z"></path>
      <path d="M10.944 24.332c-1.938 2.035-3.751 1.742-3.751 1.742l0.578-3.191c-5.235-3.44-6.373-10.328-6.453-10.106-2.444 6.817-0.916 11.377 0.027 13.004 3.315 5.733 11.982 7.351 17.484 3.893 2.969-1.867 4.533-7.057 4.533-7.057-5.298 2.338-9.342 2.569-12.417 1.715z"></path>
    </symbol>
    <symbol id="vditor-icon-zhihu" viewBox="0 0 32 32">
      <path d="M17.167 17.769s0-2.583-1.25-2.667c-1.25-0.167-5.167 0-5.167 0v-8h5.833s-0.083-2.667-1.167-2.667h-9.5l1.583-4.25s-2.333 0.167-3.25 1.667c-0.833 1.5-3.5 9.167-3.5 9.167s0.917 0.417 2.417-0.75c1.5-1.083 2-3.083 2-3.083l2.75-0.167 0.083 8.083s-4.917-0.083-5.833 0c-1 0.083-1.5 2.667-1.5 2.667h7.417s-0.667 4.583-2.5 7.75c-1.917 3.333-5.583 5.917-5.583 5.917s2.583 1.083 5.167-0.417 4.417-8.083 4.417-8.083l5.917 7.417s0.5-3.5-0.083-4.583c-0.667-1-4.167-5-4.167-5l-1.5 1.333 1.083-4.417 6.333 0.083zM18.667 4.269l-0.083 23.999h2.417l0.833 2.917 4.25-2.917h5.917v-23.999h-13.333zM29.333 25.602h-2.75l-3.5 2.667-0.75-2.667h-0.75v-18.582h7.75v18.582z"></path>
    </symbol>
  </defs>
</svg>`)
</script></head>
    <body><svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <symbol id="vditor-icon-comment" viewBox="0 0 32 32">
      <path d="M28.8 24.272l-1.872-1.872h-23.728v-19.2h25.6v21.072zM28.8 0h-25.6c-1.76 0-3.2 1.44-3.2 3.2v19.2c0 1.76 1.44 3.2 3.2 3.2h22.4l6.4 6.4v-28.8c0-1.76-1.44-3.2-3.2-3.2z"></path>
    </symbol>
    <symbol id="vditor-icon-headings" viewBox="0 0 32 32">
      <path d="M1.050 0.007h6.279v31.993h-6.279v-31.993z"></path>
      <path d="M24.671 0h6.279v31.993h-6.279v-31.993z"></path>
      <path d="M5.159 12.845h21.683v6.317h-21.683v-6.317z"></path>
    </symbol>
    <symbol id="vditor-icon-before" viewBox="0 0 32 32">
      <path d="M1.462 26.507h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M1.462 9.928h16.48v-3.276h-16.48v3.276z"></path>
      <path d="M1.462 18.217h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M24.366 8.29l6.171-5.952-2.43-2.338-8.619 8.29 8.619 8.29 2.43-2.337-6.171-5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-after" viewBox="0 0 32 32">
      <path d="M1.462 5.493h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M1.462 22.072h16.48v3.276h-16.48v-3.276z"></path>
      <path d="M1.462 13.783h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M24.366 23.71l6.171 5.952-2.43 2.338-8.619-8.29 8.619-8.29 2.43 2.337-6.171 5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-delete-column" viewBox="0 0 32 32">
      <path d="M5.279 0v23.265h3.538v-23.265h-3.538z"></path>
      <path d="M23.183 0v23.265h3.538v-23.265h-3.538z"></path>
      <path d="M14.231 0v17.797h3.538v-17.797h-3.538z"></path>
      <path d="M16 28.387l3.613 3.613 2.023-2.023-3.613-3.613 3.613-3.613-2.023-2.023-3.613 3.613-3.613-3.613-2.023 2.023 3.613 3.613-3.613 3.613 2.023 2.023 3.613-3.613z"></path>
    </symbol>
    <symbol id="vditor-icon-delete-row" viewBox="0 0 32 32">
      <path d="M0 5.279h23.265v3.538h-23.265v-3.538z"></path>
      <path d="M0 23.183h23.265v3.538h-23.265v-3.538z"></path>
      <path d="M0 14.231h17.797v3.538h-17.797v-3.538z"></path>
      <path d="M28.387 16l3.613 3.613-2.023 2.023-3.613-3.613-3.613 3.613-2.023-2.023 3.613-3.613-3.613-3.613 2.023-2.023 3.613 3.613 3.613-3.613 2.023 2.023-3.613 3.613z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-row" viewBox="0 0 32 32">
      <path d="M1.462 5.493h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M1.462 22.072h16.48v3.276h-16.48v-3.276z"></path>
      <path d="M1.462 13.783h21.543v3.276h-21.543v-3.276z"></path>
      <path d="M24.366 23.71l6.171 5.952-2.43 2.338-8.619-8.29 8.619-8.29 2.43 2.337-6.171 5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-rowb" viewBox="0 0 32 32">
      <path d="M1.462 26.507h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M1.462 9.928h16.48v-3.276h-16.48v3.276z"></path>
      <path d="M1.462 18.217h21.543v-3.276h-21.543v3.276z"></path>
      <path d="M24.366 8.29l6.171-5.952-2.43-2.338-8.619 8.29 8.619 8.29 2.43-2.337-6.171-5.953z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-column" viewBox="0 0 32 32">
      <path d="M5.493 1.462v21.543h3.276v-21.543h-3.276z"></path>
      <path d="M22.072 1.462v16.48h3.276v-16.48h-3.276z"></path>
      <path d="M13.783 1.462v21.543h3.276v-21.543h-3.276z"></path>
      <path d="M23.71 24.366l5.952 6.171 2.338-2.43-8.29-8.619-8.29 8.619 2.337 2.43 5.953-6.171z"></path>
    </symbol>
    <symbol id="vditor-icon-insert-columnb" viewBox="0 0 32 32">
      <path d="M26.507 1.462v21.543h-3.276v-21.543h3.276z"></path>
      <path d="M9.928 1.462v16.48h-3.276v-16.48h3.276z"></path>
      <path d="M18.217 1.462v21.543h-3.276v-21.543h3.276z"></path>
      <path d="M8.29 24.366l-5.952 6.171-2.338-2.43 8.29-8.619 8.29 8.619-2.337 2.43-5.953-6.171z"></path>
    </symbol>
    <symbol id="vditor-icon-code-theme" viewBox="0 0 32 32">
        <path d="M28.444 12.444v16h-24.924v-24.889h16v-3.556h-15.964c-1.956 0-3.556 1.6-3.556 3.556v24.889c0 1.956 1.6 3.556 3.556 3.556h24.889c1.956 0 3.556-1.6 3.556-3.556v-16h-3.556zM23.218 8.782l1.671 3.662 1.671-3.662 3.662-1.671-3.662-1.671-1.671-3.662-1.671 3.662-3.662 1.671zM16 8.889l-2.222 4.889-4.889 2.222 4.889 2.222 2.222 4.889 2.222-4.889 4.889-2.222-4.889-2.222z"></path>
    </symbol>
    <symbol id="vditor-icon-code" viewBox="0 0 32 32">
        <path d="M9.946 8.501l-2.204-1.832-7.742 9.331 7.742 9.331 2.204-1.832-6.225-7.499 6.225-7.499zM8.844 17.431h2.862v-2.862h-2.862v2.862zM23.156 14.569h-2.862v2.862h2.862v-2.862zM14.569 17.431h2.862v-2.862h-2.862v2.862zM24.258 6.669l-2.204 1.832 6.225 7.499-6.225 7.499 2.204 1.832 7.742-9.331-7.742-9.331z"></path>
    </symbol>
    <symbol id="vditor-icon-table" viewBox="0 0 32 32">
        <path d="M22.801 2.286h-22.801v27.429h32v-27.429h-9.199zM19.372 5.714v4.571h-6.801v-4.571h6.801zM19.372 13.714v4.571h-6.801v-4.571h6.801zM3.429 5.714h5.714v4.571h-5.714v-4.571zM3.429 13.714h5.714v4.571h-5.714v-4.571zM3.429 26.286v-4.571h5.714v4.571h-5.714zM12.571 26.286v-4.571h6.801v4.571h-6.801zM28.571 26.286h-5.77v-4.571h5.77v4.571zM28.571 18.286h-5.77v-4.571h5.77v4.571zM22.801 10.286v-4.571h5.77v4.571h-5.77z"></path>
    </symbol>
    <symbol id="vditor-icon-export" viewBox="0 0 32 32">
        <path d="M28.444 28.444h-24.889v-24.889h12.444v-3.556h-12.444c-1.973 0-3.556 1.6-3.556 3.556v24.889c0 1.956 1.582 3.556 3.556 3.556h24.889c1.956 0 3.556-1.6 3.556-3.556v-12.444h-3.556v12.444zM19.556 0v3.556h6.382l-17.476 17.476 2.507 2.507 17.476-17.476v6.382h3.556v-12.444h-12.444z"></path>
    </symbol>
    <symbol id="vditor-icon-resize" viewBox="0 0 128 32">
        <path d="M128 32v-5.334h-128v5.334h128zM128 18.666v-5.331h-128v5.331h128zM0 5.334h128v-5.334h-128v5.334z"></path>
    </symbol>
    <symbol id="vditor-icon-edit" viewBox="0 0 32 32">
        <path d="M19.66 10.703l1.635 1.635-16.104 16.104h-1.635v-1.635l16.104-16.104zM26.059 0.002c-0.444 0-0.907 0.178-1.244 0.515l-3.253 3.253 6.666 6.666 3.253-3.253c0.693-0.693 0.693-1.813 0-2.506l-4.159-4.159c-0.355-0.355-0.8-0.515-1.262-0.515zM19.66 5.673l-19.66 19.66v6.666h6.666l19.66-19.66-6.666-6.666z"></path>
    </symbol>
    <symbol id="vditor-icon-quote" viewBox="0 0 32 32">
        <path d="M27.769 26.667h-9.316l3.556-7.111h-4.231v-14.222h14.222v12.871l-4.231 8.462zM24.213 23.111h1.351l2.88-5.76v-8.462h-7.111v7.111h6.436l-3.556 7.111zM9.991 26.667h-9.316l3.556-7.111h-4.231v-14.222h14.222v12.871l-4.231 8.462zM6.436 23.111h1.351l2.88-5.76v-8.462h-7.111v7.111h6.436l-3.556 7.111z"></path>
    </symbol>
    <symbol id="vditor-icon-strike" viewBox="0 0 32 32">
        <path d="M12.444 29.333h7.111v-5.333h-7.111v5.333zM3.556 2.667v5.333h8.889v5.333h7.111v-5.333h8.889v-5.333h-24.889zM0 20.444h32v-3.556h-32v3.556z"></path>
    </symbol>
    <symbol id="vditor-icon-line" viewBox="0 0 32 32">
        <path d="M0 14h32v4h-32v-4z"></path>
    </symbol>
    <symbol id="vditor-icon-both" viewBox="0 0 32 32">
        <path d="M2.909 3.636h26.182c1.6 0 2.909 1.309 2.909 2.909v18.909c0 1.6-1.309 2.909-2.909 2.909h-26.182c-1.6 0-2.909-1.309-2.909-2.909v-18.909c0-1.6 1.309-2.909 2.909-2.909zM29.091 25.455v-18.909h-11.636v18.909h11.636zM2.909 25.455h11.636v-18.909h-11.636v18.909zM13.091 11.636h-8.727v2.182h8.727zM13.091 15.273h-8.727v2.182h8.727zM13.091 18.909h-8.727v2.182h8.727z"></path>
    </symbol>
    <symbol id="vditor-icon-copy" viewBox="0 0 32 32">
      <path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path>
    </symbol>
    <symbol id="vditor-icon-trashcan" viewBox="0 0 32 32">
      <path d="M23.111 10.667v17.778h-14.222v-17.778h14.222zM20.444 0h-8.889l-1.778 1.778h-6.222v3.556h24.889v-3.556h-6.222l-1.778-1.778zM26.667 7.111h-21.333v21.333c0 1.956 1.6 3.556 3.556 3.556h14.222c1.956 0 3.556-1.6 3.556-3.556v-21.333z"></path>
    </symbol>
    <symbol id="vditor-icon-more" viewBox="0 0 32 32">
      <path d="M4 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zM28 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zM16 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4z"></path>
    </symbol>
    <symbol id="vditor-icon-upload" viewBox="0 0 32 32">
      <path d="M25.8 13.387c-0.907-4.6-4.947-8.053-9.8-8.053-3.853 0-7.2 2.187-8.867 5.387-4.013 0.427-7.133 3.827-7.133 7.947 0 4.413 3.587 8 8 8h17.333c3.68 0 6.667-2.987 6.667-6.667 0-3.52-2.733-6.373-6.2-6.613zM25.333 24h-17.333c-2.947 0-5.333-2.387-5.333-5.333 0-2.733 2.040-5.013 4.747-5.293l1.427-0.147 0.667-1.267c1.267-2.44 3.747-3.96 6.493-3.96 3.493 0 6.507 2.48 7.187 5.907l0.4 2 2.040 0.147c2.080 0.133 3.707 1.88 3.707 3.947 0 2.2-1.8 4-4 4zM10.667 17.333h3.4v4h3.867v-4h3.4l-5.333-5.333z"></path>
    </symbol>
    <symbol id="vditor-icon-bug" viewBox="0 0 32 32">
      <path d="M30.222 8.889h-4.996c-0.8-1.387-1.902-2.578-3.236-3.484l2.898-2.898-2.507-2.507-3.858 3.858c-0.818-0.196-1.653-0.302-2.524-0.302s-1.707 0.107-2.507 0.302l-3.876-3.858-2.507 2.507 2.88 2.898c-1.316 0.907-2.418 2.098-3.218 3.484h-4.996v3.556h3.716c-0.089 0.587-0.16 1.173-0.16 1.778v1.778h-3.556v3.556h3.556v1.778c0 0.604 0.071 1.191 0.16 1.778h-3.716v3.556h4.996c1.849 3.182 5.28 5.333 9.227 5.333s7.378-2.151 9.227-5.333h4.996v-3.556h-3.716c0.089-0.587 0.16-1.173 0.16-1.778v-1.778h3.556v-3.556h-3.556v-1.778c0-0.604-0.071-1.191-0.16-1.778h3.716v-3.556zM23.111 16v5.333c0 0.391-0.053 0.836-0.124 1.244l-0.178 1.156-0.658 1.156c-1.28 2.204-3.627 3.556-6.151 3.556s-4.871-1.369-6.151-3.556l-0.658-1.138-0.178-1.156c-0.071-0.409-0.124-0.853-0.124-1.262v-7.111c0-0.409 0.053-0.853 0.124-1.244l0.178-1.156 0.658-1.156c0.533-0.924 1.28-1.724 2.151-2.329l1.013-0.693 1.316-0.32c0.551-0.142 1.12-0.213 1.671-0.213 0.569 0 1.12 0.071 1.689 0.213l1.209 0.284 1.084 0.747c0.889 0.604 1.618 1.387 2.151 2.329l0.676 1.156 0.178 1.156c0.071 0.391 0.124 0.836 0.124 1.227v1.778zM12.444 19.556h7.111v3.556h-7.111zM12.444 12.445h7.111v3.556h-7.111z"></path>
    </symbol>
    <symbol id="vditor-icon-contract" viewBox="0 0 32 32">
      <path d="M32 2.256l-8.464 8.464 5.264 5.28h-12.8v-12.8l5.264 5.264 8.48-8.464 2.256 2.256zM2.256 32l8.464-8.464 5.28 5.264v-12.8h-12.8l5.264 5.264-8.464 8.48 2.256 2.256z"></path>
    </symbol>
    <symbol id="vditor-icon-inline-code" viewBox="0 0 32 32">
      <path d="M11.84 23.36l-7.36-7.36 7.36-7.36-2.24-2.24-9.6 9.6 9.6 9.6 2.24-2.24zM20.16 23.36l7.36-7.36-7.36-7.36 2.24-2.24 9.6 9.6-9.6 9.6-2.24-2.24z"></path>
    </symbol>
    <symbol id="vditor-icon-down" viewBox="0 0 32 32">
      <path d="M3.76 6.12l12.24 12.213 12.24-12.213 3.76 3.76-16 16-16-16 3.76-3.76z"></path>
    </symbol>
    <symbol id="vditor-icon-up" viewBox="0 0 32 32">
      <path d="M3.76 25.88l12.24-12.213 12.24 12.213 3.76-3.76-16-16-16 16 3.76 3.76z"></path>
    </symbol>
    <symbol id="vditor-icon-check" viewBox="0 0 32 32">
      <path d="M28.444 0h-24.889c-1.956 0-3.556 1.6-3.556 3.556v24.889c0 1.956 1.6 3.556 3.556 3.556h24.889c1.956 0 3.556-1.6 3.556-3.556v-24.889c0-1.956-1.6-3.556-3.556-3.556zM28.444 28.445h-24.889v-24.889h24.889v24.889zM26.649 10.667l-2.507-2.524-11.716 11.716-4.587-4.569-2.524 2.507 7.111 7.093z"></path>
    </symbol>
    <symbol id="vditor-icon-theme" viewBox="0 0 32 32">
      <path d="M16 32c-8.816 0-16-7.184-16-16s7.184-16 16-16 16 6.464 16 14.4c0 5.296-4.304 9.6-9.6 9.6h-2.832c-0.448 0-0.8 0.352-0.8 0.8 0 0.192 0.080 0.368 0.208 0.528 0.656 0.752 1.024 1.696 1.024 2.672 0 2.208-1.792 4-4 4zM16 3.2c-7.056 0-12.8 5.744-12.8 12.8s5.744 12.8 12.8 12.8c0.448 0 0.8-0.352 0.8-0.8 0-0.256-0.128-0.448-0.224-0.56-0.656-0.736-1.008-1.68-1.008-2.64 0-2.208 1.792-4 4-4h2.832c3.536 0 6.4-2.864 6.4-6.4 0-6.176-5.744-11.2-12.8-11.2z"></path>
      <path d="M9.6 15.2c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
      <path d="M14.4 8.8c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
      <path d="M22.4 8.8c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
      <path d="M27.2 15.2c0 1.325-1.075 2.4-2.4 2.4s-2.4-1.075-2.4-2.4c0-1.325 1.075-2.4 2.4-2.4s2.4 1.075 2.4 2.4z"></path>
    </symbol>
    <symbol id="vditor-icon-help" viewBox="0 0 32 32">
      <path d="M14.4 25.6h3.2v-3.2h-3.2v3.2zM16 0c-8.832 0-16 7.168-16 16s7.168 16 16 16 16-7.168 16-16-7.168-16-16-16zM16 28.8c-7.056 0-12.8-5.744-12.8-12.8s5.744-12.8 12.8-12.8 12.8 5.744 12.8 12.8-5.744 12.8-12.8 12.8zM16 6.4c-3.536 0-6.4 2.864-6.4 6.4h3.2c0-1.76 1.44-3.2 3.2-3.2s3.2 1.44 3.2 3.2c0 3.2-4.8 2.8-4.8 8h3.2c0-3.6 4.8-4 4.8-8 0-3.536-2.864-6.4-6.4-6.4z"></path>
    </symbol>
    <symbol id="vditor-icon-info" viewBox="0 0 32 32">
      <path d="M14.4 8h3.2v3.2h-3.2zM14.4 14.4h3.2v9.6h-3.2zM16 0c-8.832 0-16 7.168-16 16s7.168 16 16 16 16-7.168 16-16-7.168-16-16-16zM16 28.8c-7.056 0-12.8-5.744-12.8-12.8s5.744-12.8 12.8-12.8 12.8 5.744 12.8 12.8-5.744 12.8-12.8 12.8z"></path>
    </symbol>
    <symbol id="vditor-icon-fullscreen" viewBox="0 0 32 32">
      <path d="M32 14.222v-14.222h-14.222l5.849 5.849-17.778 17.778-5.849-5.849v14.222h14.222l-5.849-5.849 17.778-17.778z"></path>
    </symbol>
    <symbol id="vditor-icon-preview" viewBox="0 0 32 32">
      <path d="M16 8c5.513 0 10.429 3.098 12.829 8-2.4 4.902-7.302 8-12.829 8s-10.429-3.098-12.829-8c2.4-4.902 7.316-8 12.829-8zM16 5.091c-7.273 0-13.484 4.524-16 10.909 2.516 6.385 8.727 10.909 16 10.909s13.484-4.524 16-10.909c-2.516-6.385-8.727-10.909-16-10.909zM16 12.364c2.007 0 3.636 1.629 3.636 3.636s-1.629 3.636-3.636 3.636-3.636-1.629-3.636-3.636 1.629-3.636 3.636-3.636zM16 9.455c-3.607 0-6.545 2.938-6.545 6.545s2.938 6.545 6.545 6.545 6.545-2.938 6.545-6.545-2.938-6.545-6.545-6.545z"></path>
    </symbol>
    <symbol id="vditor-icon-record" viewBox="0 0 32 32">
      <path d="M24.928 15.17h2.844q0 4.267-2.963 7.467t-7.151 3.832v5.531h-3.319v-5.531q-4.188-0.632-7.151-3.832t-2.963-7.467h2.844q0 3.714 2.647 6.123t6.281 2.41 6.281-2.41 2.647-6.123zM13.946 4.899v10.43q0 0.79 0.593 1.383t1.462 0.593q0.79 0 1.383-0.553t0.593-1.422l0.079-10.43q0-0.869-0.632-1.462t-1.422-0.593-1.422 0.593-0.632 1.462zM16 20.227q-2.054 0-3.556-1.501t-1.501-3.556v-10.114q0-2.054 1.501-3.556t3.556-1.501 3.556 1.501 1.501 3.556v10.114q0 2.054-1.501 3.556t-3.556 1.501z"></path>
    </symbol>
    <symbol id="vditor-icon-pause" viewBox="0 0 32 32">
      <path d="M20.617 0h9.128v32h-9.128v-32zM2.255 32v-32h9.128v32h-9.128z"></path>
    </symbol>
    <symbol id="vditor-icon-play" viewBox="0 0 32 32">
      <path d="M3.436 0l25.128 16-25.128 16v-32z"></path>
    </symbol>
    <symbol id="vditor-icon-emoji" viewBox="0 0 32 32">
      <path d="M16 24.789q-2.779 0-4.995-1.54t-3.192-4.019h2.629q1.878 3.155 5.559 3.155t5.559-3.155h2.629q-0.977 2.479-3.192 4.019t-4.995 1.54zM16 28.845q5.258 0 9.052-3.793t3.793-9.052-3.793-9.052-9.052-3.793-9.052 3.793-3.793 9.052 3.793 9.052 9.052 3.793zM16 0q6.61 0 11.305 4.695t4.695 11.305-4.695 11.305-11.305 4.695-11.305-4.695-4.695-11.305 4.695-11.305 11.305-4.695zM10.366 14.423q-0.977 0-1.69-0.714t-0.714-1.69 0.714-1.69 1.69-0.714 1.69 0.714 0.714 1.69-0.714 1.69-1.69 0.714zM21.634 14.423q-0.977 0-1.69-0.714t-0.714-1.69 0.714-1.69 1.69-0.714 1.69 0.714 0.714 1.69-0.714 1.69-1.69 0.714z"></path>
    </symbol>
    <symbol id="vditor-icon-link" viewBox="0 0 32 32">
      <path d="M24.038 7.962q3.305 0 5.634 2.366t2.329 5.671-2.329 5.671-5.634 2.366h-6.46v-3.080h6.46q2.028 0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.080h6.46zM9.615 17.577v-3.155h12.77v3.155h-12.77zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.080h-6.46q-3.305 0-5.634-2.366t-2.329-5.671 2.329-5.671 5.634-2.366h6.46v3.080h-6.46q-2.028 0-3.493 1.465t-1.465 3.493z"></path>
    </symbol>
    <symbol id="vditor-icon-redo" viewBox="0 0 32 32">
      <path d="M26.422 14.605l5.578-5.651v14.092h-14.092l5.725-5.651q-3.523-2.936-8.073-2.936-3.743 0-7.229 2.495t-4.661 6.092l-3.67-1.174q1.615-4.991 5.908-8.147t9.651-3.156q6.239 0 10.862 4.037z"></path>
    </symbol>
    <symbol id="vditor-icon-undo" viewBox="0 0 32 32">
      <path d="M16.44 10.569q5.358 0 9.615 3.156t5.945 8.147l-3.67 1.174q-1.248-3.817-4.514-6.202t-7.376-2.385q-4.55 0-8.073 2.936l5.725 5.651h-14.092v-14.092l5.578 5.651q4.624-4.037 10.862-4.037z"></path>
    </symbol>
    <symbol id="vditor-icon-align-center" viewBox="0 0 32 32">
      <path d="M0 0h32v3.583h-32v-3.583zM7.083 7.083h17.833v3.583h-17.833v-3.583zM0 17.75v-3.5h32v3.5h-32zM0 32v-3.583h32v3.583h-32zM7.083 21.333h17.833v3.583h-17.833v-3.583z"></path>
    </symbol>
    <symbol id="vditor-icon-align-left" viewBox="0 0 32 32">
      <path d="M0 0h32v3.583h-32v-3.583zM0 32v-3.583h32v3.583h-32zM0 17.75v-3.5h32v3.5h-32zM21.333 7.083v3.583h-21.333v-3.583h21.333zM21.333 21.333v3.583h-21.333v-3.583h21.333z"></path>
    </symbol>
    <symbol id="vditor-icon-align-right" viewBox="0 0 32 32">
      <path d="M0 0h32v3.583h-32v-3.583zM10.667 10.667v-3.583h21.333v3.583h-21.333zM0 17.75v-3.5h32v3.5h-32zM10.667 24.917v-3.583h21.333v3.583h-21.333zM0 32v-3.583h32v3.583h-32z"></path>
    </symbol>
    <symbol id="vditor-icon-bold" viewBox="0 0 32 32">
      <path d="M18.569 26.328q1.498 0 2.462-1.017t0.963-2.408-0.963-2.408-2.462-1.017h-8.027v6.849h8.027zM10.542 5.779v6.85h6.85q1.391 0 2.408-1.017t1.017-2.408-1.017-2.408-2.408-1.017h-6.849zM23.385 15.518q4.923 2.248 4.923 7.813 0 3.639-2.408 6.154t-6.047 2.515h-16.161v-32h14.341q3.853 0 6.475 2.676t2.622 6.528-3.746 6.314z"></path>
    </symbol>
    <symbol id="vditor-icon-indent" viewBox="0 0 32 32">
      <path d="M14.25 17.75v-3.5h17.75v3.5h-17.75zM14.25 10.667v-3.583h17.75v3.583h-17.75zM0 0h32v3.583h-32v-3.583zM0 32v-3.583h32v3.583h-32zM0 16l7.083-7.083v14.167zM14.25 24.917v-3.583h17.75v3.583h-17.75z"></path>
    </symbol>
    <symbol id="vditor-icon-outdent" viewBox="0 0 32 32">
      <path d="M14.25 17.75v-3.5h17.75v3.5h-17.75zM14.25 10.667v-3.583h17.75v3.583h-17.75zM0 0h32v3.583h-32v-3.583zM14.25 24.917v-3.583h17.75v3.583h-17.75zM0 8.917l7.083 7.083-7.083 7.083v-14.167zM0 32v-3.583h32v3.583h-32z"></path>
    </symbol>
    <symbol id="vditor-icon-italic" viewBox="0 0 32 32">
      <path d="M11.398 0h18.301v6.849h-6.421l-7.706 18.301h5.030v6.849h-18.301v-6.849h6.421l7.706-18.301h-5.030v-6.849z"></path>
    </symbol>
    <symbol id="vditor-icon-list" viewBox="0 0 32 32">
      <path d="M7.777 3.929h24.223v3.403h-24.223v-3.403zM7.777 17.701v-3.403h24.223v3.403h-24.223zM7.777 28.071v-3.403h24.223v3.403h-24.223zM2.592 23.777q1.053 0 1.823 0.77t0.77 1.823-0.77 1.823-1.823 0.77-1.823-0.77-0.77-1.823 0.77-1.823 1.823-0.77zM2.592 3.038q1.053 0 1.823 0.729t0.77 1.863-0.77 1.863-1.823 0.729-1.823-0.729-0.77-1.863 0.77-1.863 1.823-0.729zM2.592 13.408q1.053 0 1.823 0.729t0.77 1.863-0.77 1.863-1.823 0.729-1.823-0.729-0.77-1.863 0.77-1.863 1.823-0.729z"></path>
    </symbol>
    <symbol id="vditor-icon-ordered-list" viewBox="0 0 32 32">
      <path d="M8.375 17.659v-3.319h23.625v3.319h-23.625zM8.375 27.773v-3.319h23.625v3.319h-23.625zM8.375 4.227h23.625v3.319h-23.625v-3.319zM0 14.341v-1.738h5.057v1.58l-3.081 3.477h3.081v1.738h-5.057v-1.58l3.002-3.477h-3.002zM1.659 9.284v-5.057h-1.659v-1.738h3.319v6.795h-1.659zM0 24.454v-1.738h5.057v6.795h-5.057v-1.738h3.319v-0.79h-1.659v-1.738h1.659v-0.79h-3.319z"></path>
    </symbol>
    <symbol id="vditor-icon-mp-wechat" viewBox="0 0 32 32">
      <path d="M6.927 17.719s-3.040-3.431-2.915-6.942c0.16-4.453 4.738-10.257 11.359-10.257 1.884 0 5.653 0 10.328 5.52 0.249 0.302-15.075-3.84-18.772 11.679z"></path>
      <path d="M17.477 9.301s3.946-1.298 7.271-0.178c4.222 1.422 8.693 6.826 6.809 13.182-0.533 1.804-1.609 5.413-8.231 8.32-0.356 0.16 10.613-13.351-5.849-21.323z"></path>
      <path d="M10.944 24.332c-1.938 2.035-3.751 1.742-3.751 1.742l0.578-3.191c-5.235-3.44-6.373-10.328-6.453-10.106-2.444 6.817-0.916 11.377 0.027 13.004 3.315 5.733 11.982 7.351 17.484 3.893 2.969-1.867 4.533-7.057 4.533-7.057-5.298 2.338-9.342 2.569-12.417 1.715z"></path>
    </symbol>
    <symbol id="vditor-icon-zhihu" viewBox="0 0 32 32">
      <path d="M17.167 17.769s0-2.583-1.25-2.667c-1.25-0.167-5.167 0-5.167 0v-8h5.833s-0.083-2.667-1.167-2.667h-9.5l1.583-4.25s-2.333 0.167-3.25 1.667c-0.833 1.5-3.5 9.167-3.5 9.167s0.917 0.417 2.417-0.75c1.5-1.083 2-3.083 2-3.083l2.75-0.167 0.083 8.083s-4.917-0.083-5.833 0c-1 0.083-1.5 2.667-1.5 2.667h7.417s-0.667 4.583-2.5 7.75c-1.917 3.333-5.583 5.917-5.583 5.917s2.583 1.083 5.167-0.417 4.417-8.083 4.417-8.083l5.917 7.417s0.5-3.5-0.083-4.583c-0.667-1-4.167-5-4.167-5l-1.5 1.333 1.083-4.417 6.333 0.083zM18.667 4.269l-0.083 23.999h2.417l0.833 2.917 4.25-2.917h5.917v-23.999h-13.333zM29.333 25.602h-2.75l-3.5 2.667-0.75-2.667h-0.75v-18.582h7.75v18.582z"></path>
    </symbol>
  </defs>
</svg>
    <!--[if lt IE 9]>
        <div class="message error browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
    <![endif]-->
<div class="typecho-head-nav clearfix" role="navigation">
    <nav id="typecho-nav-list">
        <ul class="root"><li class="parent"><a href="https://lo8ol.com/admin/index.php">控制台</a></li><ul class="child"><li><a href="https://lo8ol.com/admin/index.php">概要</a></li><li><a href="https://lo8ol.com/admin/profile.php">个人设置</a></li><li><a href="https://lo8ol.com/admin/plugins.php">插件</a></li><li><a href="https://lo8ol.com/admin/themes.php">外观</a></li><li class="last"><a href="https://lo8ol.com/admin/backup.php">备份</a></li></ul></ul><ul class="root focus"><li class="parent"><a href="https://lo8ol.com/admin/write-post.php">撰写</a></li><ul class="child"><li><a href="https://lo8ol.com/admin/write-post.php">撰写文章</a></li><li class="focus"><a href="https://lo8ol.com/admin/write-post.php?cid=7">编辑 【DG部署】【单机DB+单实例DG】</a></li><li class="last"><a href="https://lo8ol.com/admin/write-page.php">创建页面</a></li></ul></ul><ul class="root"><li class="parent"><a href="https://lo8ol.com/admin/manage-posts.php">管理</a></li><ul class="child"><li><a href="https://lo8ol.com/admin/manage-posts.php">文章</a></li><li><a href="https://lo8ol.com/admin/manage-pages.php">独立页面</a></li><li><a href="https://lo8ol.com/admin/manage-comments.php">评论</a></li><li><a href="https://lo8ol.com/admin/manage-categories.php">分类</a></li><li><a href="https://lo8ol.com/admin/manage-tags.php">标签</a></li><li><a href="https://lo8ol.com/admin/manage-medias.php">文件</a></li><li><a href="https://lo8ol.com/admin/manage-users.php">用户</a></li><li class="last"><a href="https://lo8ol.com/admin/extending.php?panel=Handsome%2Fmanage-links.php">友情链接</a></li></ul></ul><ul class="root"><li class="parent"><a href="https://lo8ol.com/admin/options-general.php">设置</a></li><ul class="child"><li><a href="https://lo8ol.com/admin/options-general.php">基本</a></li><li><a href="https://lo8ol.com/admin/options-discussion.php">评论</a></li><li><a href="https://lo8ol.com/admin/options-reading.php">阅读</a></li><li class="last"><a href="https://lo8ol.com/admin/options-permalink.php">永久链接</a></li></ul></ul>    </nav>
    <div class="operate">
                <a title="最后登录: 昨天 20:50" href="https://lo8ol.com/admin/profile.php" class="author">klaus</a><a class="exit" href="https://lo8ol.com/action/logout">登出</a><a href="https://lo8ol.com/" target="_blank">网站</a>
    </div>
</div>

<div class="main">
    <div class="body container">
        <div class="typecho-page-title">
    <h2>编辑 【DG部署】【单机DB+单实例DG】</h2>
</div>
        <div class="row typecho-page-main typecho-post-area" role="form">
            <form action="https://lo8ol.com/action/contents-post-edit?_=fe69c0b12e48c09f8f9c86367328fba5" method="post" name="write_post">
                <div class="col-mb-12 col-tb-9" role="main">
                    
                    <p class="title">
                        <label for="title" class="sr-only">标题</label>
                        <input type="text" id="title" name="title" autocomplete="off" value="【DG部署】【单机DB+单实例DG】" placeholder="标题" class="w-100 text title">
                    </p>
                                        <p class="mono url-slug">
                        <label for="slug" class="sr-only">网址缩略名</label>
                        lo8ol.com/dg/<div style="position: relative; display: inline-block;"><input type="text" id="slug" name="slug" autocomplete="off" value="7" class="mono" style="left: 0px; top: 0px; min-width: 5px; position: absolute; width: 100%;"><pre style="display: block; visibility: hidden; height: 15px; padding: 0px 2px; margin: 0px;">7</pre></div>.html                    </p>
                    <p><div id="vditor" class="vditor" style="height: 640px; width: auto;"><div class="vditor-toolbar" style="padding-left: 35px;"><div class="vditor-toolbar__item"><button data-type="headings" class="vditor-tooltipped vditor-tooltipped__ne vditor-menu--current" aria-label="标题 &lt;Ctrl+H&gt;"><svg><use xlink:href="#vditor-icon-headings"></use></svg></button><div class="vditor-hint vditor-panel--arrow" style="display: none;"><button data-tag="h1" data-value="# ">一级标题 &lt;Alt+Ctrl+1&gt;</button>
<button data-tag="h2" data-value="## ">二级标题 &lt;Alt+Ctrl+2&gt;</button>
<button data-tag="h3" data-value="### ">三级标题 &lt;Alt+Ctrl+3&gt;</button>
<button data-tag="h4" data-value="#### ">四级标题 &lt;Alt+Ctrl+4&gt;</button>
<button data-tag="h5" data-value="##### ">五级标题 &lt;Alt+Ctrl+5&gt;</button>
<button data-tag="h6" data-value="###### ">六级标题 &lt;Alt+Ctrl+6&gt;</button></div></div><div class="vditor-toolbar__item"><button data-type="bold" class="vditor-tooltipped vditor-tooltipped__ne" aria-label="粗体 &lt;Ctrl+B&gt;"><svg><use xlink:href="#vditor-icon-bold"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="italic" class="vditor-tooltipped vditor-tooltipped__ne" aria-label="斜体 &lt;Ctrl+I&gt;"><svg><use xlink:href="#vditor-icon-italic"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="strike" class="vditor-tooltipped vditor-tooltipped__ne" aria-label="删除线 &lt;Ctrl+D&gt;"><svg><use xlink:href="#vditor-icon-strike"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="link" class="vditor-tooltipped vditor-tooltipped__n" aria-label="链接 &lt;Ctrl+K&gt;"><svg><use xlink:href="#vditor-icon-link"></use></svg></button></div><div class="vditor-toolbar__divider"></div><div class="vditor-toolbar__item"><button data-type="list" class="vditor-tooltipped vditor-tooltipped__n" aria-label="无序列表 &lt;Ctrl+L&gt;"><svg><use xlink:href="#vditor-icon-list"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="ordered-list" class="vditor-tooltipped vditor-tooltipped__n" aria-label="有序列表 &lt;Ctrl+O&gt;"><svg><use xlink:href="#vditor-icon-ordered-list"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="check" class="vditor-tooltipped vditor-tooltipped__n" aria-label="任务列表 &lt;Ctrl+J&gt;"><svg><use xlink:href="#vditor-icon-check"></use></svg></button></div><div class="vditor-toolbar__item" style="display: block;"><button data-type="outdent" class="vditor-tooltipped vditor-tooltipped__n vditor-menu--disabled" aria-label="列表反向缩进 &lt;Ctrl+Shift+I&gt;"><svg><use xlink:href="#vditor-icon-outdent"></use></svg></button></div><div class="vditor-toolbar__item" style="display: block;"><button data-type="indent" class="vditor-tooltipped vditor-tooltipped__n vditor-menu--disabled" aria-label="列表缩进 &lt;Ctrl+Shift+O&gt;"><svg><use xlink:href="#vditor-icon-indent"></use></svg></button></div><div class="vditor-toolbar__divider"></div><div class="vditor-toolbar__item"><button data-type="quote" class="vditor-tooltipped vditor-tooltipped__n" aria-label="引用 &lt;Ctrl+;&gt;"><svg><use xlink:href="#vditor-icon-quote"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="line" class="vditor-tooltipped vditor-tooltipped__n" aria-label="分隔线 &lt;Ctrl+Shift+H&gt;"><svg><use xlink:href="#vditor-icon-line"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="code" class="vditor-tooltipped vditor-tooltipped__n" aria-label="代码块 &lt;Ctrl+U&gt;"><svg><use xlink:href="#vditor-icon-code"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="inline-code" class="vditor-tooltipped vditor-tooltipped__n" aria-label="行内代码 &lt;Ctrl+G&gt;"><svg><use xlink:href="#vditor-icon-inline-code"></use></svg></button></div><div class="vditor-toolbar__divider"></div><div class="vditor-toolbar__item"><div data-type="upload" class="vditor-tooltipped vditor-tooltipped__n" aria-label="上传图片或文件"><svg><use xlink:href="#vditor-icon-upload"></use></svg><input type="file" multiple="multiple"></div></div><div class="vditor-toolbar__item"><button data-type="table" class="vditor-tooltipped vditor-tooltipped__n" aria-label="表格 &lt;Ctrl+M&gt;"><svg><use xlink:href="#vditor-icon-table"></use></svg></button></div><div class="vditor-toolbar__divider"></div><div class="vditor-toolbar__item"><button data-type="undo" class="vditor-tooltipped vditor-tooltipped__nw" aria-label="撤销 &lt;Ctrl+Z&gt;"><svg><use xlink:href="#vditor-icon-undo"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="redo" class="vditor-tooltipped vditor-tooltipped__nw vditor-menu--disabled" aria-label="重做 &lt;Ctrl+Y&gt;"><svg><use xlink:href="#vditor-icon-redo"></use></svg></button></div><div class="vditor-toolbar__divider"></div><div class="vditor-toolbar__item"><button data-type="export" class="vditor-tooltipped vditor-tooltipped__ne" aria-label="导出"><svg><use xlink:href="#vditor-icon-export"></use></svg></button><div class="vditor-hint vditor-panel--arrow" style="display: none;"><button data-type="markdown">Markdown</button>
<button data-type="pdf">PDF</button>
<button data-type="html">HTML</button></div></div><div class="vditor-toolbar__item"><button data-type="fullscreen" class="vditor-tooltipped vditor-tooltipped__nw" aria-label="全屏切换 &lt;Ctrl+'&gt;"><svg><use xlink:href="#vditor-icon-fullscreen"></use></svg></button></div><div class="vditor-toolbar__item" style="display: block;"><button data-type="outline" class="vditor-tooltipped vditor-tooltipped__nw" aria-label="大纲"><svg><use xlink:href="#vditor-icon-align-center"></use></svg></button></div><div class="vditor-toolbar__item" style="display: none;"><button data-type="both" class="vditor-tooltipped vditor-tooltipped__nw vditor-menu--current" aria-label="编辑 &amp; 预览 &lt;Ctrl+P&gt;"><svg><use xlink:href="#vditor-icon-both"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="preview" class="vditor-tooltipped vditor-tooltipped__nw" aria-label="预览"><svg><use xlink:href="#vditor-icon-preview"></use></svg></button></div><div class="vditor-toolbar__item"><button data-type="toHelp" class="vditor-tooltipped vditor-tooltipped__undefined" aria-label="帮助文档"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"> <path d="M19.652 25v6c0 0.55-0.45 1-1 1h-6c-0.55 0-1-0.45-1-1v-6c0-0.55 0.45-1 1-1h6c0.55 0 1 0.45 1 1zM27.552 10c0 4.75-3.225 6.575-5.6 7.9-1.475 0.85-2.4 2.575-2.4 3.3v0c0 0.55-0.425 1.2-1 1.2h-6c-0.55 0-0.9-0.85-0.9-1.4v-1.125c0-3.025 3-5.625 5.2-6.625 1.925-0.875 2.725-1.7 2.725-3.3 0-1.4-1.825-2.65-3.85-2.65-1.125 0-2.15 0.35-2.7 0.725-0.6 0.425-1.2 1.025-2.675 2.875-0.2 0.25-0.5 0.4-0.775 0.4-0.225 0-0.425-0.075-0.625-0.2l-4.1-3.125c-0.425-0.325-0.525-0.875-0.25-1.325 2.7-4.475 6.5-6.65 11.6-6.65 5.35 0 11.35 4.275 11.35 10z"></path> </svg></button></div><div class="vditor-toolbar__item"><button data-type="edit-mode" class="vditor-tooltipped vditor-tooltipped__nw" aria-label="切换编辑模式"><svg><use xlink:href="#vditor-icon-edit"></use></svg></button><div class="vditor-hint vditor-panel--arrow" style="display: none;"><button data-mode="wysiwyg">所见即所得 &lt;Alt+Ctrl+7&gt;</button>
<button data-mode="ir" class="vditor-menu--current">即时渲染 &lt;Alt+Ctrl+8&gt;</button>
<button data-mode="sv">分屏预览 &lt;Alt+Ctrl+9&gt;</button></div></div><div class="vditor-toolbar__item"><button data-type="more" class="vditor-tooltipped vditor-tooltipped__e" aria-label="更多"><svg><use xlink:href="#vditor-icon-more"></use></svg></button><div class="vditor-hint vditor-panel--arrow" style="display: none;"><div><button data-type="insert_iamge">插入图片</button></div><div><button data-type="insert_word">插入带颜色的文字</button></div><div><button data-type="insert_music">插入音乐</button></div><div><button data-type="insert_video">插入视频</button></div><div><button data-type="insert_post">插入文章</button></div><div><button data-type="insert_button">插入按钮</button></div><div><button data-type="insert_scode">插入高亮引用</button></div><div><button data-type="insert_collapse">插入收缩框</button></div><div><button data-type="insert_collapse">插入评论可见</button></div><div><button data-type="insert_collapse">插入登录可见</button></div><div><button data-type="insert_collapse">插入tab</button></div><div><button data-type="insert_collapse">插入相册</button></div><div><button data-type="insert_timeline">插入时间线</button></div><div><button data-type="insert_todolist">插入计划表</button></div><div><button data-type="insert_column">插入多列布局</button></div><div><button data-type="info">关于</button></div><div><button data-type="help">帮助</button></div></div></div><span class="vditor-counter vditor-tooltipped vditor-tooltipped__nw" aria-label="markdown">53658</span></div><div class="vditor-content"><div class="vditor-outline" style="display: none;"><div class="vditor-outline__title">大纲</div>
<div class="vditor-outline__content"><ul><li><span data-target-id="ir-Dataguard介绍_1"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Dataguard介绍</span></span><ul><li><span data-target-id="ir-概念_2"><svg></svg><span>概念</span></span></li><li><span data-target-id="ir-原理_4"><svg></svg><span>原理</span></span></li><li><span data-target-id="ir-特点_7"><svg></svg><span>特点</span></span></li><li><span data-target-id="ir-搭建DG方式_9"><svg></svg><span>搭建DG方式</span></span></li><li><span data-target-id="ir-备库数据保护级别_11"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>备库数据保护级别</span></span><ul><li><span data-target-id="ir-保护模式和重做传输_13"><svg></svg><span>保护模式和重做传输</span></span></li><li><span data-target-id="ir-最大保护模式_16"><svg></svg><span>最大保护模式</span></span></li><li><span data-target-id="ir-最大可用性模式_18"><svg></svg><span>最大可用性模式</span></span></li><li><span data-target-id="ir-最高性能模式_20"><svg></svg><span>最高性能模式</span></span></li></ul></li></ul></li><li><span data-target-id="ir-环境准备_22"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>环境准备</span></span><ul><li><span data-target-id="ir-环境规划_23"><svg></svg><span>环境规划</span></span></li><li><span data-target-id="ir-数据库安装-略-_26"><svg></svg><span>数据库安装(略)</span></span></li></ul></li><li><span data-target-id="ir-主库配置_28"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>主库配置</span></span><ul><li><span data-target-id="ir-CDB和Non-CDB环境下_29"><svg></svg><span>CDB和Non CDB环境下</span></span></li><li><span data-target-id="ir-开启归档_32"><svg></svg><span>开启归档</span></span></li><li><span data-target-id="ir-开启闪回_34"><svg></svg><span>开启闪回</span></span></li><li><span data-target-id="ir-开启所有PDB_37"><svg></svg><span>开启所有PDB</span></span></li><li><span data-target-id="ir-设置数据库强制归档_40"><svg></svg><span>设置数据库强制归档</span></span></li><li><span data-target-id="ir-添加Standby-redo-log_43"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>添加Standby redo log</span></span><ul><li><span data-target-id="ir-说明-_44"><svg></svg><span>说明：</span></span></li><li><span data-target-id="ir-作用-_46"><svg></svg><span>作用：</span></span></li><li><span data-target-id="ir-创建原则-_48"><svg></svg><span>创建原则：</span></span></li></ul></li><li><span data-target-id="ir-修改参数文件_51"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>修改参数文件</span></span><ul><li><span data-target-id="ir-设置DB唯一名称_52"><svg></svg><span>设置DB唯一名称</span></span></li><li><span data-target-id="ir-设置归档日志的路径_54"><svg></svg><span>设置归档日志的路径</span></span></li><li><span data-target-id="ir-启用设置的日志路径_56"><svg></svg><span>启用设置的日志路径</span></span></li><li><span data-target-id="ir-设置归档日志进程的最大数量_58"><svg></svg><span>设置归档日志进程的最大数量</span></span></li><li><span data-target-id="ir-设置备库从哪个数据库获取归档日志_60"><svg></svg><span>设置备库从哪个数据库获取归档日志</span></span></li><li><span data-target-id="ir-设置文件管理模式_62"><svg></svg><span>设置文件管理模式</span></span></li><li><span data-target-id="ir-主备文件路径_64"><svg></svg><span>主备文件路径</span></span></li><li><span data-target-id="ir-设置数据库口令文件的使用模式_67"><svg></svg><span>设置数据库口令文件的使用模式</span></span></li><li><span data-target-id="ir-设置默认监听_69"><svg></svg><span>设置默认监听</span></span></li></ul></li></ul></li><li><span data-target-id="ir-备库配置_72"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>备库配置</span></span><ul><li><span data-target-id="ir-变量环境_73"><svg></svg><span>变量环境</span></span></li><li><span data-target-id="ir-主备库密码文件_75"><svg></svg><span>主备库密码文件</span></span></li><li><span data-target-id="ir-修改参数文件-_77"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>修改参数文件</span></span><ul><li><span data-target-id="ir-复制主库参数文件_78"><svg></svg><span>复制主库参数文件</span></span></li><li><span data-target-id="ir-修改initorcldg-ora内容_81"><svg></svg><span>修改initorcldg.ora内容</span></span></li></ul></li><li><span data-target-id="ir-备库创建spfile_83"><svg></svg><span>备库创建spfile</span></span></li><li><span data-target-id="ir-创建备库所需路径_85"><svg></svg><span>创建备库所需路径</span></span></li></ul></li><li><span data-target-id="ir-主备库监听_88"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>主备库监听</span></span><ul><li><span data-target-id="ir-开机自启动监听_89"><svg></svg><span>开机自启动监听</span></span></li><li><span data-target-id="ir-主库注册静态监听_92"><svg></svg><span>主库注册静态监听</span></span></li><li><span data-target-id="ir-备库注册静态监听_95"><svg></svg><span>备库注册静态监听</span></span></li><li><span data-target-id="ir-主备库TNS监听相同_97"><svg></svg><span>主备库TNS监听相同</span></span></li><li><span data-target-id="ir-主备连接测试_99"><svg></svg><span>主备连接测试</span></span></li></ul></li><li><span data-target-id="ir--方式一-物理备库之RMAN-Duplicate-_101"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>【方式一：物理备库之RMAN Duplicate】</span></span><ul><li><span data-target-id="ir-备库启动到nomount状态_103"><svg></svg><span>备库启动到nomount状态</span></span></li><li><span data-target-id="ir-登陆RMAN连接主备库_105"><svg></svg><span>登陆RMAN连接主备库</span></span></li><li><span data-target-id="ir-开始-Duplicate_107"><svg></svg><span>开始 Duplicate</span></span></li></ul></li><li><span data-target-id="ir--方式二-物理备库之RMAN备份还原-_109"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>【方式二：物理备库之RMAN备份还原】</span></span><ul><li><span data-target-id="ir-主库RMAN全备_111"><svg></svg><span>主库RMAN全备</span></span></li><li><span data-target-id="ir-主库备份控制文件_113"><svg></svg><span>主库备份控制文件</span></span></li><li><span data-target-id="ir-拷贝备份文件到备库_115"><svg></svg><span>拷贝备份文件到备库</span></span></li><li><span data-target-id="ir-备库启动到nomount状态-_117"><svg></svg><span>备库启动到nomount状态</span></span></li><li><span data-target-id="ir-备库恢复控制文件_119"><svg></svg><span>备库恢复控制文件</span></span></li><li><span data-target-id="ir-备库mount_121"><svg></svg><span>备库mount</span></span></li><li><span data-target-id="ir-还原数据库_123"><svg></svg><span>还原数据库</span></span></li></ul></li><li><span data-target-id="ir--方式三-物理备库之CDB下的DBCA-_125"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>【方式三：物理备库之CDB下的DBCA】</span></span><ul><li><span data-target-id="ir-DBCA备库说明_126"><svg></svg><span>DBCA备库说明</span></span></li><li><span data-target-id="ir-配置Hosts_128"><svg></svg><span>配置Hosts</span></span></li><li><span data-target-id="ir-DBCA过程_130"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>DBCA过程</span></span><ul><li><span data-target-id="ir-主库开启_131"><svg></svg><span>主库开启</span></span></li><li><span data-target-id="ir-DBCA命令_133"><svg></svg><span>DBCA命令</span></span></li></ul></li></ul></li><li><span data-target-id="ir-开启并验证DG同步_137"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>开启并验证DG同步</span></span><ul><li><span data-target-id="ir-开启实时同步_138"><svg></svg><span>开启实时同步</span></span></li><li><span data-target-id="ir-备库开启闪回_140"><svg></svg><span>备库开启闪回</span></span></li><li><span data-target-id="ir-归档同步验证_142"><svg></svg><span>归档同步验证</span></span></li><li><span data-target-id="ir-查看主备库状态_144"><svg></svg><span>查看主备库状态</span></span></li><li><span data-target-id="ir-主库查看备库归档路径报错_146"><svg></svg><span>主库查看备库归档路径报错</span></span></li><li><span data-target-id="ir-主库Dataguard的状态信息_148"><svg></svg><span>主库Dataguard的状态信息</span></span></li><li><span data-target-id="ir-建表测试_150"><svg></svg><span>建表测试</span></span></li></ul></li><li><span data-target-id="ir-DG切换和恢复_152"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>DG切换和恢复</span></span><ul><li><span data-target-id="ir-Switchover_154"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Switchover</span></span><ul><li><span data-target-id="ir-主库上操作_155"><svg></svg><span>主库上操作</span></span></li><li><span data-target-id="ir-备库上操作_157"><svg></svg><span>备库上操作</span></span></li><li><span data-target-id="ir-新备库-原主库-上的操作_159"><svg></svg><span>新备库(原主库)上的操作</span></span></li><li><span data-target-id="ir-验证_161"><svg></svg><span>验证</span></span></li></ul></li><li><span data-target-id="ir-Failover_163"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Failover</span></span><ul><li><span data-target-id="ir-备库上操作-_166"><svg></svg><span>备库上操作</span></span></li><li><span data-target-id="ir-停止实时同步_168"><svg></svg><span>停止实时同步</span></span></li><li><span data-target-id="ir-状态改为主库_170"><svg></svg><span>状态改为主库</span></span></li><li><span data-target-id="ir-开启数据库open_172"><svg></svg><span>开启数据库open</span></span></li></ul></li><li><span data-target-id="ir-Failover恢复_174"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Failover恢复</span></span><ul><li><span data-target-id="ir-在新主库上执行_176"><svg></svg><span>在新主库上执行</span></span></li><li><span data-target-id="ir-在老主库上执行_178"><svg></svg><span>在老主库上执行</span></span></li></ul></li></ul></li><li><span data-target-id="ir--方式四-逻辑备库Logical-Standby-_180"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>【方式四：逻辑备库Logical Standby】</span></span><ul><li><span data-target-id="ir-说明_181"><svg></svg><span>说明</span></span></li><li><span data-target-id="ir-备库停止MGR-Redo-apply应用-_183"><svg></svg><span>备库停止MGR(Redo apply应用)</span></span></li><li><span data-target-id="ir-主库构建LogMiner字典_185"><svg></svg><span>主库构建LogMiner字典</span></span></li><li><span data-target-id="ir-物理备库恢复为逻辑备库_187"><svg></svg><span>物理备库恢复为逻辑备库</span></span></li><li><span data-target-id="ir-开启逻辑备库并同步_189"><svg></svg><span>开启逻辑备库并同步</span></span></li><li><span data-target-id="ir-测试_191"><svg></svg><span>测试</span></span></li><li><span data-target-id="ir-Swichover_193"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Swichover</span></span><ul><li><span data-target-id="ir-状态检查_194"><svg></svg><span>状态检查</span></span></li><li><span data-target-id="ir--准备-转换Primary为逻辑Standby_196"><svg></svg><span>[准备]转换Primary为逻辑Standby</span></span></li><li><span data-target-id="ir--准备-转换逻辑Standby为Primary_198"><svg></svg><span>[准备]转换逻辑Standby为Primary</span></span></li><li><span data-target-id="ir-再次检查Primary状态_200"><svg></svg><span>再次检查Primary状态</span></span></li><li><span data-target-id="ir-正式转换Primary为逻辑Standby_202"><svg></svg><span>正式转换Primary为逻辑Standby</span></span></li><li><span data-target-id="ir-再次检查逻辑Standby状态_204"><svg></svg><span>再次检查逻辑Standby状态</span></span></li><li><span data-target-id="ir-正式转换逻辑Standby为新Primary_206"><svg></svg><span>正式转换逻辑Standby为新Primary</span></span></li><li><span data-target-id="ir-开始新的主备同步_208"><svg></svg><span>开始新的主备同步</span></span></li><li><span data-target-id="ir-测试-_210"><svg></svg><span>测试</span></span></li></ul></li><li><span data-target-id="ir-Failover-_212"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Failover</span></span><ul><li><span data-target-id="ir-检查丢失的归档_213"><svg></svg><span>检查丢失的归档</span></span></li><li><span data-target-id="ir-模拟Failover_215"><svg></svg><span>模拟Failover</span></span></li><li><span data-target-id="ir-检查Standby日志情况_217"><svg></svg><span>检查Standby日志情况</span></span></li><li><span data-target-id="ir-激活前检查_219"><svg></svg><span>激活前检查</span></span></li><li><span data-target-id="ir-激活新的Primary数据库_221"><svg></svg><span>激活新的Primary数据库</span></span></li></ul></li><li><span data-target-id="ir-Failover恢复-_223"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>Failover恢复</span></span><ul><li><span data-target-id="ir-DB-LINK连接主备_225"><svg></svg><span>DB_LINK连接主备</span></span></li><li><span data-target-id="ir-启动同步_227"><svg></svg><span>启动同步</span></span></li><li><span data-target-id="ir-查看状态并验证_229"><svg></svg><span>查看状态并验证</span></span></li></ul></li></ul></li><li><span data-target-id="ir--方式五-快照备库Snapshot-_231"><svg class="vditor-outline__action"><use xlink:href="#vditor-icon-down"></use></svg><span>【方式五：快照备库Snapshot】</span></span><ul><li><span data-target-id="ir-备库停止Redo-apply应用_233"><svg></svg><span>备库停止Redo apply应用</span></span></li><li><span data-target-id="ir-备库到mount状态_235"><svg></svg><span>备库到mount状态</span></span></li><li><span data-target-id="ir-转换为快照备库_237"><svg></svg><span>转换为快照备库</span></span></li><li><span data-target-id="ir-快照备库到open状态_239"><svg></svg><span>快照备库到open状态</span></span></li><li><span data-target-id="ir-快照备库对主库的日志接收_241"><svg></svg><span>快照备库对主库的日志接收</span></span></li><li><span data-target-id="ir-快照备库可读写_245"><svg></svg><span>快照备库可读写</span></span></li><li><span data-target-id="ir-恢复为物理备库_247"><svg></svg><span>恢复为物理备库</span></span></li></ul></li><li><span data-target-id="ir-DG开关机顺序_249"><svg></svg><span>DG开关机顺序</span></span></li><li><span data-target-id="ir-DG维护相关_251"><svg></svg><span>DG维护相关</span></span></li></ul></div></div><div class="vditor-wysiwyg" style="display: none;"><pre class="vditor-reset" placeholder="" spellcheck="false" contenteditable="true"></pre>
<div class="vditor-panel vditor-panel--none"></div>
<div class="vditor-panel vditor-panel--none">
    <button type="button" aria-label="评论" class="vditor-icon vditor-tooltipped vditor-tooltipped__n">
        <svg><use xlink:href="#vditor-icon-comment"></use></svg>
    </button>
</div></div><pre class="vditor-sv vditor-reset" placeholder="" spellcheck="false" style="display: none;" contenteditable="true"></pre><div class="vditor-ir" style="display: block;"><pre class="vditor-reset" placeholder="" spellcheck="false" style="--editor-bottom: 302px; padding: 10px 35px;" contenteditable="true"><div data-block="0" data-type="html-block" class="vditor-ir__node"><pre class="vditor-ir__marker--pre vditor-ir__marker"><code data-type="html-block">&lt;center&gt;
    &lt;font style="font-weight:bold" size=4&gt;
        【DG部署】【单机DB+单实例DG】
    &lt;/font&gt;
&lt;/center&gt;</code></pre><pre class="vditor-ir__preview" data-render="1"><center>
    <font style="font-weight:bold" size="4">
        【DG部署】【单机DB+单实例DG】
    </font>
</center></pre></div><h2 data-block="0" class="vditor-ir__node" id="ir-Dataguard介绍_1" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>Dataguard介绍</h2><h3 data-block="0" class="vditor-ir__node" id="ir-概念_2" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>概念</h3><blockquote data-block="0"><p data-block="0">Data Guard是保证企业数据的高可用性（high availability）、数据保护（data protection）以及灾难恢复（disaster recovery）的集成化灾难恢复解决方案，该技术可以维护生产数据库一个或多个同步备份，有一个生产数据库和若干个备用数据库组成，并形成一个独立的、易于管理的数据保护方案。Data Guard备用数据库可以与生产系统位于相同的数据中心，也可以是在地理位置上分布较远的的远程灾难备份中心。</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-原理_4" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>原理</h3><blockquote data-block="0"><p data-block="0">Data Guard的基本原理是，当某次事务处理对生产数据库中的数据作出更改时，Oracle将在联机重做日志文件中记录此次更改。在Data Guard中，除了把日志记录到本地的联机日志文件和归档日志文件中外，还通过网络，把日志信息发送到远程的备用数据库服务器上。这个备用日志文件写入过程可以是实时、同步的，以实现零数据丢失（最大保护模式）；也可以是异步的，以减少对网络带宽的压力（最大可用性模式）；或者是通过归档日志文件的批量传输模式，以减少对生产系统的性能影响（最大性能模式）。</p></blockquote><blockquote data-block="0"><p data-block="0">当备份数据库接收到日志信息时，Data Guard可以自动利用日志信息实现数据的同步。当主数据库打开并处于活动状态时，备份数据库可以执行恢复操作；如果主数据出现了故障，备用数据库即可以被激活并接管生产数据库的工作。</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-特点_7" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>特点</h3><blockquote data-block="0"><p data-block="0">1、需要冗余的服务器设备	该模式需要有冗余的服务器硬件，硬件成本较高。
2、需要冗余的存储设备		主机和备机都需要同样的存储空间，成本较高。
3、安装配置比较复杂			该模式比单节点、单实例的模式配置复杂一些，需要更多的配置步骤。
4、管理维护成本高            	该模式对维护人员的要求较高，维护成本高。
5、具备一定的容灾特性		当主机数据库不可用并短期内无法恢复时，可以把数据库系统切换到备机上，具备容灾的功能。
6、备机可以用作只读查询	备机可以切换到只读状态供报表之类的查询操作，减轻主机的压力。</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-搭建DG方式_9" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>搭建DG方式</h3><blockquote data-block="0"><p data-block="0">Data Guard备库按照从生产数据库传输过来的日志处理方法的不同分为物理备库、逻辑备库和快照备库。</p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># 物理备库 (三种方法：1、RMAN的Duplicate 2、RMAN的备份恢复 3、DBCA )
备份数据库处于mount状态下，直接利用数据恢复技术，把日志文件中记录的数据变更应用在备份数据库中，从而实现与生产数据库的数据同步，在进行数据同步的时候，物理备份数据库是不能打开的、也无法提供数据查询等服务；物理备用数据库也可以通过只读的方式打开，此时就只能接收日志文件，而无法进行数据的同步。
# 逻辑备库
数据库是处于正常打开状态，当它接收到新的日志信息后，利用日志挖掘器的功能，把日志中记录的变更信息转换成具体的SQL语句，并在逻辑备用数据库上执行这些SQL语句，从而实现与生产数据库的数据同步。逻辑备份数据支持在数据同步时，进行数据的查询、报表等操作。Oracle从9i R2开始支持逻辑备份数据库。
# 快照备库
可以暂时将物理备份数据库转换为可更新的数据库，快照备份数据不会立马应用接收到的日志文件，设一个时间点，一次性转换。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> 物理备库 (三种方法：1、RMAN的Duplicate 2、RMAN的备份恢复 3、DBCA )</span>
备份数据库处于mount状态下，直接利用数据恢复技术，把日志文件中记录的数据变更应用在备份数据库中，从而实现与生产数据库的数据同步，在进行数据同步的时候，物理备份数据库是不能打开的、也无法提供数据查询等服务；物理备用数据库也可以通过只读的方式打开，此时就只能接收日志文件，而无法进行数据的同步。
<span class="hljs-meta">#</span><span class="bash"> 逻辑备库</span>
数据库是处于正常打开状态，当它接收到新的日志信息后，利用日志挖掘器的功能，把日志中记录的变更信息转换成具体的SQL语句，并在逻辑备用数据库上执行这些SQL语句，从而实现与生产数据库的数据同步。逻辑备份数据支持在数据同步时，进行数据的查询、报表等操作。Oracle从9i R2开始支持逻辑备份数据库。
<span class="hljs-meta">#</span><span class="bash"> 快照备库</span>
可以暂时将物理备份数据库转换为可更新的数据库，快照备份数据不会立马应用接收到的日志文件，设一个时间点，一次性转换。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-备库数据保护级别_11" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库数据保护级别</h3><blockquote data-block="0"><p data-block="0">Oracle Data Guard 支持多种级别的数据保护模式：最大性能模式，最大可用性模式，最大保护模式。分别对应于“重要信息系统灾难恢复指南”中的5级，5级6级自适应，6级的数据保护级别。其中对应6级的最大保护模式可以实现实时数据实时同步和0数据丢失。另外，Oracle Data Guard 可以设置延时应用时间窗口，从而防范错误操作、黑客攻击等人为错误导致的数据损坏。</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-保护模式和重做传输_13" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>保护模式和重做传输</h4><blockquote data-block="0"><p data-block="0">要确定适当的保护模式，企业需要根据用户对系统响应时间的要求来估量它们对数据保护的业务要求。下表从数据丢失风险的角度概述了各种模式的适用性。</p></blockquote><table data-block="0" data-type="table"><thead><tr><th>保护模式</th><th>在灾难出现时数据丢失的风险</th><th>重做传输机制</th></tr></thead><tbody><tr><td>最大保护</td><td>零数据丢失</td><td>LGWR SYNC</td></tr><tr><td>最大可用</td><td>零数据丢失</td><td>LGWR SYNC</td></tr><tr><td>最高性能</td><td>最小数据丢失</td><td>LGWR SYNC或ARCH</td></tr></tbody></table><h4 data-block="0" class="vditor-ir__node" id="ir-最大保护模式_16" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>最大保护模式</h4><blockquote data-block="0"><p data-block="0">最大保护模式为主数据库提供了最高水平的数据保护，从而确保一个全面的零数据丢失的灾难恢复解决方案。当在最大保护模式下运行时，重做记录由日志写入器 (LGWR) 进程从主数据库同步地传输到备用数据库，并且直到确认事务数据在至少一个备用服务器上的磁盘上可用时，才在主数据库上提交事务。</p><p data-block="0">强烈建议，这种模式应至少配置两个备用数据库。当最后参与的备用数据库不可用时，主数据库上的处理将停止。这就确保了当主数据库与其所有备用数据库失去联系时，不会丢失事务。</p><p data-block="0">由于重做传输的同步特性，这种最大保护模式可能潜在地影响主数据库响应时间。可以通过配置一个低延迟网络，并为它分配足够应付高峰事务负载的带宽来将这种影响减到最小。需要这种最大保护模式的企业有股票交易所、货币交易所、金融机构等。</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-最大可用性模式_18" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>最大可用性模式</h4><blockquote data-block="0"><p data-block="0">最高可用性模式拥有仅次于最高水平的主数据库数据可用性。如同最大保护模式一样，重做数据由 LGWR 从主数据库同步地传输到备用数据库，直到确认事务数据在备用服务器的磁盘上可用时，事务才在主数据库上完成。不过，在这种模式下（与最大保护模式不同），如果最后参与的备用数据库变为不可用，例如由于网络连接问题，处理将在主数据库上继续进行。备用数据库与主数据库相比，可能暂时落在后面，但当它再次变为可用时，备用数据库将使用主数据库上累积的归档日志自动同步，而不会丢失数据。</p><p data-block="0">由于同步重做传输，这种保护模式可潜在地影响响应时间和吞吐量。可以通过配置一个低延迟网络，并为它分配足够应付高峰事务负载的带宽来将这种影响减到最小。</p><p data-block="0">最高可用性模式适用于想要确保获得零数据丢失保护，但不想让生产数据库受网络/备用服务器故障影响的企业。如果又一个故障随后影响了生产数据库，然后最初的网络/备用服务器故障得到解决，那么这些企业将接受数据丢失的可能性。</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-最高性能模式_20" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>最高性能模式</h4><blockquote data-block="0"><p data-block="0">最高性能模式是默认的保护模式。它与最高可用性模式相比，提供了稍微少一些的主数据库数据保护，但提供了更高的性能。在这种模式下，当主数据库处理事务时，重做数据由 LGWR 进程异步传输到备用数据库上。另外，也可以将主数据库上的归档器进程 (ARCH) 配置为在这种模式下传输重做数据。在任何情况下，均先完成主数据库上的写操作，主数据库的提交操作不等待备用数据库确认接收。如果任意备用目标数据库变为不可用，则处理将在主数据库上继续进行，这对性能只有很小的影响或没有影响。</p><p data-block="0">在主数据库出现故障的情况下，尚未被发送到备用数据库的重做数据会丢失。但是，如果网络有足够的吞吐量来跟上重做流量高峰，并且使用了 LGWR 进程来将重做流量传输到备用服务器，则丢失的事务将非常少或者为零。</p><p data-block="0">当主数据库上的可用性和性能比丢失少量数据的风险更重要时，应该使用最高性能模式。这种模式还适合于 WAN 上的 Data Guard 部署，在 WAN 中，网络的内在延迟可能限制同步重做传输的适用性。</p></blockquote><h2 data-block="0" class="vditor-ir__node" id="ir-环境准备_22" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>环境准备</h2><h3 data-block="0" class="vditor-ir__node" id="ir-环境规划_23" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>环境规划</h3><blockquote data-block="0"><p data-block="0">实验基于单机DB+单实例DG
注：备库中的实例名是参数设置的</p></blockquote><table data-block="0" data-type="table"><thead><tr><th> </th><th>主库(主机1)</th><th>备库(主机2)</th></tr></thead><tbody><tr><td>DB 类型</td><td>单机</td><td>单机</td></tr><tr><td>OS</td><td>Centos 7.8</td><td>Centos 7.8</td></tr><tr><td>Hostname</td><td>Klaus</td><td>Klausdg</td></tr><tr><td>IP</td><td>192.168.2.2</td><td>192.168.2.3</td></tr><tr><td>DB_Version</td><td>12.1.0.2</td><td>12.1.0.2</td></tr><tr><td>ORACLE_BASE</td><td>/u01/app/oracle</td><td>/u01/app/oracle</td></tr><tr><td>ORACLE_HOME</td><td>/u01/app/oracle/product/12.1.0/dbhome_1</td><td>/u01/app/oracle/product/12.1.0/dbhome_1</td></tr><tr><td>DB_NAME</td><td>orcl</td><td>orcl</td></tr><tr><td>ORACLE_SID</td><td>orcl</td><td>orcldg</td></tr><tr><td>DB_Unique_Name</td><td>orcl</td><td>orcldg</td></tr><tr><td>Instance_Name</td><td>orcl</td><td>orcldg</td></tr><tr><td>service_names</td><td>orcl</td><td>orcldg</td></tr><tr><td>TNS_Name</td><td>ORCL</td><td>ORCLDG</td></tr><tr><td>闪回区</td><td>开启</td><td>开启</td></tr><tr><td>归档</td><td>开启</td><td>开启</td></tr></tbody></table><h3 data-block="0" class="vditor-ir__node" id="ir-数据库安装-略-_26" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>数据库安装(略)</h3><blockquote data-block="0"><p data-block="0">在主库上安装数据库软件，并建监听和实例
在备库上安装数据库软件，并建监听，但不创建实例，安装时选择只安装软件即可</p></blockquote><h2 data-block="0" class="vditor-ir__node" id="ir-主库配置_28" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>主库配置</h2><h3 data-block="0" class="vditor-ir__node" id="ir-CDB和Non-CDB环境下_29" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>CDB和Non CDB环境下</h3><blockquote data-block="0"><p data-block="0">如果实例处于多租户架构中，设置操作和Non-CDB方法相同，都在CDB下完成；
实验中有两个PDB1和PDB2，在创建备库后，默认两个PDB都会同步到备库，也可以通过参数指定只同步某个PDB；
也可以设置完同步的备库后，主库中再添加的PDB3也会同步到备库中。</p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># CDB环境下的实验配置中的主库实例也是orcl,备库是orcldg，需要设置主备不同的 DB_UNIQUE_NAME
# 同样可以通过name参数查看
SQL&gt; show parameter name
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
cdb_cluster_name                     string
cell_offloadgroup_name               string
db_file_name_convert                 string
db_name                              string      orcl
db_unique_name                       string      orcl
global_names                         boolean     FALSE
instance_name                        string      orcl
lock_name_space                      string
log_file_name_convert                string
pdb_file_name_convert                string
processor_group_name                 string
service_names                        string      orcl
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># CDB环境下的实验配置中的主库实例也是orcl,备库是orcldg，需要设置主备不同的 DB_UNIQUE_NAME
# 同样可以通过name参数查看
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">parameter</span> name
NAME                                 TYPE        <span class="hljs-keyword">VALUE</span>
<span class="hljs-comment">------------------------------------ ----------- ------------------------------</span>
cdb_cluster_name                     string
cell_offloadgroup_name               string
db_file_name_convert                 string
db_name                              string      orcl
db_unique_name                       string      orcl
global_names                         <span class="hljs-type">boolean</span>     <span class="hljs-literal">FALSE</span>
instance_name                        string      orcl
lock_name_space                      string
log_file_name_convert                string
pdb_file_name_convert                string
processor_group_name                 string
service_names                        string      orcl
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><blockquote data-block="0"><p data-block="0">涉及的CDB简单操作</p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 查看当前处于的那个容器
SQL&gt; show con_name
CON_NAME
------------------
CDB$ROOT
# 如果处于CDB，可以查看所有PDB
SQL&gt; show pdbs
CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
   2 PDB$SEED                       READ ONLY  NO
   3 PDB1                           READ WRITE NO
   4 PDB2                           READ WRITE NO
# 切换到PDB1
SQL&gt; alter session set container=PDB1;
Session altered.
# 再次查看处于PDB1
SQL&gt; show pdbs
CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
   3 PDB1                           READ WRITE NO
# 再次查看处于PDB1
SQL&gt; show con_name
CON_NAME
------------------------------
PDB1
# 切回CDB
SQL&gt; alter session set container=CDB$ROOT;
Session altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 查看当前处于的那个容器
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> con_name
CON_NAME
<span class="hljs-comment">------------------</span>
CDB$ROOT
# 如果处于CDB，可以查看所有PDB
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> pdbs
CON_ID CON_NAME                       <span class="hljs-keyword">OPEN</span> MODE  RESTRICTED
<span class="hljs-comment">---------- ------------------------------ ---------- ----------</span>
   <span class="hljs-number">2</span> PDB$SEED                       READ <span class="hljs-keyword">ONLY</span>  <span class="hljs-keyword">NO</span>
   <span class="hljs-number">3</span> PDB1                           READ WRITE <span class="hljs-keyword">NO</span>
   <span class="hljs-number">4</span> PDB2                           READ WRITE <span class="hljs-keyword">NO</span>
# 切换到PDB1
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> session <span class="hljs-keyword">set</span> container<span class="hljs-operator">=</span>PDB1;
Session altered.
# 再次查看处于PDB1
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> pdbs
CON_ID CON_NAME                       <span class="hljs-keyword">OPEN</span> MODE  RESTRICTED
<span class="hljs-comment">---------- ------------------------------ ---------- ----------</span>
   <span class="hljs-number">3</span> PDB1                           READ WRITE <span class="hljs-keyword">NO</span>
# 再次查看处于PDB1
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> con_name
CON_NAME
<span class="hljs-comment">------------------------------</span>
PDB1
# 切回CDB
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> session <span class="hljs-keyword">set</span> container<span class="hljs-operator">=</span>CDB$ROOT;
Session altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-开启归档_32" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开启归档</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的
SQL&gt; show con_name
CON_NAME
------------------
CDB$ROOT
# 查看归档是否Enable
SQL&gt; archive log list
Database log mode				Archive Mode
Automatic archival				Enabled
Archive destination				USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence		129
Next log sequence to archive	131
Current log sequence			131
# 这里的归档路径是默认的 USE_DB_RECOVERY_FILE_DEST
# 如果没有开启，开启的步骤
shutdown immediate
startup mount
alter database archivelog;
alter database open;
SQL&gt; alter system switch logfile;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> con_name
CON_NAME
<span class="hljs-comment">------------------</span>
CDB$ROOT
# 查看归档是否Enable
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> archive log list
Database log mode				Archive Mode
Automatic archival				Enabled
Archive destination				USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence		<span class="hljs-number">129</span>
Next log sequence <span class="hljs-keyword">to</span> archive	<span class="hljs-number">131</span>
<span class="hljs-keyword">Current</span> log sequence			<span class="hljs-number">131</span>
# 这里的归档路径是默认的 USE_DB_RECOVERY_FILE_DEST
# 如果没有开启，开启的步骤
shutdown immediate
startup mount
<span class="hljs-keyword">alter</span> database archivelog;
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> switch logfile;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-开启闪回_34" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开启闪回</h3><blockquote data-block="0"><p data-block="0">闪回区的管理，及闪回日志管理，数据库能闪回到过去的多久时间点，这个由闪回区大小以db_flashback_retention_target 参数控制，在闪回区大小足够的情况，下默认能闪回1440秒也就是一天的数据。</p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">SQL&gt; show parameter flashback
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_flashback_retention_target        integer     1440
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">SQL&gt;</span><span class="bash"> show parameter flashback</span>
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_flashback_retention_target        integer     1440
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、查看闪回未开启
SQL&gt; select flashback_on from v$database;
FLASHBACK_ON
------------
NO
# 2、查看 db_recovery_file_dest 为空
SQL&gt; show parameter recovery
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_recovery_file_dest                string
db_recovery_file_dest_size           big integer 0
recovery_parallelism                 integer     0
remote_recovery_file_dest            string
# 3、指定闪回区大小，指定闪回目录路径(顺序必须先设置闪回区大小，才能指定闪回目录，否则报错)
SQL&gt; alter system set db_recovery_file_dest_size=4560m scope=spfile;
System altered.
SQL&gt; shutdown immediate
SQL&gt; startup
# 需要重启数据库才能生效，再继续修改目录位置，修改完目录也需要重启实例
# 4、先创建目录，在指定该闪回区域目录
mkdir -p /u01/app/oracle/fast_recovery_area
SQL&gt; alter system set db_recovery_file_dest='/u01/app/oracle/fast_recovery_area';
System altered.
SQL&gt; shutdown immediate
SQL&gt; startup
# 5 开启闪回
SQL&gt; alter database flashback on;
Database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、查看闪回未开启
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> flashback_on <span class="hljs-keyword">from</span> v$database;
FLASHBACK_ON
<span class="hljs-comment">------------</span>
<span class="hljs-keyword">NO</span>
# <span class="hljs-number">2</span>、查看 db_recovery_file_dest 为空
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">parameter</span> recovery
NAME                                 TYPE        <span class="hljs-keyword">VALUE</span>
<span class="hljs-comment">------------------------------------ ----------- ------------------------------</span>
db_recovery_file_dest                string
db_recovery_file_dest_size           big <span class="hljs-type">integer</span> <span class="hljs-number">0</span>
recovery_parallelism                 <span class="hljs-type">integer</span>     <span class="hljs-number">0</span>
remote_recovery_file_dest            string
# <span class="hljs-number">3</span>、指定闪回区大小，指定闪回目录路径(顺序必须先设置闪回区大小，才能指定闪回目录，否则报错)
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> db_recovery_file_dest_size<span class="hljs-operator">=</span><span class="hljs-number">4560</span>m <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<span class="hljs-keyword">System</span> altered.
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup
# 需要重启数据库才能生效，再继续修改目录位置，修改完目录也需要重启实例
# <span class="hljs-number">4</span>、先创建目录，在指定该闪回区域目录
mkdir <span class="hljs-operator">-</span>p <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>fast_recovery_area
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> db_recovery_file_dest<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/fast_recovery_area'</span>;
<span class="hljs-keyword">System</span> altered.
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup
# <span class="hljs-number">5</span> 开启闪回
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database flashback <span class="hljs-keyword">on</span>;
Database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-开启所有PDB_37" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开启所有PDB</h3><blockquote data-block="0"><p data-block="0">如果是CDB环境，开启所有PDB</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">col name for a10
SQL&gt; select name,open_mode from v$pdbs;
NAME                           OPEN_MODE
------------------------------ ------------------------------
PDB$SEED                       READ ONLY
PDB1                           MOUNTED
PDB2                           MOUNTED
# 开启 PDB
SQL&gt; alter pluggable database all open;
Pluggable database altered.
# 查看

SQL&gt; select name,open_mode from v$pdbs;
NAME       OPEN_MODE
---------- ----------
PDB$SEED   READ ONLY
PDB1       READ WRITE
PDB2       READ WRITE
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;">col name <span class="hljs-keyword">for</span> a10
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> name,open_mode <span class="hljs-keyword">from</span> v$pdbs;
NAME                           OPEN_MODE
<span class="hljs-comment">------------------------------ ------------------------------</span>
PDB$SEED                       READ <span class="hljs-keyword">ONLY</span>
PDB1                           MOUNTED
PDB2                           MOUNTED
# 开启 PDB
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> pluggable database <span class="hljs-keyword">all</span> <span class="hljs-keyword">open</span>;
Pluggable database altered.
# 查看

<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> name,open_mode <span class="hljs-keyword">from</span> v$pdbs;
NAME       OPEN_MODE
<span class="hljs-comment">---------- ----------</span>
PDB$SEED   READ <span class="hljs-keyword">ONLY</span>
PDB1       READ WRITE
PDB2       READ WRITE
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-设置数据库强制归档_40" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>设置数据库强制归档</h3><blockquote data-block="0"><p data-block="0">有一些DDL语句可以通过指定NOLOGGING子句的方式避免写REDO(目的是提高速度，某些时候确实有效)。指定数据库为Force Logging模式后，数据库将会记录除临时表空间或临时回滚段外所有的操作，而忽略类似NOLOGGING之类的指定参数。如果在执行Force Logging时有NOLOGGING之类的语句在执行，那么Force Logging会等待，直到这类语句全部执行。</p><p data-block="0">Force Logging是作为固定参数保存在控制文件中，因此其不受重启之类操作的影响(只执行一次即可)，如果想取消，可以通过ALTER DATABASE NO FORCE LOGGING语句关闭强制记录。</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的
# 查看
SQL&gt; SELECT NAME, OPEN_MODE, FORCE_LOGGING FROM V$DATABASE;
NAME       OPEN_MODE            FORCE_LOGGING
---------- -------------------- ---------------------------------------
ORCL       READ WRITE           NO
# **开启强制归档**
SQL&gt; alter database force logging;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的
# 查看
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> NAME, OPEN_MODE, FORCE_LOGGING <span class="hljs-keyword">FROM</span> V$DATABASE;
NAME       OPEN_MODE            FORCE_LOGGING
<span class="hljs-comment">---------- -------------------- ---------------------------------------</span>
ORCL       READ WRITE           <span class="hljs-keyword">NO</span>
# <span class="hljs-operator">*</span><span class="hljs-operator">*</span>开启强制归档<span class="hljs-operator">*</span><span class="hljs-operator">*</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database force logging;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-添加Standby-redo-log_43" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>添加Standby redo log</h3><h4 data-block="0" class="vditor-ir__node" id="ir-说明-_44" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>说明：</h4><blockquote data-block="0"><p data-block="0">为主库添加standby redo log后，备库自动同步，所以备库不用再创建standby redo log
Data Guard在最大保护和最高可用性模式下，Standby数据库必须配置standby redo log</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-作用-_46" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>作用：</h4><blockquote data-block="0"><p data-block="0">实际上就是与主库接收到的重做日志相对应，也就是说备库调用RFS进程将主库接收到的重做日志按顺序导入到standby logfile
在主库创建Standby logfile是便于发生角色转换后备用</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-创建原则-_48" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>创建原则：</h4><blockquote data-block="0"><p data-block="0">确保Standby redo log的大小与主库online redo log的大小一致
如果主库为单实例数据库：Standby redo log组数=主库日志总数+1
如果主库是RAC数据库：Standby redo log组数=(每线程的日志数+1)*最大线程数
不建议复用Standby redo log，避免增加额外的I/O以及延缓重做传输</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的；
# 在Oracle 12c的架构里，online redo log 和控制文件是保存在CDB中的，PDB中只有运行需要的数据文件；  
# 所以如果是CDB下，就在CDB中加 Standby redo log。
# 1、查看组数=3
SQL&gt; select count(group#),thread# from v$log group by thread#;
COUNT(GROUP#)	THREAD#
------------	--------
3				1
# 2、大小=50M
SQL&gt; select group#,bytes/1024/1024 from v$log;
GROUP#	BYTES/1024/1024
------	---------------
1		50
2		50
3		50
# 3、创建standby logfile(3+1组、每组50M)
	#	注意路径大小写，本文部署CDB环境时，SID是大写的ORCL
SQL&gt; select * from v$standby_log;
alter database add standby logfile group 4 ('/u01/app/oracle/oradata/orcl/stantby_redo04.log') size 50m;
alter database add standby logfile group 5 ('/u01/app/oracle/oradata/orcl/stantby_redo05.log') size 50m;
alter database add standby logfile group 6 ('/u01/app/oracle/oradata/orcl/stantby_redo06.log') size 50m;
alter database add standby logfile group 7 ('/u01/app/oracle/oradata/orcl/stantby_redo07.log') size 50m;
# 4、验证查看
SQL&gt; select * from v$standby_log;
SQL&gt; select group#,bytes/1024/1024 from v$standby_log;
GROUP#  BYTES/1024/1024
----------   ---------------
4         50
5         50
6         50
7         50
SQL&gt; select group#,status,type,member from v$logfile;
GROUP# STATUS TYPE MEMBER
---------- ------- ------- ----------------------------------
3     ONLINE /u01/app/oracle/oradata/orcl/redo03.log
2     ONLINE /u01/app/oracle/oradata/orcl/redo02.log
1     ONLINE /u01/app/oracle/oradata/orcl/redo01.log
4     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo04.log
5     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo05.log
6     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo06.log
7     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo07.log
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的；
# 在Oracle <span class="hljs-number">12</span>c的架构里，online redo log 和控制文件是保存在CDB中的，PDB中只有运行需要的数据文件；  
# 所以如果是CDB下，就在CDB中加 Standby redo log。
# <span class="hljs-number">1</span>、查看组数<span class="hljs-operator">=</span><span class="hljs-number">3</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">group</span>#),thread# <span class="hljs-keyword">from</span> v$log <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> thread#;
<span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">GROUP</span>#)	THREAD#
<span class="hljs-comment">------------	--------</span>
<span class="hljs-number">3</span>				<span class="hljs-number">1</span>
# <span class="hljs-number">2</span>、大小<span class="hljs-operator">=</span><span class="hljs-number">50</span>M
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">group</span>#,bytes<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span> <span class="hljs-keyword">from</span> v$log;
<span class="hljs-keyword">GROUP</span>#	BYTES<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span>
<span class="hljs-comment">------	---------------</span>
<span class="hljs-number">1</span>		<span class="hljs-number">50</span>
<span class="hljs-number">2</span>		<span class="hljs-number">50</span>
<span class="hljs-number">3</span>		<span class="hljs-number">50</span>
# <span class="hljs-number">3</span>、创建standby logfile(<span class="hljs-number">3</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>组、每组<span class="hljs-number">50</span>M)
	#	注意路径大小写，本文部署CDB环境时，SID是大写的ORCL
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> v$standby_log;
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">add</span> standby logfile <span class="hljs-keyword">group</span> <span class="hljs-number">4</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/stantby_redo04.log'</span>) size <span class="hljs-number">50</span>m;
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">add</span> standby logfile <span class="hljs-keyword">group</span> <span class="hljs-number">5</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/stantby_redo05.log'</span>) size <span class="hljs-number">50</span>m;
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">add</span> standby logfile <span class="hljs-keyword">group</span> <span class="hljs-number">6</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/stantby_redo06.log'</span>) size <span class="hljs-number">50</span>m;
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">add</span> standby logfile <span class="hljs-keyword">group</span> <span class="hljs-number">7</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/stantby_redo07.log'</span>) size <span class="hljs-number">50</span>m;
# <span class="hljs-number">4</span>、验证查看
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> v$standby_log;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">group</span>#,bytes<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span> <span class="hljs-keyword">from</span> v$standby_log;
<span class="hljs-keyword">GROUP</span>#  BYTES<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span>
<span class="hljs-comment">----------   ---------------</span>
<span class="hljs-number">4</span>         <span class="hljs-number">50</span>
<span class="hljs-number">5</span>         <span class="hljs-number">50</span>
<span class="hljs-number">6</span>         <span class="hljs-number">50</span>
<span class="hljs-number">7</span>         <span class="hljs-number">50</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">group</span>#,status,type,<span class="hljs-keyword">member</span> <span class="hljs-keyword">from</span> v$logfile;
<span class="hljs-keyword">GROUP</span># STATUS TYPE <span class="hljs-keyword">MEMBER</span>
<span class="hljs-comment">---------- ------- ------- ----------------------------------</span>
<span class="hljs-number">3</span>     ONLINE <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>redo03.log
<span class="hljs-number">2</span>     ONLINE <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>redo02.log
<span class="hljs-number">1</span>     ONLINE <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>redo01.log
<span class="hljs-number">4</span>     STANDBY <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>stantby_redo04.log
<span class="hljs-number">5</span>     STANDBY <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>stantby_redo05.log
<span class="hljs-number">6</span>     STANDBY <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>stantby_redo06.log
<span class="hljs-number">7</span>     STANDBY <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>oradata<span class="hljs-operator">/</span>orcl<span class="hljs-operator">/</span>stantby_redo07.log
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-修改参数文件_51" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>修改参数文件</h3><h4 data-block="0" class="vditor-ir__node" id="ir-设置DB唯一名称_52" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置DB唯一名称</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 通常主库的DB名和唯一名相同,show参数查看
alter system set db_unique_name='orcl' scope=spfile;
# 其中dg_config填写的是主备库的db_unique_name
alter system set log_archive_config='DG_CONFIG=(orcl,orcldg)' scope=spfile;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 通常主库的DB名和唯一名相同,<span class="hljs-keyword">show</span>参数查看
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> db_unique_name<span class="hljs-operator">=</span><span class="hljs-string">'orcl'</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
# 其中dg_config填写的是主备库的db_unique_name
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_archive_config<span class="hljs-operator">=</span><span class="hljs-string">'DG_CONFIG=(orcl,orcldg)'</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-设置归档日志的路径_54" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置归档日志的路径</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​bash</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-bash"># =前后不能有空格，本地的archive路径没有修改，使用默认
alter system set log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST valid_for=(all_logfiles,all_roles) db_unique_name=orcl' scope=spfile;
alter system set log_archive_dest_2='SERVICE=ORCLDG ASYNC valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) db_unique_name=orcldg' scope=spfile;
# 第一个ORCLDG是备库tnsname.ora的连接名(最开头名称)
# 第二个orcldg是DB_UNIQUE_NAME
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-bash hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-comment"># =前后不能有空格，本地的archive路径没有修改，使用默认</span>
alter system <span class="hljs-built_in">set</span> log_archive_dest_1=<span class="hljs-string">'LOCATION=USE_DB_RECOVERY_FILE_DEST valid_for=(all_logfiles,all_roles) db_unique_name=orcl'</span> scope=spfile;
alter system <span class="hljs-built_in">set</span> log_archive_dest_2=<span class="hljs-string">'SERVICE=ORCLDG ASYNC valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) db_unique_name=orcldg'</span> scope=spfile;
<span class="hljs-comment"># 第一个ORCLDG是备库tnsname.ora的连接名(最开头名称)</span>
<span class="hljs-comment"># 第二个orcldg是DB_UNIQUE_NAME</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-启用设置的日志路径_56" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>启用设置的日志路径</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">alter system set log_archive_dest_state_1=enable scope=spfile;
alter system set log_archive_dest_state_2=enable scope=spfile;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_archive_dest_state_1<span class="hljs-operator">=</span>enable <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_archive_dest_state_2<span class="hljs-operator">=</span>enable <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-设置归档日志进程的最大数量_58" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置归档日志进程的最大数量</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">#（视实际情况调整）
alter system set log_archive_max_processes=30 scope=both;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;">#（视实际情况调整）
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_archive_max_processes<span class="hljs-operator">=</span><span class="hljs-number">30</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span><span class="hljs-keyword">both</span>;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-设置备库从哪个数据库获取归档日志_60" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置备库从哪个数据库获取归档日志</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 只对standby库有效，在主库上设置是为了在故障切换后，主库可以成为备库使用，值就是TNSNAME
# fal表示fetch archive log
# fal_client用于发送日志，fal_server用于接受日志。也即无论是主库或备库，fal_server=对方，fal_client=自己
alter system set fal_server=orcldg;
alter system set fal_client=orcl;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 只对standby库有效，在主库上设置是为了在故障切换后，主库可以成为备库使用，值就是TNSNAME
# fal表示<span class="hljs-keyword">fetch</span> archive log
# fal_client用于发送日志，fal_server用于接受日志。也即无论是主库或备库，fal_server<span class="hljs-operator">=</span>对方，fal_client<span class="hljs-operator">=</span>自己
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> fal_server<span class="hljs-operator">=</span>orcldg;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> fal_client<span class="hljs-operator">=</span>orcl;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-设置文件管理模式_62" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置文件管理模式</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 表示如果Primary数据库数据文件发生修改（如新建、重命名等）则按照本参数的设置在Standby数据库中作相应修改。
# 设为AUTO表示自动管理。设为MANUAL表示需要手工管理
# 此项设置为自动，不然在主库创建数据文件后，备库不会自动创建
alter system set standby_file_management=auto scope=spfile;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 表示如果<span class="hljs-keyword">Primary</span>数据库数据文件发生修改（如新建、重命名等）则按照本参数的设置在Standby数据库中作相应修改。
# 设为AUTO表示自动管理。设为MANUAL表示需要手工管理
# 此项设置为自动，不然在主库创建数据文件后，备库不会自动创建
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> standby_file_management<span class="hljs-operator">=</span>auto <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-主备文件路径_64" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>主备文件路径</h4><blockquote data-block="0"><p data-block="0">如果主备库文件的存放路径不同，还需要设置以下两个参数（需要重启数据库生效）</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 小写的orcl
alter system set db_file_name_convert='/u01/app/oracle/oradata/orcldg','/u01/app/oracle/oradata/orcl' scope=spfile;
alter system set log_file_name_convert='/u01/app/oracle/oradata/orcldg','/u01/app/oracle/oradata/orcl' scope=spfile;
# 大写的ORCL
alter system set db_file_name_convert='/u01/app/oracle/oradata/ORCLDG','/u01/app/oracle/oradata/ORCL' scope=spfile;
alter system set log_file_name_convert='/u01/app/oracle/oradata/ORCLDG','/u01/app/oracle/oradata/ORCL' scope=spfile;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 小写的orcl
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> db_file_name_convert<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/oradata/orcldg'</span>,<span class="hljs-string">'/u01/app/oracle/oradata/orcl'</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_file_name_convert<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/oradata/orcldg'</span>,<span class="hljs-string">'/u01/app/oracle/oradata/orcl'</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
# 大写的ORCL
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> db_file_name_convert<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/oradata/ORCLDG'</span>,<span class="hljs-string">'/u01/app/oracle/oradata/ORCL'</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_file_name_convert<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/oradata/ORCLDG'</span>,<span class="hljs-string">'/u01/app/oracle/oradata/ORCL'</span> <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-设置数据库口令文件的使用模式_67" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置数据库口令文件的使用模式</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; show parameter remote_login_passwordfile
NAME						TYPE		VALUE
-------------------------	------		---------
remote_login_passwordfile	string		EXCLUSIVE
# 默认也是EXCLUSIVE
alter system set remote_login_passwordfile=EXCLUSIVE scope=spfile;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">parameter</span> remote_login_passwordfile
NAME						TYPE		<span class="hljs-keyword">VALUE</span>
<span class="hljs-comment">-------------------------	------		---------</span>
remote_login_passwordfile	string		EXCLUSIVE
# 默认也是EXCLUSIVE
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> remote_login_passwordfile<span class="hljs-operator">=</span>EXCLUSIVE <span class="hljs-keyword">scope</span><span class="hljs-operator">=</span>spfile;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-设置默认监听_69" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>设置默认监听</h4><blockquote data-block="0"><p data-block="0">此处直接让监听为空即可保持后面创建的默认静态监听，否则备库无法从参数文件启动
或者如果想要设置监听值，也可以
alter system set local_listener='(DESCRIPTION =(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.2.2)(PORT=1521)))';</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; show parameter local_listener;
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
local_listener                       string      LISTENER_ORCL
alter system set local_listener='';
SQL&gt; show parameter local_listener;
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
local_listener                       string
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">parameter</span> local_listener;
NAME                                 TYPE        <span class="hljs-keyword">VALUE</span>
<span class="hljs-comment">------------------------------------ ----------- ------------------------------</span>
local_listener                       string      LISTENER_ORCL
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> local_listener<span class="hljs-operator">=</span><span class="hljs-string">''</span>;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">parameter</span> local_listener;
NAME                                 TYPE        <span class="hljs-keyword">VALUE</span>
<span class="hljs-comment">------------------------------------ ----------- ------------------------------</span>
local_listener                       string
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir-备库配置_72" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>备库配置</h2><h3 data-block="0" class="vditor-ir__node" id="ir-变量环境_73" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>变量环境</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sh</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sh">[oracle@klausdg ~]$ cat .bash_profile 
# .bash_profile
# Get the aliases and functions
if [ -f ~/.bashrc ]; then
    . ~/.bashrc
fi
# User specific environment and startup programs
PATH=$PATH:$HOME/.local/bin:$HOME/bin
export PATH
export EDITOR=vi
export ORACLE_SID=orcldg
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/12.1.0/dbhome_1
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib
export PATH=/u01/app/oracle/product/12.1.0/dbhome_1/bin:/bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/X11R6/bin
export PATH=$ORACLE_HOME/bin:$PATH
# 使变量生效
source ~/.bash_profile
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sh hljs bash vditor-linenumber" style="max-height: 1026px;">[oracle@klausdg ~]$ cat .bash_profile 
<span class="hljs-comment"># .bash_profile</span>
<span class="hljs-comment"># Get the aliases and functions</span>
<span class="hljs-keyword">if</span> [ -f ~/.bashrc ]; <span class="hljs-keyword">then</span>
    . ~/.bashrc
<span class="hljs-keyword">fi</span>
<span class="hljs-comment"># User specific environment and startup programs</span>
PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$HOME</span>/.<span class="hljs-built_in">local</span>/bin:<span class="hljs-variable">$HOME</span>/bin
<span class="hljs-built_in">export</span> PATH
<span class="hljs-built_in">export</span> EDITOR=vi
<span class="hljs-built_in">export</span> ORACLE_SID=orcldg
<span class="hljs-built_in">export</span> ORACLE_BASE=/u01/app/oracle
<span class="hljs-built_in">export</span> ORACLE_HOME=<span class="hljs-variable">$ORACLE_BASE</span>/product/12.1.0/dbhome_1
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$ORACLE_HOME</span>/lib:/usr/lib
<span class="hljs-built_in">export</span> PATH=/u01/app/oracle/product/12.1.0/dbhome_1/bin:/bin:/usr/bin:/usr/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/X11R6/bin
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$ORACLE_HOME</span>/bin:<span class="hljs-variable">$PATH</span>
<span class="hljs-comment"># 使变量生效</span>
<span class="hljs-built_in">source</span> ~/.bash_profile
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主备库密码文件_75" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主备库密码文件</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># Data Guard环境中，数据库的sys用户名密码要相同，可直接将主库复制密码文件复制到备库
# 拷贝后备库的密码文件格式：ora+sid，Windows下格式为：PWD[sid].ora
scp $ORACLE_HOME/dbs/orapworcl oracle@192.168.2.3:$ORACLE_HOME/dbs/orapworcldg
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> Data Guard环境中，数据库的sys用户名密码要相同，可直接将主库复制密码文件复制到备库</span>
<span class="hljs-meta">#</span><span class="bash"> 拷贝后备库的密码文件格式：ora+sid，Windows下格式为：PWD[sid].ora</span>
scp $ORACLE_HOME/dbs/orapworcl oracle@192.168.2.3:$ORACLE_HOME/dbs/orapworcldg
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-修改参数文件-_77" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>修改参数文件</h3><h4 data-block="0" class="vditor-ir__node" id="ir-复制主库参数文件_78" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>复制主库参数文件</h4><blockquote data-block="0"><p data-block="0">备库的参数文件根据主库参数进行修改
主库上创建pfile，然后拷贝给备库</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">SQL&gt; create pfile from spfile;
# 拷贝后的静态参数文件格式：init+sid.ora
$ scp $ORACLE_HOME/dbs/initorcl.ora oracle@192.168.2.3:$ORACLE_HOME/dbs/initorcldg.ora
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">SQL&gt;</span><span class="bash"> create pfile from spfile;</span>
<span class="hljs-meta">#</span><span class="bash"> 拷贝后的静态参数文件格式：init+sid.ora</span>
<span class="hljs-meta">$</span><span class="bash"> scp <span class="hljs-variable">$ORACLE_HOME</span>/dbs/initorcl.ora oracle@192.168.2.3:<span class="hljs-variable">$ORACLE_HOME</span>/dbs/initorcldg.ora</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-修改initorcldg-ora内容_81" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>修改initorcldg.ora内容</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​bash</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-bash">orcl.__data_transfer_cache_size=0
orcl.__db_cache_size=1761607680
orcl.__java_pool_size=16777216
orcl.__large_pool_size=33554432
orcl.__oracle_base='/u01/app/oracle'#ORACLE_BASE set from environment
orcl.__pga_aggregate_target=822083584
orcl.__sga_target=2466250752
orcl.__shared_io_pool_size=117440512
orcl.__shared_pool_size=520093696
orcl.__streams_pool_size=0
# 修改为备库的orcldg
*.audit_file_dest='/u01/app/oracle/admin/orcldg/adump'
*.audit_trail='db'
*.compatible='12.1.0.2.0'
*.control_file_record_keep_time=19
# 修改为备库的orcldg
*.control_files='/u01/app/oracle/oradata/orcldg/control01.ctl' #Restore Controlfile
*.db_block_size=8192
*.db_domain=''
# 修改顺序主备路径和主库的相反
*.db_file_name_convert='/u01/app/oracle/oradata/orcl','/u01/app/oracle/oradata/orcldg'
# 实例名相同
*.db_name='orcl'
# 修改实例唯一名
*.db_unique_name='orcldg'
*.db_recovery_file_dest='/u01/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=4560m
*.diagnostic_dest='/u01/app/oracle'
# 修改orcldgXDB
*.dispatchers='(PROTOCOL=TCP) (SERVICE=orcldgXDB)'
# 和主库配置顺序相反
*.fal_client='ORCLDG'
*.fal_server='ORCL'
# 使用默认监听
*.local_listener=''
# 和主库配置相同
*.log_archive_config='DG_CONFIG=(orcl,orcldg)'
# 修改为本库(备库)的唯一名
*.log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST valid_for=(all_logfiles,all_roles) db_unique_name=ocrldg'
# 服务名修改为连接主库TNS的ORCL，DB唯一名修改为主库的orcl
*.log_archive_dest_2='SERVICE=ORCL LGWR ASYNC valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) db_unique_name=orcl'
*.log_archive_dest_state_1='ENABLE'
*.log_archive_dest_state_2='ENABLE'
*.log_archive_max_processes=30
# 和主库配置相反
*.log_file_name_convert='/u01/app/oracle/oradata/orcl','/u01/app/oracle/oradata/orcldg'
*.nls_date_format='yyyy-mm-dd hh24:mi:ss'
*.open_cursors=300
*.pga_aggregate_target=780m
*.processes=300
*.remote_login_passwordfile='EXCLUSIVE'
*.sga_target=2341m
*.standby_file_management='AUTO'
*.undo_tablespace='UNDOTBS1'
*.utl_file_dir='/home/oracle/logmnr'
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-bash hljs vditor-linenumber" style="max-height: 1026px;">orcl.__data_transfer_cache_size=0
orcl.__db_cache_size=1761607680
orcl.__java_pool_size=16777216
orcl.__large_pool_size=33554432
orcl.__oracle_base=<span class="hljs-string">'/u01/app/oracle'</span><span class="hljs-comment">#ORACLE_BASE set from environment</span>
orcl.__pga_aggregate_target=822083584
orcl.__sga_target=2466250752
orcl.__shared_io_pool_size=117440512
orcl.__shared_pool_size=520093696
orcl.__streams_pool_size=0
<span class="hljs-comment"># 修改为备库的orcldg</span>
*.audit_file_dest=<span class="hljs-string">'/u01/app/oracle/admin/orcldg/adump'</span>
*.audit_trail=<span class="hljs-string">'db'</span>
*.compatible=<span class="hljs-string">'12.1.0.2.0'</span>
*.control_file_record_keep_time=19
<span class="hljs-comment"># 修改为备库的orcldg</span>
*.control_files=<span class="hljs-string">'/u01/app/oracle/oradata/orcldg/control01.ctl'</span> <span class="hljs-comment">#Restore Controlfile</span>
*.db_block_size=8192
*.db_domain=<span class="hljs-string">''</span>
<span class="hljs-comment"># 修改顺序主备路径和主库的相反</span>
*.db_file_name_convert=<span class="hljs-string">'/u01/app/oracle/oradata/orcl'</span>,<span class="hljs-string">'/u01/app/oracle/oradata/orcldg'</span>
<span class="hljs-comment"># 实例名相同</span>
*.db_name=<span class="hljs-string">'orcl'</span>
<span class="hljs-comment"># 修改实例唯一名</span>
*.db_unique_name=<span class="hljs-string">'orcldg'</span>
*.db_recovery_file_dest=<span class="hljs-string">'/u01/app/oracle/fast_recovery_area'</span>
*.db_recovery_file_dest_size=4560m
*.diagnostic_dest=<span class="hljs-string">'/u01/app/oracle'</span>
<span class="hljs-comment"># 修改orcldgXDB</span>
*.dispatchers=<span class="hljs-string">'(PROTOCOL=TCP) (SERVICE=orcldgXDB)'</span>
<span class="hljs-comment"># 和主库配置顺序相反</span>
*.fal_client=<span class="hljs-string">'ORCLDG'</span>
*.fal_server=<span class="hljs-string">'ORCL'</span>
<span class="hljs-comment"># 使用默认监听</span>
*.local_listener=<span class="hljs-string">''</span>
<span class="hljs-comment"># 和主库配置相同</span>
*.log_archive_config=<span class="hljs-string">'DG_CONFIG=(orcl,orcldg)'</span>
<span class="hljs-comment"># 修改为本库(备库)的唯一名</span>
*.log_archive_dest_1=<span class="hljs-string">'LOCATION=USE_DB_RECOVERY_FILE_DEST valid_for=(all_logfiles,all_roles) db_unique_name=ocrldg'</span>
<span class="hljs-comment"># 服务名修改为连接主库TNS的ORCL，DB唯一名修改为主库的orcl</span>
*.log_archive_dest_2=<span class="hljs-string">'SERVICE=ORCL LGWR ASYNC valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) db_unique_name=orcl'</span>
*.log_archive_dest_state_1=<span class="hljs-string">'ENABLE'</span>
*.log_archive_dest_state_2=<span class="hljs-string">'ENABLE'</span>
*.log_archive_max_processes=30
<span class="hljs-comment"># 和主库配置相反</span>
*.log_file_name_convert=<span class="hljs-string">'/u01/app/oracle/oradata/orcl'</span>,<span class="hljs-string">'/u01/app/oracle/oradata/orcldg'</span>
*.nls_date_format=<span class="hljs-string">'yyyy-mm-dd hh24:mi:ss'</span>
*.open_cursors=300
*.pga_aggregate_target=780m
*.processes=300
*.remote_login_passwordfile=<span class="hljs-string">'EXCLUSIVE'</span>
*.sga_target=2341m
*.standby_file_management=<span class="hljs-string">'AUTO'</span>
*.undo_tablespace=<span class="hljs-string">'UNDOTBS1'</span>
*.utl_file_dir=<span class="hljs-string">'/home/oracle/logmnr'</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库创建spfile_83" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库创建spfile</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; create spfile from pfile;
File created.
SQL&gt; 
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> spfile <span class="hljs-keyword">from</span> pfile;
File created.
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> 
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-创建备库所需路径_85" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>创建备库所需路径</h3><blockquote data-block="0"><p data-block="0">Oracle建议一般控制文件至少三个，放在不同的地方，本文主库没有设置
如果主库修改相关文件目录，拷贝过来的参数文件修改后也需要在备库中创建相关目录</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​bash</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-bash"># 每个人的环境不同，根据备库参数文件创建所需目录
mkdir -p /u01/app/oracle/admin/orcldg/adump
mkdir -p /u01/app/oracle/oradata/orcldg			#根据情况是否大写	mkdir -p /u01/app/oracle/oradata/ORCLDG
mkdir -p /u01/app/oracle/fast_recovery_area
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-bash hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-comment"># 每个人的环境不同，根据备库参数文件创建所需目录</span>
mkdir -p /u01/app/oracle/admin/orcldg/adump
mkdir -p /u01/app/oracle/oradata/orcldg			<span class="hljs-comment">#根据情况是否大写	mkdir -p /u01/app/oracle/oradata/ORCLDG</span>
mkdir -p /u01/app/oracle/fast_recovery_area
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir-主备库监听_88" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>主备库监听</h2><h3 data-block="0" class="vditor-ir__node" id="ir-开机自启动监听_89" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开机自启动监听</h3><blockquote data-block="0"><p data-block="0">设置主备库自动开启监听
不建议设置自动开启数据库,因为DG开关有先后顺序，要手动开启</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">## 修改/etc/rc.d/rc.local文件
su - root
\# vi /etc/rc.d/rc.local			# 增加一行(/etc/rc.local是/etc/rc.d/rc.local的软连接)
su - oracle -c 'lsnrctl start'
## 授权rc.local文件可执行权限
\# chmod +x /etc/rc.d/rc.local
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment"># 修改/etc/rc.d/rc.local文件</span></span>
su - root
\# vi /etc/rc.d/rc.local			# 增加一行(/etc/rc.local是/etc/rc.d/rc.local的软连接)
su - oracle -c 'lsnrctl start'
<span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment"># 授权rc.local文件可执行权限</span></span>
\# chmod +x /etc/rc.d/rc.local
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主库注册静态监听_92" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主库注册静态监听</h3><blockquote data-block="0"><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 静态注册的参数概念：
GLOBAL_DBNAME	:数据库服务名，默认和SID_NAME保持一致。在本例中这里需要填写PDB的服务名。
ORACLE_HOME		:实例运行的ORACLE_HOME目录，如果是集群环境这里也填写ORACLE的ORACLE_HOME目录。
SID_NAME		:数据库实例名。和数据库参数INSTANCE_NAME一致。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 静态注册的参数概念：
GLOBAL_DBNAME	:数据库服务名，默认和SID_NAME保持一致。在本例中这里需要填写PDB的服务名。
ORACLE_HOME		:实例运行的ORACLE_HOME目录，如果是集群环境这里也填写ORACLE的ORACLE_HOME目录。
SID_NAME		:数据库实例名。和数据库参数INSTANCE_NAME一致。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><p data-block="0">使用Net Manager创建监听不容易出错，添加 Database Services，客户端如果没有添加hosts信息或DNS建议写IP
如果是CDB环境，监听也是相同静态配置即可，无需配置PDB监听或TNS</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">[oracle@klaus admin]$ cat listener.ora 
# listener.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcl)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = orcl)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.2)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;">[oracle@klaus admin]$ cat listener.ora 
<span class="hljs-meta">#</span><span class="bash"> listener.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_1/network/admin/listener.ora</span>
<span class="hljs-meta">#</span><span class="bash"> Generated by Oracle configuration tools.</span>

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcl)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = orcl)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.2)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库注册静态监听_95" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库注册静态监听</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">[oracle@klausdg admin]$ cat listener.ora
# listener.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcldg)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = orcldg)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.3)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;">[oracle@klausdg admin]$ cat listener.ora
<span class="hljs-meta">#</span><span class="bash"> listener.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_1/network/admin/listener.ora</span>
<span class="hljs-meta">#</span><span class="bash"> Generated by Oracle configuration tools.</span>

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcldg)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = orcldg)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.3)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主备库TNS监听相同_97" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主备库TNS监听相同</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">[oracle@klausdg admin]$ cat tnsnames.ora
# tnsnames.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_1/network/admin/tnsnames.ora
# Generated by Oracle configuration tools.

ORCLDG =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.3)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcldg)
    )
  )

ORCL =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.2)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;">[oracle@klausdg admin]$ cat tnsnames.ora
<span class="hljs-meta">#</span><span class="bash"> tnsnames.ora Network Configuration File: /u01/app/oracle/product/12.1.0/dbhome_1/network/admin/tnsnames.ora</span>
<span class="hljs-meta">#</span><span class="bash"> Generated by Oracle configuration tools.</span>

ORCLDG =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.3)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcldg)
    )
  )

ORCL =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.2)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主备连接测试_99" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主备连接测试</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># 主备库监听重启
lsnrctl stop
lsnrctl start
# 主备测试
tnsping orcl
tnsping orcldg
# 测试登录 #
# 主库登陆 在密码文件拷贝后才可以登陆
[oracle@klaus ~]$ sqlplus sys/Oracle#2020@orcl as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:45:02 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
SQL&gt;
[oracle@klaus ~]$ sqlplus sys/Oracle#2020@orcldg as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:45:56 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to an idle instance.
SQL&gt;
# 备库登录
[oracle@klausdg ~]$ sqlplus sys/Oracle#2020@orcl as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:47:24 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
SQL&gt;
[oracle@klausdg ~]$ sqlplus sys/Oracle#2020@orcldg as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:47:58 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to an idle instance.
SQL&gt;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> 主备库监听重启</span>
lsnrctl stop
lsnrctl start
<span class="hljs-meta">#</span><span class="bash"> 主备测试</span>
tnsping orcl
tnsping orcldg
<span class="hljs-meta">#</span><span class="bash"> 测试登录 <span class="hljs-comment">#</span></span>
<span class="hljs-meta">#</span><span class="bash"> 主库登陆 在密码文件拷贝后才可以登陆</span>
[oracle@klaus ~]$ sqlplus sys/Oracle#2020@orcl as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:45:02 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
<span class="hljs-meta">SQL&gt;</span><span class="bash">
[oracle@klaus ~]$ sqlplus sys/Oracle<span class="hljs-comment">#2020@orcldg as sysdba</span></span>
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:45:56 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to an idle instance.
<span class="hljs-meta">SQL&gt;</span><span class="bash">
<span class="hljs-comment"># 备库登录</span></span>
[oracle@klausdg ~]$ sqlplus sys/Oracle#2020@orcl as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:47:24 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
<span class="hljs-meta">SQL&gt;</span><span class="bash">
[oracle@klausdg ~]$ sqlplus sys/Oracle<span class="hljs-comment">#2020@orcldg as sysdba</span></span>
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:47:58 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to an idle instance.
<span class="hljs-meta">SQL&gt;</span><span class="bash">
</span><div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir--方式一-物理备库之RMAN-Duplicate-_101" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>【方式一：物理备库之RMAN Duplicate】</h2><blockquote data-block="0"><p data-block="0">Duplicate  方式创建物理备库；通过这种方式直接在线从主库搭建物理备库。
本次实验：Non-CDB环境</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-备库启动到nomount状态_103" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库启动到nomount状态</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 使用pfile启动到nomount
[oracle@klausdg ~]$ sqlplus /  as sysdba
SQL&gt; startup nomount pfile='/u01/app/oracle/product/12.1.0/dbhome_1/dbs/initorcldg.ora';
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
# 创建Spfile
SQL&gt; create spfile from pfile;
SQL&gt; shutdown immediate;
# 启动到nomount
SQL&gt; startup nomount
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 使用pfile启动到nomount
[oracle<span class="hljs-variable">@klausdg</span> <span class="hljs-operator">~</span>]$ sqlplus <span class="hljs-operator">/</span>  <span class="hljs-keyword">as</span> sysdba
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup nomount pfile<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/product/12.1.0/dbhome_1/dbs/initorcldg.ora'</span>;
ORACLE instance started.
Total <span class="hljs-keyword">System</span> <span class="hljs-keyword">Global</span> Area <span class="hljs-number">2466250752</span> bytes
Fixed Size                  <span class="hljs-number">2927384</span> bytes
Variable Size             <span class="hljs-number">671089896</span> bytes
Database Buffers         <span class="hljs-number">1778384896</span> bytes
Redo Buffers               <span class="hljs-number">13848576</span> bytes
# 创建Spfile
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> spfile <span class="hljs-keyword">from</span> pfile;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate;
# 启动到nomount
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup nomount
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-登陆RMAN连接主备库_105" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>登陆RMAN连接主备库</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库target/orcl 备库auxiliary/orcldg
# 主备库DB_NAME必须一致，主库是open状态，备库是nomount状态
[oracle@klausdg ~]$ rman target sys/Oracle#2020@orcl auxiliary sys/Oracle#2020@orcldg
Recovery Manager: Release 12.1.0.2.0 - Production on Mon Aug 16 16:54:46 2021
Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.
connected to target database: ORCL (DBID=1576583420)
connected to auxiliary database: ORCL (not mounted)
RMAN&gt; 
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库target<span class="hljs-operator">/</span>orcl 备库auxiliary<span class="hljs-operator">/</span>orcldg
# 主备库DB_NAME必须一致，主库是<span class="hljs-keyword">open</span>状态，备库是nomount状态
[oracle<span class="hljs-variable">@klausdg</span> <span class="hljs-operator">~</span>]$ rman target sys<span class="hljs-operator">/</span>Oracle#<span class="hljs-number">2020</span><span class="hljs-variable">@orcl</span> auxiliary sys<span class="hljs-operator">/</span>Oracle#<span class="hljs-number">2020</span><span class="hljs-variable">@orcldg</span>
Recovery Manager: <span class="hljs-keyword">Release</span> <span class="hljs-number">12.1</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span> <span class="hljs-operator">-</span> Production <span class="hljs-keyword">on</span> Mon Aug <span class="hljs-number">16</span> <span class="hljs-number">16</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> <span class="hljs-number">2021</span>
Copyright (c) <span class="hljs-number">1982</span>, <span class="hljs-number">2014</span>, Oracle <span class="hljs-keyword">and</span><span class="hljs-operator">/</span><span class="hljs-keyword">or</span> its affiliates.  <span class="hljs-keyword">All</span> rights reserved.
connected <span class="hljs-keyword">to</span> target database: ORCL (DBID<span class="hljs-operator">=</span><span class="hljs-number">1576583420</span>)
connected <span class="hljs-keyword">to</span> auxiliary database: ORCL (<span class="hljs-keyword">not</span> mounted)
RMAN<span class="hljs-operator">&gt;</span> 
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-开始-Duplicate_107" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开始 Duplicate</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">RMAN&gt; duplicate target database for standby from active database dorecover nofilenamecheck;
# 执行过程（略）
Starting Duplicate Db at 16-AUG-21
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=243 device type=DISK
current log archived
...
....
.....
media recovery complete, elapsed time: 00:00:01
Finished recover at 16-AUG-21
Finished Duplicate Db at 16-AUG-21
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;">RMAN<span class="hljs-operator">&gt;</span> duplicate target database <span class="hljs-keyword">for</span> standby <span class="hljs-keyword">from</span> active database dorecover nofilenamecheck;
# 执行过程（略）
Starting Duplicate Db <span class="hljs-keyword">at</span> <span class="hljs-number">16</span><span class="hljs-operator">-</span>AUG<span class="hljs-number">-21</span>
<span class="hljs-keyword">using</span> target database control file instead <span class="hljs-keyword">of</span> recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID<span class="hljs-operator">=</span><span class="hljs-number">243</span> device type<span class="hljs-operator">=</span>DISK
<span class="hljs-keyword">current</span> log archived
...
....
.....
media recovery complete, elapsed <span class="hljs-type">time</span>: <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>
Finished recover <span class="hljs-keyword">at</span> <span class="hljs-number">16</span><span class="hljs-operator">-</span>AUG<span class="hljs-number">-21</span>
Finished Duplicate Db <span class="hljs-keyword">at</span> <span class="hljs-number">16</span><span class="hljs-operator">-</span>AUG<span class="hljs-number">-21</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir--方式二-物理备库之RMAN备份还原-_109" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>【方式二：物理备库之RMAN备份还原】</h2><blockquote data-block="0"><p data-block="0">使用  RMAN  备份恢复方法，将备份的文件和控制文件传到备库恢复
本次实验：Non-CDB环境</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-主库RMAN全备_111" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主库RMAN全备</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># 创建RMAN备份路径
mkdir -p /u01/rmanbackup
# RMAN备份
$ rman target /
RMAN&gt; backup database format='/u01/rmanbackup/FULL_%d_%T_%s.dbf';
Starting backup at 18-AUG-21
using target database control file instead of recovery catalog
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=19 device type=DISK
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
input datafile file number=00001 name=/u01/app/oracle/oradata/orcl/system01.dbf
input datafile file number=00003 name=/u01/app/oracle/oradata/orcl/sysaux01.dbf
input datafile file number=00004 name=/u01/app/oracle/oradata/orcl/undotbs01.dbf
input datafile file number=00005 name=/u01/app/oracle/oradata/orcl/test.dbf
input datafile file number=00006 name=/u01/app/oracle/oradata/orcl/users01.dbf
channel ORA_DISK_1: starting piece 1 at 18-AUG-21
channel ORA_DISK_1: finished piece 1 at 18-AUG-21
piece handle=/u01/rmanbackup/FULL_ORCL_20210818_1.dbf tag=TAG20210818T220447 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:01:25
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
including current control file in backup set
including current SPFILE in backup set
channel ORA_DISK_1: starting piece 1 at 18-AUG-21
channel ORA_DISK_1: finished piece 1 at 18-AUG-21
piece handle=/u01/rmanbackup/FULL_ORCL_20210818_2.dbf tag=TAG20210818T220447 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:01
Finished backup at 18-AUG-21
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> 创建RMAN备份路径</span>
mkdir -p /u01/rmanbackup
<span class="hljs-meta">#</span><span class="bash"> RMAN备份</span>
<span class="hljs-meta">$</span><span class="bash"> rman target /</span>
<span class="hljs-meta">RMAN&gt;</span><span class="bash"> backup database format=<span class="hljs-string">'/u01/rmanbackup/FULL_%d_%T_%s.dbf'</span>;</span>
Starting backup at 18-AUG-21
using target database control file instead of recovery catalog
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=19 device type=DISK
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
input datafile file number=00001 name=/u01/app/oracle/oradata/orcl/system01.dbf
input datafile file number=00003 name=/u01/app/oracle/oradata/orcl/sysaux01.dbf
input datafile file number=00004 name=/u01/app/oracle/oradata/orcl/undotbs01.dbf
input datafile file number=00005 name=/u01/app/oracle/oradata/orcl/test.dbf
input datafile file number=00006 name=/u01/app/oracle/oradata/orcl/users01.dbf
channel ORA_DISK_1: starting piece 1 at 18-AUG-21
channel ORA_DISK_1: finished piece 1 at 18-AUG-21
piece handle=/u01/rmanbackup/FULL_ORCL_20210818_1.dbf tag=TAG20210818T220447 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:01:25
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
including current control file in backup set
including current SPFILE in backup set
channel ORA_DISK_1: starting piece 1 at 18-AUG-21
channel ORA_DISK_1: finished piece 1 at 18-AUG-21
piece handle=/u01/rmanbackup/FULL_ORCL_20210818_2.dbf tag=TAG20210818T220447 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:01
Finished backup at 18-AUG-21
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主库备份控制文件_113" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主库备份控制文件</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">RMAN&gt; backup current controlfile for standby format '/u01/rmanbackup/control.bak';
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">RMAN&gt;</span><span class="bash"> backup current controlfile <span class="hljs-keyword">for</span> standby format <span class="hljs-string">'/u01/rmanbackup/control.bak'</span>;</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-拷贝备份文件到备库_115" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>拷贝备份文件到备库</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># 创建和主库相同的路径
mkdir -p /u01/rmanbackup
[oracle@klaus ~]$ cd /u01/rmanbackup/
[oracle@klaus rmanbackup]$ ls
control.bak  FULL_ORCL_20210818_1  FULL_ORCL_20210818_2
# 传输文件到备库改路径下
[oracle@klaus rmanbackup]$ scp /u01/rmanbackup/* oracle@192.168.2.3:/u01/rmanbackup
oracle@192.168.2.3's password: 
control.bak					100% 9888KB  36.6MB/s   00:00  
FULL_ORCL_20210818_1.dbf	100% 1299MB  51.9MB/s   00:25  
FULL_ORCL_20210818_2.dbf	100% 9920KB  18.0MB/s   00:00  
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> 创建和主库相同的路径</span>
mkdir -p /u01/rmanbackup
[oracle@klaus ~]$ cd /u01/rmanbackup/
[oracle@klaus rmanbackup]$ ls
control.bak  FULL_ORCL_20210818_1  FULL_ORCL_20210818_2
<span class="hljs-meta">#</span><span class="bash"> 传输文件到备库改路径下</span>
[oracle@klaus rmanbackup]$ scp /u01/rmanbackup/* oracle@192.168.2.3:/u01/rmanbackup
oracle@192.168.2.3's password: 
control.bak					100% 9888KB  36.6MB/s   00:00  
FULL_ORCL_20210818_1.dbf	100% 1299MB  51.9MB/s   00:25  
FULL_ORCL_20210818_2.dbf	100% 9920KB  18.0MB/s   00:00  
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库启动到nomount状态-_117" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库启动到nomount状态</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 使用pfile启动到nomount
# 如果已经创建spfile可以直接启动到 nomount状态
[oracle@klausdg ~]$ echo $ORACLE_SID
orcldg
[oracle@klausdg ~]$ sqlplus / as sysdba
# 启动
SQL&gt; startup nomount pfile='/u01/app/oracle/product/12.1.0/dbhome_1/dbs/initorcldg.ora';
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
# 创建Spfile
SQL&gt; create spfile from pfile;
SQL&gt; shutdown immediate;
# 启动到nomount
SQL&gt; startup nomount
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 使用pfile启动到nomount
# 如果已经创建spfile可以直接启动到 nomount状态
[oracle<span class="hljs-variable">@klausdg</span> <span class="hljs-operator">~</span>]$ echo $ORACLE_SID
orcldg
[oracle<span class="hljs-variable">@klausdg</span> <span class="hljs-operator">~</span>]$ sqlplus <span class="hljs-operator">/</span> <span class="hljs-keyword">as</span> sysdba
# 启动
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup nomount pfile<span class="hljs-operator">=</span><span class="hljs-string">'/u01/app/oracle/product/12.1.0/dbhome_1/dbs/initorcldg.ora'</span>;
ORACLE instance started.
Total <span class="hljs-keyword">System</span> <span class="hljs-keyword">Global</span> Area <span class="hljs-number">2466250752</span> bytes
Fixed Size                  <span class="hljs-number">2927384</span> bytes
Variable Size             <span class="hljs-number">671089896</span> bytes
Database Buffers         <span class="hljs-number">1778384896</span> bytes
Redo Buffers               <span class="hljs-number">13848576</span> bytes
# 创建Spfile
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> spfile <span class="hljs-keyword">from</span> pfile;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate;
# 启动到nomount
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup nomount
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库恢复控制文件_119" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库恢复控制文件</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">[oracle@klausdg ~]$ rman target /
RMAN&gt; restore standby controlfile from '/u01/rmanbackup/control.bak';
..
...
Finished restore at 18-AUG-21
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;">[oracle@klausdg ~]$ rman target /
<span class="hljs-meta">RMAN&gt;</span><span class="bash"> restore standby controlfile from <span class="hljs-string">'/u01/rmanbackup/control.bak'</span>;</span>
..
...
Finished restore at 18-AUG-21
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库mount_121" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库mount</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; alter database mount;
Database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database mount;
Database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-还原数据库_123" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>还原数据库</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">RMAN&gt; restore database;
Starting restore at 19-AUG-21
released channel: ORA_DISK_1
Starting implicit crosscheck backup at 19-AUG-21
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=355 device type=DISK
Crosschecked 2 objects
Finished implicit crosscheck backup at 19-AUG-21
Starting implicit crosscheck copy at 19-AUG-21
using channel ORA_DISK_1
Crosschecked 2 objects
Finished implicit crosscheck copy at 19-AUG-21
searching for all files in the recovery area
cataloging files...
no files cataloged
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile backup set restore
channel ORA_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_DISK_1: restoring datafile 00001 to /u01/app/oracle/oradata/orcldg/system01.dbf
channel ORA_DISK_1: restoring datafile 00003 to /u01/app/oracle/oradata/orcldg/sysaux01.dbf
channel ORA_DISK_1: restoring datafile 00004 to /u01/app/oracle/oradata/orcldg/undotbs01.dbf
channel ORA_DISK_1: restoring datafile 00005 to /u01/app/oracle/oradata/orcldg/test.dbf
channel ORA_DISK_1: restoring datafile 00006 to /u01/app/oracle/oradata/orcldg/users01.dbf
channel ORA_DISK_1: reading from backup piece /u01/rmanbackup/FULL_ORCL_20210818_1.dbf
channel ORA_DISK_1: piece handle=/u01/rmanbackup/FULL_ORCL_20210818_1.dbf tag=TAG20210818T235901
channel ORA_DISK_1: restored backup piece 1
channel ORA_DISK_1: restore complete, elapsed time: 00:00:35
Finished restore at 19-AUG-21

</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">RMAN&gt;</span><span class="bash"> restore database;</span>
Starting restore at 19-AUG-21
released channel: ORA_DISK_1
Starting implicit crosscheck backup at 19-AUG-21
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=355 device type=DISK
Crosschecked 2 objects
Finished implicit crosscheck backup at 19-AUG-21
Starting implicit crosscheck copy at 19-AUG-21
using channel ORA_DISK_1
Crosschecked 2 objects
Finished implicit crosscheck copy at 19-AUG-21
searching for all files in the recovery area
cataloging files...
no files cataloged
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile backup set restore
channel ORA_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_DISK_1: restoring datafile 00001 to /u01/app/oracle/oradata/orcldg/system01.dbf
channel ORA_DISK_1: restoring datafile 00003 to /u01/app/oracle/oradata/orcldg/sysaux01.dbf
channel ORA_DISK_1: restoring datafile 00004 to /u01/app/oracle/oradata/orcldg/undotbs01.dbf
channel ORA_DISK_1: restoring datafile 00005 to /u01/app/oracle/oradata/orcldg/test.dbf
channel ORA_DISK_1: restoring datafile 00006 to /u01/app/oracle/oradata/orcldg/users01.dbf
channel ORA_DISK_1: reading from backup piece /u01/rmanbackup/FULL_ORCL_20210818_1.dbf
channel ORA_DISK_1: piece handle=/u01/rmanbackup/FULL_ORCL_20210818_1.dbf tag=TAG20210818T235901
channel ORA_DISK_1: restored backup piece 1
channel ORA_DISK_1: restore complete, elapsed time: 00:00:35
Finished restore at 19-AUG-21

<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir--方式三-物理备库之CDB下的DBCA-_125" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>【方式三：物理备库之CDB下的DBCA】</h2><h3 data-block="0" class="vditor-ir__node" id="ir-DBCA备库说明_126" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>DBCA备库说明</h3><blockquote data-block="0"><p data-block="0">前两个物理备库方式都是基于Non-CDB创建DG的，也可以在CDB下通过Duplicate或RMAN备份还原的方法创建DG，配置主备库的条件相同，处于CDB状态下设置主库的配置即可；
到 12cR2 (12.2.0.1)后，新增  DBCA  方式直接建立物理备库的方法。但是对版本和实例环境有一定限制条件：
<span data-type="strong" class="vditor-ir__node"><span class="vditor-ir__marker vditor-ir__marker--bi">**</span><strong data-newline="1">12cR2中:</strong><span class="vditor-ir__marker vditor-ir__marker--bi">**</span></span></p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、12cR2 主库必须是单机环境，非 RAC 数据库；
# 若主库是 RAC 数据库，错误如下：
[FATAL] [DBT-16056] Specified primary database is not a Single Instance (SI) database.
CAUSE: Duplicate database operation is supported only for SI databases.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、<span class="hljs-number">12</span>cR2 主库必须是单机环境，非 RAC 数据库；
# 若主库是 RAC 数据库，错误如下：
[FATAL] [DBT<span class="hljs-number">-16056</span>] Specified <span class="hljs-keyword">primary</span> database <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> a Single Instance (SI) database.
CAUSE: Duplicate database operation <span class="hljs-keyword">is</span> supported <span class="hljs-keyword">only</span> <span class="hljs-keyword">for</span> SI databases.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 2、12cR2 主库必须是非 CDB 环境；
# 若主库是 CDB 环境，错误如下：
[FATAL] [DBT-16057] Specified primary database is a container database (CDB).
CAUSE: Duplicate database operation is supported only for non container databases.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">2</span>、<span class="hljs-number">12</span>cR2 主库必须是非 CDB 环境；
# 若主库是 CDB 环境，错误如下：
[FATAL] [DBT<span class="hljs-number">-16057</span>] Specified <span class="hljs-keyword">primary</span> database <span class="hljs-keyword">is</span> a container database (CDB).
CAUSE: Duplicate database operation <span class="hljs-keyword">is</span> supported <span class="hljs-keyword">only</span> <span class="hljs-keyword">for</span> non container databases.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><p data-block="0"><span data-type="strong" class="vditor-ir__node"><span class="vditor-ir__marker vditor-ir__marker--bi">**</span><strong data-newline="1">18c 及以后:</strong><span class="vditor-ir__marker vditor-ir__marker--bi">**</span></span>
18c(12.2.0.2)开始，这些限制条件已经取消，即主库是 CDB 或 RAC环境都可以通过 dbca 来创建物理备库
本节DBCA备库环境：<span data-type="html-inline" class="vditor-ir__node"><code class="vditor-ir__marker">&lt;a&gt;</code></span> &lt;font color=dark style="font-weight:bold" size=4&gt;19c的CDB环境<span data-type="html-inline" class="vditor-ir__node"><code class="vditor-ir__marker">&lt;/font&gt;</code></span><span data-type="html-inline" class="vditor-ir__node"><code class="vditor-ir__marker">&lt;/a&gt;</code></span>，主/备库的环境和前面的配置方法相同</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-配置Hosts_128" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>配置Hosts</h3><blockquote data-block="0"><p data-block="0">在没有DNS的配置下，需要配置Hosts，否则DBCA过程通讯报错：
ORA-17627：TNS：could not resolve connect identifier specified
#\	cat /etc/hosts
192.168.2.2	klaus
192.168.2.3	klausdg</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-DBCA过程_130" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>DBCA过程</h3><h4 data-block="0" class="vditor-ir__node" id="ir-主库开启_131" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>主库开启</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 如果是CDB环境，先开启数据库也要开启PDB
SQL&gt; startup
SQL&gt; alter pluggable database all open;
Pluggable database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 如果是CDB环境，先开启数据库也要开启PDB
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> pluggable database <span class="hljs-keyword">all</span> <span class="hljs-keyword">open</span>;
Pluggable database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-DBCA命令_133" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>DBCA命令</h4><blockquote data-block="0"><p data-block="0">不需要备库数据库处于nomount状态，监听开启后备库上直接DBCA即可
如果是CDB环境，完成后CDB会直接开启，再开启PDB即可。</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># 19c 官网展示的模板
dbca -createDuplicateDB 
    -gdbName global_database_name 
    -primaryDBConnectionString easy_connect_string_to_primary
    -sid database_system_identifier
    [-createAsStandby 
        [-dbUniqueName db_unique_name_for_standby]]
    [-customScripts scripts_list]
# 19c 官网DBCA案例  
	#	Database 			DB_UNIQUE_NAME 		Oracle Net Service Name
	#	Primary				chicago				chicago
	#	Physical standby	boston				boston
# dbca –silent -createDuplicateDB -primaryDBConnectionString  myprimary.domain:1523/chicago.domain -gdbName chicago.domain -sid boston -initParams instance_name=boston –createAsStandby

# 本实验如下设置
dbca -silent -createDuplicateDB \
-gdbName orcl \
-sid orcldg \
-sysPassword Oracle#2020 \
-primaryDBConnectionString 192.168.2.2:1521/ORCL \
-nodelist klausdg \
-databaseConfigType SINGLE \
-createAsStandby -dbUniqueName orcldg
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> 19c 官网展示的模板</span>
dbca -createDuplicateDB 
    -gdbName global_database_name 
    -primaryDBConnectionString easy_connect_string_to_primary
    -sid database_system_identifier
    [-createAsStandby 
        [-dbUniqueName db_unique_name_for_standby]]
    [-customScripts scripts_list]
<span class="hljs-meta">#</span><span class="bash"> 19c 官网DBCA案例</span>  
<span class="hljs-meta">	#</span><span class="bash">	Database 			DB_UNIQUE_NAME 		Oracle Net Service Name</span>
<span class="hljs-meta">	#</span><span class="bash">	Primary				chicago				chicago</span>
<span class="hljs-meta">	#</span><span class="bash">	Physical standby	boston				boston</span>
<span class="hljs-meta">#</span><span class="bash"> dbca –silent -createDuplicateDB -primaryDBConnectionString  myprimary.domain:1523/chicago.domain -gdbName chicago.domain -sid boston -initParams instance_name=boston –createAsStandby</span>
<span class="hljs-meta">
#</span><span class="bash"> 本实验如下设置</span>
dbca -silent -createDuplicateDB \
-gdbName orcl \
-sid orcldg \
-sysPassword Oracle#2020 \
-primaryDBConnectionString 192.168.2.2:1521/ORCL \
-nodelist klausdg \
-databaseConfigType SINGLE \
-createAsStandby -dbUniqueName orcldg
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 执行过程
[oracle@klausdg ~]$ dbca -silent -createDuplicateDB \
&gt; -gdbName orcl \
&gt; -sid orcldg \
&gt; -sysPassword Oracle#2020 \
&gt; -primaryDBConnectionString 192.168.2.2:1521/ORCL \
&gt; -nodelist klausdg \
&gt; -databaseConfigType SINGLE \
&gt; -createAsStandby -dbUniqueName orcldg
Prepare for db operation
22% complete
Listener config step
44% complete
Auxiliary instance creation
67% complete
RMAN duplicate
89% complete
Post duplicate database operations
100% complete
Look at the log file "/u01/app/oracle/cfgtoollogs/dbca/orcldg/orcldg.log" for further details.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 执行过程
[oracle<span class="hljs-variable">@klausdg</span> <span class="hljs-operator">~</span>]$ dbca <span class="hljs-operator">-</span>silent <span class="hljs-operator">-</span>createDuplicateDB \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>gdbName orcl \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>sid orcldg \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>sysPassword Oracle#<span class="hljs-number">2020</span> \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>primaryDBConnectionString <span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>:<span class="hljs-number">1521</span><span class="hljs-operator">/</span>ORCL \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>nodelist klausdg \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>databaseConfigType SINGLE \
<span class="hljs-operator">&gt;</span> <span class="hljs-operator">-</span>createAsStandby <span class="hljs-operator">-</span>dbUniqueName orcldg
<span class="hljs-keyword">Prepare</span> <span class="hljs-keyword">for</span> db operation
<span class="hljs-number">22</span><span class="hljs-operator">%</span> complete
Listener config step
<span class="hljs-number">44</span><span class="hljs-operator">%</span> complete
Auxiliary instance creation
<span class="hljs-number">67</span><span class="hljs-operator">%</span> complete
RMAN duplicate
<span class="hljs-number">89</span><span class="hljs-operator">%</span> complete
Post duplicate database operations
<span class="hljs-number">100</span><span class="hljs-operator">%</span> complete
Look <span class="hljs-keyword">at</span> the log file "/u01/app/oracle/cfgtoollogs/dbca/orcldg/orcldg.log" <span class="hljs-keyword">for</span> further details.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir-开启并验证DG同步_137" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>开启并验证DG同步</h2><h3 data-block="0" class="vditor-ir__node" id="ir-开启实时同步_138" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开启实时同步</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">alter database open;
# 如果是CDB环境，需要开启pdb
SQL&gt; alter pluggable database all open;
alter database recover managed standby database using current logfile disconnect from session;
# 从12C开始，RECOVER语句，不需要再指定using current logfile，Oracle会自动判断日志应用是否是实时的。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
# 如果是CDB环境，需要开启pdb
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> pluggable database <span class="hljs-keyword">all</span> <span class="hljs-keyword">open</span>;
<span class="hljs-keyword">alter</span> database recover managed standby database <span class="hljs-keyword">using</span> <span class="hljs-keyword">current</span> logfile <span class="hljs-keyword">disconnect</span> <span class="hljs-keyword">from</span> session;
# 从<span class="hljs-number">12</span>C开始，RECOVER语句，不需要再指定<span class="hljs-keyword">using</span> <span class="hljs-keyword">current</span> logfile，Oracle会自动判断日志应用是否是实时的。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库开启闪回_140" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库开启闪回</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 查看闪回
SQL&gt; select flashback_on from v$database;
FLASHBACK_ON
------------
NO
# 取消实时同步
SQL&gt; alter database recover managed standby database cancel;
# 关闭数据库
SQL&gt; shutdown immediate
SQL&gt; startup mount
SQL&gt; alter database flashback on;
# 开启数据库
SQL&gt; alter database open;
# 再次开启同步
SQL&gt; alter database recover managed standby database using current logfile disconnect from session;
# 查看
SQL&gt; select open_mode from v$database;
OPEN_MODE
--------------------
READ ONLY WITH APPLY
# 查看主库 PRIMARY
SQL&gt; select log_mode,open_mode ,database_role from v$database;
LOG_MODE     OPEN_MODE            DATABASE_ROLE
------------ -------------------- ----------------
ARCHIVELOG   READ WRITE           PRIMARY
# 查看备库 PHYSICAL STANDBY
SQL&gt; select log_mode,open_mode ,database_role from v$database;
LOG_MODE     OPEN_MODE            DATABASE_ROLE
------------ -------------------- ----------------
ARCHIVELOG   READ ONLY            PHYSICAL STANDBY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 查看闪回
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> flashback_on <span class="hljs-keyword">from</span> v$database;
FLASHBACK_ON
<span class="hljs-comment">------------</span>
<span class="hljs-keyword">NO</span>
# 取消实时同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database cancel;
# 关闭数据库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup mount
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database flashback <span class="hljs-keyword">on</span>;
# 开启数据库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
# 再次开启同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database <span class="hljs-keyword">using</span> <span class="hljs-keyword">current</span> logfile <span class="hljs-keyword">disconnect</span> <span class="hljs-keyword">from</span> session;
# 查看
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode <span class="hljs-keyword">from</span> v$database;
OPEN_MODE
<span class="hljs-comment">--------------------</span>
READ <span class="hljs-keyword">ONLY</span> <span class="hljs-keyword">WITH</span> APPLY
# 查看主库 <span class="hljs-keyword">PRIMARY</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> log_mode,open_mode ,database_role <span class="hljs-keyword">from</span> v$database;
LOG_MODE     OPEN_MODE            DATABASE_ROLE
<span class="hljs-comment">------------ -------------------- ----------------</span>
ARCHIVELOG   READ WRITE           <span class="hljs-keyword">PRIMARY</span>
# 查看备库 PHYSICAL STANDBY
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> log_mode,open_mode ,database_role <span class="hljs-keyword">from</span> v$database;
LOG_MODE     OPEN_MODE            DATABASE_ROLE
<span class="hljs-comment">------------ -------------------- ----------------</span>
ARCHIVELOG   READ <span class="hljs-keyword">ONLY</span>            PHYSICAL STANDBY
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-归档同步验证_142" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>归档同步验证</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库切换归档, 查询主库备库最大归档序号，一致即归档同步成功
SQL&gt; alter system archive log current;
SQL&gt; select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
            72
# 查看主备归档日志是否能正常传输（APPLIED=yes）
SQL&gt; select SEQUENCE#, FIRST_TIME, NEXT_TIME, APPLIED, ARCHIVED from V$ARCHIVED_LOG;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库切换归档, 查询主库备库最大归档序号，一致即归档同步成功
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> archive log <span class="hljs-keyword">current</span>;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(sequence#) <span class="hljs-keyword">from</span> v$archived_log;
<span class="hljs-built_in">MAX</span>(SEQUENCE#)
<span class="hljs-comment">--------------</span>
            <span class="hljs-number">72</span>
# 查看主备归档日志是否能正常传输（APPLIED<span class="hljs-operator">=</span>yes）
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> SEQUENCE#, FIRST_TIME, NEXT_TIME, APPLIED, ARCHIVED <span class="hljs-keyword">from</span> V$ARCHIVED_LOG;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-查看主备库状态_144" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>查看主备库状态</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO STANDBY           PRIMARY
# 备库
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          PHYSICAL STANDBY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> switchover_status,database_role <span class="hljs-keyword">from</span> v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">TO</span> STANDBY           <span class="hljs-keyword">PRIMARY</span>
# 备库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> switchover_status,database_role <span class="hljs-keyword">from</span> v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          PHYSICAL STANDBY
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主库查看备库归档路径报错_146" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主库查看备库归档路径报错</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库 查看archive_log_dest_2列是否有error
SQL&gt; select status,error from v$archive_dest where dest_id=2;
STATUS    ERROR
--------- --------------------
VALID
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库 查看archive_log_dest_2列是否有error
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> status,error <span class="hljs-keyword">from</span> v$archive_dest <span class="hljs-keyword">where</span> dest_id<span class="hljs-operator">=</span><span class="hljs-number">2</span>;
STATUS    ERROR
<span class="hljs-comment">--------- --------------------</span>
VALID
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主库Dataguard的状态信息_148" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主库Dataguard的状态信息</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 查看Dataguard的状态信息
col message format a150
SQL&gt; select message_num,message from v$dataguard_status;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 查看Dataguard的状态信息
col message format a150
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> message_num,message <span class="hljs-keyword">from</span> v$dataguard_status;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-建表测试_150" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>建表测试</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库
create table test(id number);
insert into test values(1);
commit;
select * from test;
# 备库
select * from test;

</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test(id number);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;
# 备库
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;

<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir-DG切换和恢复_152" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>DG切换和恢复</h2><blockquote data-block="0"><p data-block="0">配置DG的目的就是为了在主库出现故障时，备库能够提供服务，保证业务的正常运行。
DG的故障切换分为switchover和failover两种</p></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-Switchover_154" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>Switchover</h3><h4 data-block="0" class="vditor-ir__node" id="ir-主库上操作_155" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>主库上操作</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、主库查询状态
# 注意：下面查询结果为TO STANDBY 或 SESSIONS ACTIVE表明可以进行切换
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO STANDBY           PRIMARY
# 2、主库开始切换
SQL&gt; alter database commit to switchover to physical standby;
Database altered.
# 主库有会话连接的时候使用如下命令
# alter database commit to switchover to physical standby with session shutdown;
# 3、主库变备库，开启到mount状态
SQL&gt; startup mount
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
Database mounted.
SQL&gt; select database_role from v$database;
DATABASE_ROLE
----------------
PHYSICAL STANDBY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、主库查询状态
# 注意：下面查询结果为<span class="hljs-keyword">TO</span> STANDBY 或 SESSIONS ACTIVE表明可以进行切换
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> switchover_status,database_role <span class="hljs-keyword">from</span> v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">TO</span> STANDBY           <span class="hljs-keyword">PRIMARY</span>
# <span class="hljs-number">2</span>、主库开始切换
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">commit</span> <span class="hljs-keyword">to</span> switchover <span class="hljs-keyword">to</span> physical standby;
Database altered.
# 主库有会话连接的时候使用如下命令
# <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">commit</span> <span class="hljs-keyword">to</span> switchover <span class="hljs-keyword">to</span> physical standby <span class="hljs-keyword">with</span> session shutdown;
# <span class="hljs-number">3</span>、主库变备库，开启到mount状态
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup mount
ORACLE instance started.
Total <span class="hljs-keyword">System</span> <span class="hljs-keyword">Global</span> Area <span class="hljs-number">2466250752</span> bytes
Fixed Size                  <span class="hljs-number">2927384</span> bytes
Variable Size             <span class="hljs-number">671089896</span> bytes
Database Buffers         <span class="hljs-number">1778384896</span> bytes
Redo Buffers               <span class="hljs-number">13848576</span> bytes
Database mounted.
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> database_role <span class="hljs-keyword">from</span> v$database;
DATABASE_ROLE
<span class="hljs-comment">----------------</span>
PHYSICAL STANDBY
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-备库上操作_157" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>备库上操作</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、备库查询状态
# 注意：下面查询结果为TO PRIMARY 或 SESSIONS ACTIVE表明可以进行切换
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO PRIMARY           PHYSICAL STANDBY
# 2、备库开始切换
SQL&gt; alter database commit to switchover to primary with session shutdown;
Database altered.
# 3、开启数据库
SQL&gt;  alter database open;
Database altered.
# 4、查询状态，已经变成主库
SQL&gt; select switchover_status,database_role,open_mode from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE    OPEN_MODE
-------------------- ---------------- --------------------
TO STANDBY           PRIMARY          READ WRITE
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、备库查询状态
# 注意：下面查询结果为<span class="hljs-keyword">TO</span> <span class="hljs-keyword">PRIMARY</span> 或 SESSIONS ACTIVE表明可以进行切换
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> switchover_status,database_role <span class="hljs-keyword">from</span> v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">TO</span> <span class="hljs-keyword">PRIMARY</span>           PHYSICAL STANDBY
# <span class="hljs-number">2</span>、备库开始切换
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">commit</span> <span class="hljs-keyword">to</span> switchover <span class="hljs-keyword">to</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">with</span> session shutdown;
Database altered.
# <span class="hljs-number">3</span>、开启数据库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span>  <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
Database altered.
# <span class="hljs-number">4</span>、查询状态，已经变成主库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> switchover_status,database_role,open_mode <span class="hljs-keyword">from</span> v$database;
SWITCHOVER_STATUS    DATABASE_ROLE    OPEN_MODE
<span class="hljs-comment">-------------------- ---------------- --------------------</span>
<span class="hljs-keyword">TO</span> STANDBY           <span class="hljs-keyword">PRIMARY</span>          READ WRITE
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-新备库-原主库-上的操作_159" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>新备库(原主库)上的操作</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、开机数据库open
SQL&gt; alter database open;
Database altered.
# 2、开启同步
SQL&gt; alter database recover managed standby database using current logfile disconnect from session;
Database altered.
# 3、主备检查切换状态
SQL&gt; select open_mode,database_role,db_unique_name from v$database;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、开机数据库<span class="hljs-keyword">open</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
Database altered.
# <span class="hljs-number">2</span>、开启同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database <span class="hljs-keyword">using</span> <span class="hljs-keyword">current</span> logfile <span class="hljs-keyword">disconnect</span> <span class="hljs-keyword">from</span> session;
Database altered.
# <span class="hljs-number">3</span>、主备检查切换状态
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode,database_role,db_unique_name <span class="hljs-keyword">from</span> v$database;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-验证_161" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>验证</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 新主库切换归档，主备查询
alter system archive log current;
SQL&gt; select max(sequence#) from v$archived_log;
# 新主库表插入数据测试
insert into test values(2); 
commit;
select * from test;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 新主库切换归档，主备查询
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> archive log <span class="hljs-keyword">current</span>;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(sequence#) <span class="hljs-keyword">from</span> v$archived_log;
# 新主库表插入数据测试
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>); 
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-Failover_163" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>Failover</h3><blockquote data-block="0"><p data-block="0">Failover是当主库真正出现严重系统故障，如数据库宕机，软硬件故障导致主库不能支持服务，从而进行的切换动作。
注意：为了能够在failover后能够恢复DG,需要在主库上开启flashback，否则DG就可能需要重新搭建。</p></blockquote><blockquote data-block="0"><p data-block="0">先把主库关机，模拟Failover
由于主库已经不可访问，下面所有的操作都在备库完成：</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-备库上操作-_166" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>备库上操作</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; select database_role,open_mode from v$database;
DATABASE_ROLE    OPEN_MODE
---------------- --------------------
PHYSICAL STANDBY READ ONLY WITH APPLY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> database_role,open_mode <span class="hljs-keyword">from</span> v$database;
DATABASE_ROLE    OPEN_MODE
<span class="hljs-comment">---------------- --------------------</span>
PHYSICAL STANDBY READ <span class="hljs-keyword">ONLY</span> <span class="hljs-keyword">WITH</span> APPLY
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-停止实时同步_168" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>停止实时同步</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; alter database recover managed standby database cancel;
Database altered.
SQL&gt; alter database recover managed standby database finish force;
Database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database cancel;
Database altered.
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database finish force;
Database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-状态改为主库_170" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>状态改为主库</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; select database_role from v$database;
DATABASE_ROLE
----------------
PHYSICAL STANDBY
# 更改状态
SQL&gt; alter database commit to switchover to primary;
Database altered.
# 再次查看
SQL&gt; select database_role from v$database;
DATABASE_ROLE
----------------
PRIMARY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> database_role <span class="hljs-keyword">from</span> v$database;
DATABASE_ROLE
<span class="hljs-comment">----------------</span>
PHYSICAL STANDBY
# 更改状态
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">commit</span> <span class="hljs-keyword">to</span> switchover <span class="hljs-keyword">to</span> <span class="hljs-keyword">primary</span>;
Database altered.
# 再次查看
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> database_role <span class="hljs-keyword">from</span> v$database;
DATABASE_ROLE
<span class="hljs-comment">----------------</span>
<span class="hljs-keyword">PRIMARY</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-开启数据库open_172" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>开启数据库open</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 开启数据库open
SQL&gt; alter database open;
Database altered.
# 查看状态
SQL&gt; select switchover_status,database_role,open_mode from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE    OPEN_MODE
-------------------- ---------------- --------------------
FAILED DESTINATION   PRIMARY          READ WRITE
# 当主库的SWITCHOVER_STATUS状态为FAILED DESTINATION时，是因为备库不在mount状态下,这里已经没有备库
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 开启数据库<span class="hljs-keyword">open</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
Database altered.
# 查看状态
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> switchover_status,database_role,open_mode <span class="hljs-keyword">from</span> v$database;
SWITCHOVER_STATUS    DATABASE_ROLE    OPEN_MODE
<span class="hljs-comment">-------------------- ---------------- --------------------</span>
FAILED DESTINATION   <span class="hljs-keyword">PRIMARY</span>          READ WRITE
# 当主库的SWITCHOVER_STATUS状态为FAILED DESTINATION时，是因为备库不在mount状态下,这里已经没有备库
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-Failover恢复_174" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>Failover恢复</h3><blockquote data-block="0"><p data-block="0">上面提到了failover，这种情形是当主库真正出现异常之后，才会执行的操作，那么执行过failover 之后，如何在重新构建DG，这里我们利用flashback database来重构，具体方法如下：</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-在新主库上执行_176" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>在新主库上执行</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 查询变成新主库的scn
SQL&gt; select to_char(standby_became_primary_scn) from v$database;
TO_CHAR(STANDBY_BECAME_PRIMARY_SCN)
----------------------------------------
12514234
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 查询变成新主库的scn
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> to_char(standby_became_primary_scn) <span class="hljs-keyword">from</span> v$database;
TO_CHAR(STANDBY_BECAME_PRIMARY_SCN)
<span class="hljs-comment">----------------------------------------</span>
<span class="hljs-number">12514234</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-在老主库上执行_178" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>在老主库上执行</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 要将之前出问题的老主库变成备库
# 1、启动 mount 状态下
SQL&gt; startup mount
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
Database mounted.
# 2、闪回到新的主库查询的scn
SQL&gt; flashback database to scn 12514234;
Flashback complete.
# 3、转为备库
SQL&gt; alter database convert to physical standby;
Database altered.
# 4、关闭
SQL&gt; shutdown immediate
ORA-01109: database not open
Database dismounted.
ORACLE instance shut down.
# 5、开启
SQL&gt; startup
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
Database mounted.
Database opened.
# 6、开启同步
SQL&gt; alter database recover managed standby database using current logfile disconnect from session;
Database altered.
# 7、同步验证(略)
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 要将之前出问题的老主库变成备库
# <span class="hljs-number">1</span>、启动 mount 状态下
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup mount
ORACLE instance started.
Total <span class="hljs-keyword">System</span> <span class="hljs-keyword">Global</span> Area <span class="hljs-number">2466250752</span> bytes
Fixed Size                  <span class="hljs-number">2927384</span> bytes
Variable Size             <span class="hljs-number">671089896</span> bytes
Database Buffers         <span class="hljs-number">1778384896</span> bytes
Redo Buffers               <span class="hljs-number">13848576</span> bytes
Database mounted.
# <span class="hljs-number">2</span>、闪回到新的主库查询的scn
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> flashback database <span class="hljs-keyword">to</span> scn <span class="hljs-number">12514234</span>;
Flashback complete.
# <span class="hljs-number">3</span>、转为备库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">convert</span> <span class="hljs-keyword">to</span> physical standby;
Database altered.
# <span class="hljs-number">4</span>、关闭
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate
ORA<span class="hljs-number">-01109</span>: database <span class="hljs-keyword">not</span> <span class="hljs-keyword">open</span>
Database dismounted.
ORACLE instance shut down.
# <span class="hljs-number">5</span>、开启
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup
ORACLE instance started.
Total <span class="hljs-keyword">System</span> <span class="hljs-keyword">Global</span> Area <span class="hljs-number">2466250752</span> bytes
Fixed Size                  <span class="hljs-number">2927384</span> bytes
Variable Size             <span class="hljs-number">671089896</span> bytes
Database Buffers         <span class="hljs-number">1778384896</span> bytes
Redo Buffers               <span class="hljs-number">13848576</span> bytes
Database mounted.
Database opened.
# <span class="hljs-number">6</span>、开启同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database <span class="hljs-keyword">using</span> <span class="hljs-keyword">current</span> logfile <span class="hljs-keyword">disconnect</span> <span class="hljs-keyword">from</span> session;
Database altered.
# <span class="hljs-number">7</span>、同步验证(略)
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir--方式四-逻辑备库Logical-Standby-_180" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>【方式四：逻辑备库Logical Standby】</h2><h3 data-block="0" class="vditor-ir__node" id="ir-说明_181" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>说明</h3><blockquote data-block="0"><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">Oracle Data Guard逻辑备库是利用主库的一个备份首先建立一个物理备库，然后再将其转换为逻辑备库。
这之后主库将日志传递到备库，备库利用logminer从主库的日志中解析出主库所执行过的SQL，在备库上重新执行一遍，从而保证与主库的数据在逻辑上保持一致。
与物理备库相对应的是，物理备库使用的是redo apply，逻辑备库使用的是sql apply。
因此逻辑备库仅仅保证数据与主库是在逻辑上是一致的，从而逻辑备库可以处于open状态下并进行相应的DML操作。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;">Oracle Data Guard逻辑备库是利用主库的一个备份首先建立一个物理备库，然后再将其转换为逻辑备库。
这之后主库将日志传递到备库，备库利用logminer从主库的日志中解析出主库所执行过的SQL，在备库上重新执行一遍，从而保证与主库的数据在逻辑上保持一致。
与物理备库相对应的是，物理备库使用的是redo apply，逻辑备库使用的是sql apply。
因此逻辑备库仅仅保证数据与主库是在逻辑上是一致的，从而逻辑备库可以处于open状态下并进行相应的DML操作。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-备库停止MGR-Redo-apply应用-_183" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库停止MGR(Redo apply应用)</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 对于将物理备库切换到逻辑备库，需要在主库构建LogMiner字典及启用补充日志
# 因此应先停用备库的MRP进程，避免产生额外的Redo Apply
SQL&gt; alter database recover managed standby database cancel;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 对于将物理备库切换到逻辑备库，需要在主库构建LogMiner字典及启用补充日志
# 因此应先停用备库的MRP进程，避免产生额外的Redo Apply
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database cancel;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-主库构建LogMiner字典_185" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>主库构建LogMiner字典</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、创建字典表空间
SQL&gt; create tablespace logmnrtbs datafile '/u01/app/oracle/oradata/orcl/logmnrtbs.dbf' size 100m autoextend on next 5m maxsize 2000m;
# 2、关联字典表空间
SQL&gt; execute dbms_logmnr_d.set_tablespace('logmnrtbs');
PL/SQL procedure successfully completed.
# 3、构建LogMiner字典
SQL&gt; exec dbms_logstdby.build;
PL/SQL procedure successfully completed.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、创建字典表空间
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span>space logmnrtbs datafile <span class="hljs-string">'/u01/app/oracle/oradata/orcl/logmnrtbs.dbf'</span> size <span class="hljs-number">100</span>m autoextend <span class="hljs-keyword">on</span> next <span class="hljs-number">5</span>m maxsize <span class="hljs-number">2000</span>m;
# <span class="hljs-number">2</span>、关联字典表空间
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">execute</span> dbms_logmnr_d.set_tablespace(<span class="hljs-string">'logmnrtbs'</span>);
PL<span class="hljs-operator">/</span><span class="hljs-keyword">SQL</span> <span class="hljs-keyword">procedure</span> successfully completed.
# <span class="hljs-number">3</span>、构建LogMiner字典
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">exec</span> dbms_logstdby.build;
PL<span class="hljs-operator">/</span><span class="hljs-keyword">SQL</span> <span class="hljs-keyword">procedure</span> successfully completed.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-物理备库恢复为逻辑备库_187" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>物理备库恢复为逻辑备库</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; select name,open_mode,database_role,protection_mode from v$database; 
NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
ORCL      MOUNTED              PHYSICAL STANDBY MAXIMUM PERFORMANCE
========================================================================
# 1、关闭,必须一致性性关闭数据库
SQL&gt; shutdown immediate
# 2、以exclusive方式启动到mount
SQL&gt; startup mount exclusive
# 3、转换为逻辑备库并设置新的db_name
SQL&gt; ALTER DATABASE RECOVER TO LOGICAL STANDBY ORCLLG; 
# 4、关闭,必须一致性性关闭数据库
SQL&gt; shutdown immediate
# 5、正常启动到mount
SQL&gt; startup mount
========================================================================
##	可以看到name自动改变，为读写模式，日志序列也从1开始
SQL&gt; select name,open_mode,database_role,protection_mode from v$database; 
NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
ORCLLG    MOUNTED              LOGICAL STANDBY  MAXIMUM PERFORMANCE
SQL&gt; archive log list;
Database log mode              Archive Mode
Automatic archival             Enabled
Archive destination            USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence     1
Next log sequence to archive   1
Current log sequence           1
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> name,open_mode,database_role,protection_mode <span class="hljs-keyword">from</span> v$database; 
NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
<span class="hljs-comment">--------- -------------------- ---------------- --------------------</span>
ORCL      MOUNTED              PHYSICAL STANDBY MAXIMUM PERFORMANCE
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
# <span class="hljs-number">1</span>、关闭,必须一致性性关闭数据库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate
# <span class="hljs-number">2</span>、以exclusive方式启动到mount
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup mount exclusive
# <span class="hljs-number">3</span>、转换为逻辑备库并设置新的db_name
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE RECOVER <span class="hljs-keyword">TO</span> LOGICAL STANDBY ORCLLG; 
# <span class="hljs-number">4</span>、关闭,必须一致性性关闭数据库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> shutdown immediate
# <span class="hljs-number">5</span>、正常启动到mount
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> startup mount
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
##	可以看到name自动改变，为读写模式，日志序列也从<span class="hljs-number">1</span>开始
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> name,open_mode,database_role,protection_mode <span class="hljs-keyword">from</span> v$database; 
NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
<span class="hljs-comment">--------- -------------------- ---------------- --------------------</span>
ORCLLG    MOUNTED              LOGICAL STANDBY  MAXIMUM PERFORMANCE
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> archive log list;
Database log mode              Archive Mode
Automatic archival             Enabled
Archive destination            USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence     <span class="hljs-number">1</span>
Next log sequence <span class="hljs-keyword">to</span> archive   <span class="hljs-number">1</span>
<span class="hljs-keyword">Current</span> log sequence           <span class="hljs-number">1</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-开启逻辑备库并同步_189" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>开启逻辑备库并同步</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 由于逻辑Standby与Primary数据库事务并不一致，因此第一次打开时必须指定RESETLOGS子句
SQL&gt; ALTER DATABASE OPEN RESETLOGS;
# 执行启动REDO应用的命令，附加APPLY IMMEDIATE子句，以打开实时应用
SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE; 
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 由于逻辑Standby与<span class="hljs-keyword">Primary</span>数据库事务并不一致，因此第一次打开时必须指定RESETLOGS子句
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">OPEN</span> RESETLOGS;
# 执行启动REDO应用的命令，附加APPLY IMMEDIATE子句，以打开实时应用
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">START</span> LOGICAL STANDBY APPLY IMMEDIATE; 
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-测试_191" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>测试</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 测试逻辑DG部分
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 在测试数据是否正常同步时，不要使用数据库的内部账号，逻辑dg在默认情况下不传输系统用户下，用户自行创建的数据
# 比如在sys用户下创建一个test表，这个表不会同步到逻辑备库
# 可以使用下列语句查看哪些用户作为内部用户
SQL&gt; SELECT OWNER FROM DBA_LOGSTDBY_SKIP WHERE STATEMENT_OPT = 'INTERNAL SCHEMA';
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 以下在方式四的逻辑DG环境中，主库解锁scott，备库已也会同步经解锁该用户，并创建表等操作
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
SQL&gt; alter user scott account unlock;
User altered.
SQL&gt; conn scott/tiger
ERROR:
ORA-28002: the password will expire within 7 days
create table test(id number);
insert into test values(1);
commit;
# 主备查询一致，至此逻辑Standby创建完成.
select * from test;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
# 测试逻辑DG部分
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
# 在测试数据是否正常同步时，不要使用数据库的内部账号，逻辑dg在默认情况下不传输系统用户下，用户自行创建的数据
# 比如在sys用户下创建一个test表，这个表不会同步到逻辑备库
# 可以使用下列语句查看哪些用户作为内部用户
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> OWNER <span class="hljs-keyword">FROM</span> DBA_LOGSTDBY_SKIP <span class="hljs-keyword">WHERE</span> STATEMENT_OPT <span class="hljs-operator">=</span> <span class="hljs-string">'INTERNAL SCHEMA'</span>;
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
# 以下在方式四的逻辑DG环境中，主库解锁scott，备库已也会同步经解锁该用户，并创建表等操作
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">user</span> scott account unlock;
<span class="hljs-keyword">User</span> altered.
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> conn scott<span class="hljs-operator">/</span>tiger
ERROR:
ORA<span class="hljs-number">-28002</span>: the password will expire <span class="hljs-keyword">within</span> <span class="hljs-number">7</span> days
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test(id number);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">commit</span>;
# 主备查询一致，至此逻辑Standby创建完成.
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-Swichover_193" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>Swichover</h3><h4 data-block="0" class="vditor-ir__node" id="ir-状态检查_194" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>状态检查</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 1、查看当前Primary数据库状态：
#如果该查询返回TO STANDBY 或SESSIONS ACTIVE则表示状态正常，可以执行转换操作
# 主库
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO STANDBY           PRIMARY
# 备库
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          LOGICAL STANDBY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">1</span>、查看当前<span class="hljs-keyword">Primary</span>数据库状态：
#如果该查询返回<span class="hljs-keyword">TO</span> STANDBY 或SESSIONS ACTIVE则表示状态正常，可以执行转换操作
# 主库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">TO</span> STANDBY           <span class="hljs-keyword">PRIMARY</span>
# 备库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          LOGICAL STANDBY
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir--准备-转换Primary为逻辑Standby_196" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>[准备]转换Primary为逻辑Standby</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 2、执行下列语句，将Primary置为准备转换的状态：
SQL&gt; ALTER DATABASE PREPARE TO SWITCHOVER TO LOGICAL STANDBY;
Database altered.
# 执行完上述操作后，Primary数据库就开始为角色的转换打好基础，时刻准备着接收来自逻辑Standby数据库，也就是未来的新Primary数据库发来的REDO数据。
# 查看一下SWITCHOVER_STATUS的状态：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
PREPARING SWITCHOVER PRIMARY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># <span class="hljs-number">2</span>、执行下列语句，将<span class="hljs-keyword">Primary</span>置为准备转换的状态：
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">TO</span> SWITCHOVER <span class="hljs-keyword">TO</span> LOGICAL STANDBY;
Database altered.
# 执行完上述操作后，<span class="hljs-keyword">Primary</span>数据库就开始为角色的转换打好基础，时刻准备着接收来自逻辑Standby数据库，也就是未来的新<span class="hljs-keyword">Primary</span>数据库发来的REDO数据。
# 查看一下SWITCHOVER_STATUS的状态：
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
PREPARING SWITCHOVER <span class="hljs-keyword">PRIMARY</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir--准备-转换逻辑Standby为Primary_198" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>[准备]转换逻辑Standby为Primary</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 转换为Primary的PREPARE状态
# 语句执行时响应会稍微有点慢
SQL&gt; ALTER DATABASE PREPARE TO SWITCHOVER TO PRIMARY;
Database altered.
# 执行完后查看当前逻辑Standby数据库的转换状态：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
PREPARING SWITCHOVER LOGICAL STANDBY 
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 转换为<span class="hljs-keyword">Primary</span>的<span class="hljs-keyword">PREPARE</span>状态
# 语句执行时响应会稍微有点慢
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">TO</span> SWITCHOVER <span class="hljs-keyword">TO</span> <span class="hljs-keyword">PRIMARY</span>;
Database altered.
# 执行完后查看当前逻辑Standby数据库的转换状态：
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
PREPARING SWITCHOVER LOGICAL STANDBY 
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-再次检查Primary状态_200" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>再次检查Primary状态</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO LOGICAL STANDBY   PRIMARY
# 检查结果却非常重要，它直接关系到switchover转换是否能够成功。
# 逻辑Standby执行完PREPARE命令之后，就会生成相应的LogMiner字典数据（就像我们前面创建逻辑Standby时，Primary数据库会生成LogMiner字典数据一样），只有它正常生成并发送至当前的Primary数据库，转换操作才能够继续下去。不然当前的Primary数据库在转换完之后，可能就失去了从新的Primary数据库接收REDO数据的能力了。
# 因此，如果上述查询的返回结果不是TO LOGICAL STANDBY的话，DBA就需要考虑是否取消此次转换，检查原因，然后再重新操作了

# ++取消转换可以通过下列语句进行++++++++++++++++++++++++++++++++++++++++++++++++
ALTER DATABASE PREPARE TO SWITCHOVER CANCEL; 
# ++需要分别在Primary端和逻辑Standby端执行+++++++++++++++++++++++++++++++++++++
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">TO</span> LOGICAL STANDBY   <span class="hljs-keyword">PRIMARY</span>
# 检查结果却非常重要，它直接关系到switchover转换是否能够成功。
# 逻辑Standby执行完<span class="hljs-keyword">PREPARE</span>命令之后，就会生成相应的LogMiner字典数据（就像我们前面创建逻辑Standby时，<span class="hljs-keyword">Primary</span>数据库会生成LogMiner字典数据一样），只有它正常生成并发送至当前的<span class="hljs-keyword">Primary</span>数据库，转换操作才能够继续下去。不然当前的<span class="hljs-keyword">Primary</span>数据库在转换完之后，可能就失去了从新的<span class="hljs-keyword">Primary</span>数据库接收REDO数据的能力了。
# 因此，如果上述查询的返回结果不是<span class="hljs-keyword">TO</span> LOGICAL STANDBY的话，DBA就需要考虑是否取消此次转换，检查原因，然后再重新操作了

# <span class="hljs-operator">+</span><span class="hljs-operator">+</span>取消转换可以通过下列语句进行<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">TO</span> SWITCHOVER CANCEL; 
# <span class="hljs-operator">+</span><span class="hljs-operator">+</span>需要分别在<span class="hljs-keyword">Primary</span>端和逻辑Standby端执行<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-正式转换Primary为逻辑Standby_202" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>正式转换Primary为逻辑Standby</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; ALTER DATABASE COMMIT TO SWITCHOVER TO LOGICAL STANDBY;
Database altered.
# 该语句需要等待当前Primary数据库所有事务全部结束才开始执行
# 该语句执行过程中会自动拒绝用户提交新事务或修改需求，为了确保该操作尽可能快的执行，最好自开始切换操作起就禁止所有用户的操作
# 该命令执行完之后，这个Primary数据库就已经成为新的逻辑Standby了。不过在新Primary执行完转换之前，不要关闭当前这个数据库
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">TO</span> SWITCHOVER <span class="hljs-keyword">TO</span> LOGICAL STANDBY;
Database altered.
# 该语句需要等待当前<span class="hljs-keyword">Primary</span>数据库所有事务全部结束才开始执行
# 该语句执行过程中会自动拒绝用户提交新事务或修改需求，为了确保该操作尽可能快的执行，最好自开始切换操作起就禁止所有用户的操作
# 该命令执行完之后，这个<span class="hljs-keyword">Primary</span>数据库就已经成为新的逻辑Standby了。不过在新<span class="hljs-keyword">Primary</span>执行完转换之前，不要关闭当前这个数据库
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-再次检查逻辑Standby状态_204" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>再次检查逻辑Standby状态</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># SWITCHOVER_STATUS的状态，应该为TO PRIMARY：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO PRIMARY           LOGICAL STANDBY
# 或者
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          LOGICAL STANDBY
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># SWITCHOVER_STATUS的状态，应该为<span class="hljs-keyword">TO</span> <span class="hljs-keyword">PRIMARY</span>：
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">TO</span> <span class="hljs-keyword">PRIMARY</span>           LOGICAL STANDBY
# 或者
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          LOGICAL STANDBY
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-正式转换逻辑Standby为新Primary_206" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>正式转换逻辑Standby为新Primary</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY;
Database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">TO</span> SWITCHOVER <span class="hljs-keyword">TO</span> <span class="hljs-keyword">PRIMARY</span>;
Database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-开始新的主备同步_208" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>开始新的主备同步</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 新逻辑备库（即原主库上）
SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE;
Database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 新逻辑备库（即原主库上）
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">START</span> LOGICAL STANDBY APPLY IMMEDIATE;
Database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-测试-_210" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>测试</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库添加数据
insert into scott.test values(10);
commit;
# 主备查询
select * from scott.test;
# ==发现并没有同步=============================
# 查看新主库状态,存在GAP
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
LOG SWITCH GAP       PRIMARY
# ==解决=====================================
# 新主库关闭启动到mount
shutdown immediate
startup mount
# 把新主库REDO FLUSH到新备库，
# 此处是orcldg是新主库，在新主库上将日志flush到新备库上
# ALTER SYSTEM FLUSH REDO TO target_db_name;其中target_db_name使用DB_UNIQUE_NAME
ALTER SYSTEM FLUSH REDO TO orcl;
# 再次查看新主库状态，再测试数据已经同步
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          PRIMARY
# 开启数据库
alter database open;
# 测试查询结果
SQL&gt; select * from scott.test;
        ID
----------
         2
        10
         1
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库添加数据
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> scott.test <span class="hljs-keyword">values</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">commit</span>;
# 主备查询
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> scott.test;
# <span class="hljs-operator">=</span><span class="hljs-operator">=</span>发现并没有同步<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
# 查看新主库状态,存在GAP
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
LOG SWITCH GAP       <span class="hljs-keyword">PRIMARY</span>
# <span class="hljs-operator">=</span><span class="hljs-operator">=</span>解决<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
# 新主库关闭启动到mount
shutdown immediate
startup mount
# 把新主库REDO FLUSH到新备库，
# 此处是orcldg是新主库，在新主库上将日志flush到新备库上
# <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> FLUSH REDO <span class="hljs-keyword">TO</span> target_db_name;其中target_db_name使用DB_UNIQUE_NAME
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> FLUSH REDO <span class="hljs-keyword">TO</span> orcl;
# 再次查看新主库状态，再测试数据已经同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          <span class="hljs-keyword">PRIMARY</span>
# 开启数据库
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
# 测试查询结果
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> scott.test;
        ID
<span class="hljs-comment">----------</span>
         <span class="hljs-number">2</span>
        <span class="hljs-number">10</span>
         <span class="hljs-number">1</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-Failover-_212" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>Failover</h3><h4 data-block="0" class="vditor-ir__node" id="ir-检查丢失的归档_213" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>检查丢失的归档</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 如果此时Primary数据库仍可被访问，首先应当检查当前的归档日志序号与逻辑Standby是否相同
# 主库
SQL&gt; SELECT MAX(SEQUENCE#) FROM V$ARCHIVED_LOG;
MAX(SEQUENCE#)
--------------
            11
# 备库
SQL&gt; SELECT SEQUENCE#,APPLIED FROM DBA_LOGSTDBY_LOG;
 SEQUENCE# APPLIED
---------- --------
         8 YES
         9 YES
        10 YES
        11 CURRENT
# Failover三种情况：(上面查询的是正常运行的还没有Failover的情况)
# 第一种：如果逻辑Standby与Primary的归档序号相同，但某些序号的APPLIED状态为NO，建议检查当前逻辑Standby数据库是否启动了SQL应用
# 第二种：如果逻辑Standby归档序号小于Primary的归档序号，说明Primary存在尚未发送至逻辑Standby数据库的归档文件，手工复制这些文件到待转换角色的逻辑Standby端，然后在该逻辑Standby数据库的SQL*Plus命令窗口，通过执行ALTER DATABASE REGISTER LOGICAL LOGFILE 'filepath'; 命令，将复制过来的归档文件手工注册
# 第三种：如果Primary数据库已经无法打开，就只好直接到磁盘上查看归档目录中的序号，来与逻辑Standby数据库做比较。如果Primary数据库已经完全无法访问，那直接按照后面步骤进行操作
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 如果此时<span class="hljs-keyword">Primary</span>数据库仍可被访问，首先应当检查当前的归档日志序号与逻辑Standby是否相同
# 主库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(SEQUENCE#) <span class="hljs-keyword">FROM</span> V$ARCHIVED_LOG;
<span class="hljs-built_in">MAX</span>(SEQUENCE#)
<span class="hljs-comment">--------------</span>
            <span class="hljs-number">11</span>
# 备库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SEQUENCE#,APPLIED <span class="hljs-keyword">FROM</span> DBA_LOGSTDBY_LOG;
 SEQUENCE# APPLIED
<span class="hljs-comment">---------- --------</span>
         <span class="hljs-number">8</span> YES
         <span class="hljs-number">9</span> YES
        <span class="hljs-number">10</span> YES
        <span class="hljs-number">11</span> <span class="hljs-keyword">CURRENT</span>
# Failover三种情况：(上面查询的是正常运行的还没有Failover的情况)
# 第一种：如果逻辑Standby与<span class="hljs-keyword">Primary</span>的归档序号相同，但某些序号的APPLIED状态为<span class="hljs-keyword">NO</span>，建议检查当前逻辑Standby数据库是否启动了<span class="hljs-keyword">SQL</span>应用
# 第二种：如果逻辑Standby归档序号小于<span class="hljs-keyword">Primary</span>的归档序号，说明<span class="hljs-keyword">Primary</span>存在尚未发送至逻辑Standby数据库的归档文件，手工复制这些文件到待转换角色的逻辑Standby端，然后在该逻辑Standby数据库的<span class="hljs-keyword">SQL</span><span class="hljs-operator">*</span>Plus命令窗口，通过执行<span class="hljs-keyword">ALTER</span> DATABASE REGISTER LOGICAL LOGFILE <span class="hljs-string">'filepath'</span>; 命令，将复制过来的归档文件手工注册
# 第三种：如果<span class="hljs-keyword">Primary</span>数据库已经无法打开，就只好直接到磁盘上查看归档目录中的序号，来与逻辑Standby数据库做比较。如果<span class="hljs-keyword">Primary</span>数据库已经完全无法访问，那直接按照后面步骤进行操作
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-模拟Failover_215" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>模拟Failover</h4><blockquote data-block="0"><p data-block="0">将Primary关机或关闭数据库，模拟Failover</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-检查Standby日志情况_217" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>检查Standby日志情况</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 通过V$LOGSTDBY_PROGRESS视图，查询重做日志的应用情况
SQL&gt; SELECT APPLIED_SCN,LATEST_SCN FROM V$LOGSTDBY_PROGRESS;
APPLIED_SCN LATEST_SCN
----------- ----------
   12778829   12778829
# 如果返回的结果中显示，两列的列值一致，则表示所有接收到的重做日志都已经应用。如果不一致的话，启动逻辑Standby端的SQL应用。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 通过V$LOGSTDBY_PROGRESS视图，查询重做日志的应用情况
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> APPLIED_SCN,LATEST_SCN <span class="hljs-keyword">FROM</span> V$LOGSTDBY_PROGRESS;
APPLIED_SCN LATEST_SCN
<span class="hljs-comment">----------- ----------</span>
   <span class="hljs-number">12778829</span>   <span class="hljs-number">12778829</span>
# 如果返回的结果中显示，两列的列值一致，则表示所有接收到的重做日志都已经应用。如果不一致的话，启动逻辑Standby端的<span class="hljs-keyword">SQL</span>应用。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-激活前检查_219" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>激活前检查</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 确认待转换的逻辑Standby配置了正确的归档路径和远端服务器的归档配置(前面设置部分都配置过)
SQL&gt; SHOW PARAMETER LOG_ARCHIVE_DEST
# 查看当前操作的角色：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE,FORCE_LOGGING FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE    FORCE_LOGGING
-------------------- ---------------- ---------------------------------------
NOT ALLOWED          LOGICAL STANDBY  YES
# 如果当前FORCE_LOGGING为NO，务必执行ALTER DATABASE FORCE LOGGING;命令。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 确认待转换的逻辑Standby配置了正确的归档路径和远端服务器的归档配置(前面设置部分都配置过)
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">PARAMETER</span> LOG_ARCHIVE_DEST
# 查看当前操作的角色：
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE,FORCE_LOGGING <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE    FORCE_LOGGING
<span class="hljs-comment">-------------------- ---------------- ---------------------------------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          LOGICAL STANDBY  YES
# 如果当前FORCE_LOGGING为<span class="hljs-keyword">NO</span>，务必执行<span class="hljs-keyword">ALTER</span> DATABASE FORCE LOGGING;命令。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-激活新的Primary数据库_221" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>激活新的Primary数据库</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 转换Standby数据库角色为Primary
SQL&gt; ALTER DATABASE ACTIVATE LOGICAL STANDBY DATABASE FINISH APPLY; 
Database altered.
# 该语句主要是停止待转换的逻辑Standby中RFS进程，并应用完当前所有已接收但并未应用的REDO数据，然后停止SQL应用，将数据库转换成Primary角色
# 再次查看当前数据库的角色
SQL&gt; SELECT DATABASE_ROLE,FORCE_LOGGING FROM V$DATABASE; 
DATABASE_ROLE    FORCE_LOGGING
---------------- ---------------------------------------
PRIMARY          YES
# 至此完成Failover后角色的转换了
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 转换Standby数据库角色为<span class="hljs-keyword">Primary</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE ACTIVATE LOGICAL STANDBY DATABASE FINISH APPLY; 
Database altered.
# 该语句主要是停止待转换的逻辑Standby中RFS进程，并应用完当前所有已接收但并未应用的REDO数据，然后停止<span class="hljs-keyword">SQL</span>应用，将数据库转换成<span class="hljs-keyword">Primary</span>角色
# 再次查看当前数据库的角色
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> DATABASE_ROLE,FORCE_LOGGING <span class="hljs-keyword">FROM</span> V$DATABASE; 
DATABASE_ROLE    FORCE_LOGGING
<span class="hljs-comment">---------------- ---------------------------------------</span>
<span class="hljs-keyword">PRIMARY</span>          YES
# 至此完成Failover后角色的转换了
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-Failover恢复-_223" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>Failover恢复</h3><blockquote data-block="0"><p data-block="0">上面这种情形是当主库真正出现异常之后，才会执行的Failover操作；执行过failover之后，如何在重新构建之前老的逻辑主库DG</p></blockquote><h4 data-block="0" class="vditor-ir__node" id="ir-DB-LINK连接主备_225" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>DB_LINK连接主备</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 在需要重构的库中执行
# ALTER SESSION ENABLE|DISABLE GUARD的作用
# 该语句用于允许或禁止用户修改逻辑Standby中的结构
# 直接修改会报错：
SQL&gt; ALTER SESSION DISABLE GUARD;
# 创建DB_LINK
SQL&gt; CREATE DATABASE LINK link_orcllg CONNECT TO system IDENTIFIED BY Oracle#2020 USING '192.168.2.2:1521/orcl'; 
SQL&gt; ALTER SESSION ENABLE GUARD;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 在需要重构的库中执行
# <span class="hljs-keyword">ALTER</span> SESSION ENABLE<span class="hljs-operator">|</span>DISABLE GUARD的作用
# 该语句用于允许或禁止用户修改逻辑Standby中的结构
# 直接修改会报错：
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> SESSION DISABLE GUARD;
# 创建DB_LINK
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">CREATE</span> DATABASE LINK link_orcllg <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">system</span> IDENTIFIED <span class="hljs-keyword">BY</span> Oracle#<span class="hljs-number">2020</span> <span class="hljs-keyword">USING</span> <span class="hljs-string">'192.168.2.2:1521/orcl'</span>; 
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> SESSION ENABLE GUARD;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-启动同步_227" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>启动同步</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 使用link同步新主库
SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY NEW PRIMARY link_orcllg;
Database altered.
# 后面开关机可以正常使用下面SQL应用redo
# SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 使用link同步新主库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">START</span> LOGICAL STANDBY APPLY <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">PRIMARY</span> link_orcllg;
Database altered.
# 后面开关机可以正常使用下面<span class="hljs-keyword">SQL</span>应用redo
# <span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">START</span> LOGICAL STANDBY APPLY IMMEDIATE;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h4 data-block="0" class="vditor-ir__node" id="ir-查看状态并验证_229" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">#### </span>查看状态并验证</h4><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库
# 主库存在GAP
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
RESOLVABLE GAP       PRIMARY
# 备库
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          LOGICAL STANDBY
# ==解决=====================================
# 新主库关闭启动到mount
shutdown immediate
startup mount
# 把新主库REDO FLUSH到新备库
# 此处是orcl是新主库，在新主库上将日志flush到新备库orcldg上
# ALTER SYSTEM FLUSH REDO TO target_db_name;其中target_db_name使用DB_UNIQUE_NAME
ALTER SYSTEM FLUSH REDO TO orcldg;
# 再次查看新主库状态，再测试数据已经同步
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          PRIMARY
# 开启数据库
alter database open;
# 数据验证
insert into scott.test values(900);
commit;
select * from scott.test;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库
# 主库存在GAP
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
RESOLVABLE GAP       <span class="hljs-keyword">PRIMARY</span>
# 备库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          LOGICAL STANDBY
# <span class="hljs-operator">=</span><span class="hljs-operator">=</span>解决<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
# 新主库关闭启动到mount
shutdown immediate
startup mount
# 把新主库REDO FLUSH到新备库
# 此处是orcl是新主库，在新主库上将日志flush到新备库orcldg上
# <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> FLUSH REDO <span class="hljs-keyword">TO</span> target_db_name;其中target_db_name使用DB_UNIQUE_NAME
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> FLUSH REDO <span class="hljs-keyword">TO</span> orcldg;
# 再次查看新主库状态，再测试数据已经同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> SWITCHOVER_STATUS,DATABASE_ROLE <span class="hljs-keyword">FROM</span> V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
<span class="hljs-comment">-------------------- ----------------</span>
<span class="hljs-keyword">NOT</span> ALLOWED          <span class="hljs-keyword">PRIMARY</span>
# 开启数据库
<span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
# 数据验证
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> scott.test <span class="hljs-keyword">values</span>(<span class="hljs-number">900</span>);
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> scott.test;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir--方式五-快照备库Snapshot-_231" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>【方式五：快照备库Snapshot】</h2><blockquote data-block="0"><p data-block="0">继  方式一：物理备库之RMAN Duplicate  后的操作，快照备库是11g开始有的特性</p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell">在Dataguard中，可以将standby备库切换为snapshot快照数据库，在切换为snapshot数据库后，备库将置于可读写的模式。  
运用的场景：可用于模拟业务功能测试，备库处于快照备库模式后，可将备库置于可读写的状态，用于不方便在生产环境主库的测试内容,比如模拟线上测试等内容。快照模式的备库可以反复测试，在使用完成之后，可以将快照数据库切换为物理备库，则之前所有在快照备库上的操作都丢失，一般快照备库操作的数据越大，恢复回物理备库时间越长。
在快照备库期间，备库可以接受主库传输过来的日志，但是不能应用日志，需要处于物理备库的时候才可以应用。  
当快照备库转回为物理备库时，所有在快照备库的操作被丢弃后，物理快照才会应用主库的redo数据。
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;">在Dataguard中，可以将standby备库切换为snapshot快照数据库，在切换为snapshot数据库后，备库将置于可读写的模式。  
运用的场景：可用于模拟业务功能测试，备库处于快照备库模式后，可将备库置于可读写的状态，用于不方便在生产环境主库的测试内容,比如模拟线上测试等内容。快照模式的备库可以反复测试，在使用完成之后，可以将快照数据库切换为物理备库，则之前所有在快照备库上的操作都丢失，一般快照备库操作的数据越大，恢复回物理备库时间越长。
在快照备库期间，备库可以接受主库传输过来的日志，但是不能应用日志，需要处于物理备库的时候才可以应用。  
当快照备库转回为物理备库时，所有在快照备库的操作被丢弃后，物理快照才会应用主库的redo数据。
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-备库停止Redo-apply应用_233" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库停止Redo apply应用</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 确保备库指定闪回区域
SQL&gt; show parameter db_recov
NAME                                 TYPE        VALUE
------------------------------------ ----------- ----------------------------------
db_recovery_file_dest                string      /u01/app/oracle/fast_recovery_area
db_recovery_file_dest_size           big integer 4560M
# 停止Redo应用
SQL&gt; alter database recover managed standby database cancel;
Database altered.
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 确保备库指定闪回区域
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> <span class="hljs-keyword">parameter</span> db_recov
NAME                                 TYPE        <span class="hljs-keyword">VALUE</span>
<span class="hljs-comment">------------------------------------ ----------- ----------------------------------</span>
db_recovery_file_dest                string      <span class="hljs-operator">/</span>u01<span class="hljs-operator">/</span>app<span class="hljs-operator">/</span>oracle<span class="hljs-operator">/</span>fast_recovery_area
db_recovery_file_dest_size           big <span class="hljs-type">integer</span> <span class="hljs-number">4560</span>M
# 停止Redo应用
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database cancel;
Database altered.
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-备库到mount状态_235" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>备库到mount状态</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 确保数据库是否处于mount状态
SQL&gt; select open_mode,database_role,protection_mode,protection_level from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
-------------------- ---------------- -------------------- --------------------
MOUNTED              PHYSICAL STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 确保数据库是否处于mount状态
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode,database_role,protection_mode,protection_level <span class="hljs-keyword">from</span> v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
<span class="hljs-comment">-------------------- ---------------- -------------------- --------------------</span>
MOUNTED              PHYSICAL STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-转换为快照备库_237" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>转换为快照备库</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; ALTER DATABASE CONVERT TO SNAPSHOT STANDBY;
Database altered.
# 查看
SQL&gt; select open_mode,database_role,protection_mode,protection_level from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
-------------------- ---------------- -------------------- --------------------
MOUNTED              SNAPSHOT STANDBY MAXIMUM PERFORMANCE  UNPROTECTED
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CONVERT</span> <span class="hljs-keyword">TO</span> SNAPSHOT STANDBY;
Database altered.
# 查看
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode,database_role,protection_mode,protection_level <span class="hljs-keyword">from</span> v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
<span class="hljs-comment">-------------------- ---------------- -------------------- --------------------</span>
MOUNTED              SNAPSHOT STANDBY MAXIMUM PERFORMANCE  UNPROTECTED
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-快照备库到open状态_239" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>快照备库到open状态</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 备库到open可读可写状态
SQL&gt; alter database open;
# 查看 OPEN_MODE
SQL&gt; select open_mode,database_role,protection_mode,protection_level from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
-------------------- ---------------- -------------------- --------------------
READ WRITE           SNAPSHOT STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 备库到<span class="hljs-keyword">open</span>可读可写状态
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database <span class="hljs-keyword">open</span>;
# 查看 OPEN_MODE
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode,database_role,protection_mode,protection_level <span class="hljs-keyword">from</span> v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
<span class="hljs-comment">-------------------- ---------------- -------------------- --------------------</span>
READ WRITE           SNAPSHOT STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-快照备库对主库的日志接收_241" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>快照备库对主库的日志接收</h3><blockquote data-block="0"><p data-block="0">当主库切换日志时，备库依然可以接受日志，只是不应用</p></blockquote><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 主库切换日志
SQL&gt; alter system archive log current;
# 主备都是相同的序号
SQL&gt; select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
            88
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 主库切换日志
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> archive log <span class="hljs-keyword">current</span>;
# 主备都是相同的序号
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(sequence#) <span class="hljs-keyword">from</span> v$archived_log;
<span class="hljs-built_in">MAX</span>(SEQUENCE#)
<span class="hljs-comment">--------------</span>
            <span class="hljs-number">88</span>
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​shell</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-shell"># 查看日志alert日志位置
SQL&gt; select name,value from V$diag_info where name in('Diag Trace','Diag Alert'); 
# 主库alert信息
[oracle@klaus trace]$ cat /u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log 
Wed Aug 25 21:52:16 2021
ALTER SYSTEM ARCHIVE LOG
Wed Aug 25 21:52:16 2021
Thread 1 advanced to log sequence 89 (LGWR switch)
  Current log# 2 seq# 89 mem# 0: /u01/app/oracle/oradata/orcl/redo02.log
Wed Aug 25 21:52:16 2021
Archived Log entry 67 added for thread 1 sequence 88 ID 0x5df896fc dest 1:
Wed Aug 25 21:52:16 2021
TT00: Standby redo logfile selected for thread 1 sequence 89 for destination LOG_ARCHIVE_DEST_2
# 备库alert信息
RFS[3]: Selected log 5 for thread 1 sequence 89 dbid 1576583420 branch 1048802686
Wed Aug 25 21:52:15 2021
Archived Log entry 16 added for thread 1 sequence 88 ID 0x5df896fc dest 1:
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-shell hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-meta">#</span><span class="bash"> 查看日志alert日志位置</span>
<span class="hljs-meta">SQL&gt;</span><span class="bash"> select name,value from V<span class="hljs-variable">$diag_info</span> <span class="hljs-built_in">where</span> name <span class="hljs-keyword">in</span>(<span class="hljs-string">'Diag Trace'</span>,<span class="hljs-string">'Diag Alert'</span>);</span> 
<span class="hljs-meta">#</span><span class="bash"> 主库alert信息</span>
[oracle@klaus trace]$ cat /u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log 
Wed Aug 25 21:52:16 2021
ALTER SYSTEM ARCHIVE LOG
Wed Aug 25 21:52:16 2021
Thread 1 advanced to log sequence 89 (LGWR switch)
  Current log# 2 seq# 89 mem# 0: /u01/app/oracle/oradata/orcl/redo02.log
Wed Aug 25 21:52:16 2021
Archived Log entry 67 added for thread 1 sequence 88 ID 0x5df896fc dest 1:
Wed Aug 25 21:52:16 2021
TT00: Standby redo logfile selected for thread 1 sequence 89 for destination LOG_ARCHIVE_DEST_2
<span class="hljs-meta">#</span><span class="bash"> 备库alert信息</span>
RFS[3]: Selected log 5 for thread 1 sequence 89 dbid 1576583420 branch 1048802686
Wed Aug 25 21:52:15 2021
Archived Log entry 16 added for thread 1 sequence 88 ID 0x5df896fc dest 1:
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h3 data-block="0" class="vditor-ir__node" id="ir-快照备库可读写_245" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>快照备库可读写</h3><blockquote data-block="0"><p data-block="0">此时快照备库是可读写的 READ WRITE 状态</p><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">SQL&gt; select open_mode,database_role,protection_mode,protection_level from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
-------------------- ---------------- -------------------- --------------------
READ WRITE           SNAPSHOT STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode,database_role,protection_mode,protection_level <span class="hljs-keyword">from</span> v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
<span class="hljs-comment">-------------------- ---------------- -------------------- --------------------</span>
READ WRITE           SNAPSHOT STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div></blockquote><h3 data-block="0" class="vditor-ir__node" id="ir-恢复为物理备库_247" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">### </span>恢复为物理备库</h3><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql"># 备库到mount状态
shutdown immediate
startup mount
# 恢复到物理备库
SQL&gt; ALTER DATABASE CONVERT TO PHYSICAL STANDBY;
Database altered.
# 重新开启数据库
shutdown immediate
startup
# 开启同步
SQL&gt; alter database recover managed standby database using current logfile disconnect from session;

# 验证
SQL&gt; select open_mode,database_role,protection_mode,protection_level from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
-------------------- ---------------- -------------------- --------------------
READ ONLY WITH APPLY PHYSICAL STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
# 切换日志
SQL&gt; alter system archive log current;
SQL&gt; select max(sequence#) from v$archived_log;
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"># 备库到mount状态
shutdown immediate
startup mount
# 恢复到物理备库
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CONVERT</span> <span class="hljs-keyword">TO</span> PHYSICAL STANDBY;
Database altered.
# 重新开启数据库
shutdown immediate
startup
# 开启同步
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> database recover managed standby database <span class="hljs-keyword">using</span> <span class="hljs-keyword">current</span> logfile <span class="hljs-keyword">disconnect</span> <span class="hljs-keyword">from</span> session;

# 验证
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> open_mode,database_role,protection_mode,protection_level <span class="hljs-keyword">from</span> v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      PROTECTION_LEVEL
<span class="hljs-comment">-------------------- ---------------- -------------------- --------------------</span>
READ <span class="hljs-keyword">ONLY</span> <span class="hljs-keyword">WITH</span> APPLY PHYSICAL STANDBY MAXIMUM PERFORMANCE  MAXIMUM PERFORMANCE
# 切换日志
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> archive log <span class="hljs-keyword">current</span>;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(sequence#) <span class="hljs-keyword">from</span> v$archived_log;
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir-DG开关机顺序_249" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>DG开关机顺序</h2><div data-block="0" data-type="code-block" class="vditor-ir__node"><span data-type="code-block-open-marker">```</span><span class="vditor-ir__marker vditor-ir__marker--info" data-type="code-block-info">​sql</span><pre class="vditor-ir__marker--pre vditor-ir__marker"><code class="language-sql">---------------------------------------------------------------------------------
# 启动顺序：先启动备库，后启动主库
# 关闭顺序：先关闭主库，后关闭备库
---------------------------------------------------------------------------------
# 1、正确开启顺序
# 备库:
SQL&gt; STARTUP MOUNT
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE  DISCONNECT FROM SESSION;
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		# 逻辑备库:
			SQL&gt; STARTUP
			SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE; 
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 主库:
SQL&gt; STARTUP
---------------------------------------------------------------------------------
# 2、正确关闭顺序
# 主库:
SQL&gt; SHUTDOWN IMMEDIATE
# 备库:
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		# 逻辑备库:
		SQL&gt; ALTER DATABASE STOP LOGICAL STANDBY APPLY;
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
SQL&gt; SHUTDOWN IMMEDIATE
</code></pre><pre class="vditor-ir__preview" data-render="1"><div class="vditor-copy"><textarea></textarea><span aria-label="复制" onmouseover="this.setAttribute('aria-label', '复制')" class="vditor-tooltipped vditor-tooltipped__w" onclick="this.previousElementSibling.select();document.execCommand('copy');this.setAttribute('aria-label', '复制')"><svg viewBox="0 0 32 32"><path d="M22.545-0h-17.455c-1.6 0-2.909 1.309-2.909 2.909v20.364h2.909v-20.364h17.455v-2.909zM26.909 5.818h-16c-1.6 0-2.909 1.309-2.909 2.909v20.364c0 1.6 1.309 2.909 2.909 2.909h16c1.6 0 2.909-1.309 2.909-2.909v-20.364c0-1.6-1.309-2.909-2.909-2.909zM26.909 29.091h-16v-20.364h16v20.364z"></path></svg></span></div><code class="language-sql hljs vditor-linenumber" style="max-height: 1026px;"><span class="hljs-comment">---------------------------------------------------------------------------------</span>
# 启动顺序：先启动备库，后启动主库
# 关闭顺序：先关闭主库，后关闭备库
<span class="hljs-comment">---------------------------------------------------------------------------------</span>
# <span class="hljs-number">1</span>、正确开启顺序
# 备库:
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> STARTUP MOUNT
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE RECOVER MANAGED STANDBY DATABASE  <span class="hljs-keyword">DISCONNECT</span> <span class="hljs-keyword">FROM</span> SESSION;
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
		# 逻辑备库:
			<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> STARTUP
			<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">START</span> LOGICAL STANDBY APPLY IMMEDIATE; 
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
# 主库:
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> STARTUP
<span class="hljs-comment">---------------------------------------------------------------------------------</span>
# <span class="hljs-number">2</span>、正确关闭顺序
# 主库:
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> SHUTDOWN IMMEDIATE
# 备库:
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
		# 逻辑备库:
		<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> DATABASE STOP LOGICAL STANDBY APPLY;
<span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> SHUTDOWN IMMEDIATE
<div class="vditor-linenumber__temp" style="display: none;"></div><span class="vditor-linenumber__rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span data-type="code-block-close-marker">```</span></div><h2 data-block="0" class="vditor-ir__node" id="ir-DG维护相关_251" data-marker="#"><span class="vditor-ir__marker vditor-ir__marker--heading" data-type="heading-marker">## </span>DG维护相关</h2></pre></div><div class="vditor-preview" style="display: none;"><div class="vditor-preview__action"><button type="button" class="vditor-preview__action--current" data-type="desktop">Desktop</button><button type="button" data-type="tablet">Tablet</button><button type="button" data-type="mobile">Mobile/Wechat</button><button type="button" data-type="mp-wechat" class="vditor-tooltipped vditor-tooltipped__w" aria-label="复制到公众号"><svg><use xlink:href="#vditor-icon-mp-wechat"></use></svg></button><button type="button" data-type="zhihu" class="vditor-tooltipped vditor-tooltipped__w" aria-label="复制到知乎"><svg><use xlink:href="#vditor-icon-zhihu"></use></svg></button></div><div class="vditor-reset" style="max-width: 800px;"></div></div><div class="vditor-upload"></div><div class="vditor-hint" style="display: none;"></div><div class="vditor-tip"></div></div><iframe style="width: 100%;height: 0;border: 0"></iframe></div>
                        <label for="text" class="sr-only">文章内容</label>
                        <textarea style="height: 350px" autocomplete="off" id="text" name="text" class="w-100 mono">&lt;center&gt;

    &lt;font style="font-weight:bold" size=4&gt;
        【DG部署】【单机DB+单实例DG】
    &lt;/font&gt;
&lt;/center&gt;

## Dataguard介绍

### 概念

&gt; Data Guard是保证企业数据的高可用性（high availability）、数据保护（data 
protection）以及灾难恢复（disaster 
recovery）的集成化灾难恢复解决方案，该技术可以维护生产数据库一个或多个同步备份，有一个生产数据库和若干个备用数据库组成，并形成一个独立
的、易于管理的数据保护方案。Data Guard备用数据库可以与生产系统位于相同的数据中心，也可以是在地理位置上分布较远的的远程灾难备份中心。

### 原理

&gt; Data 
Guard的基本原理是，当某次事务处理对生产数据库中的数据作出更改时，Oracle将在联机重做日志文件中记录此次更改。在Data 
Guard中，除了把日志记录到本地的联机日志文件和归档日志文件中外，还通过网络，把日志信息发送到远程的备用数据库服务器上。这个备用日志文件写入过
程可以是实时、同步的，以实现零数据丢失（最大保护模式）；也可以是异步的，以减少对网络带宽的压力（最大可用性模式）；或者是通过归档日志文件的批量传
输模式，以减少对生产系统的性能影响（最大性能模式）。

&gt; 当备份数据库接收到日志信息时，Data 
Guard可以自动利用日志信息实现数据的同步。当主数据库打开并处于活动状态时，备份数据库可以执行恢复操作；如果主数据出现了故障，备用数据库即可以
被激活并接管生产数据库的工作。

### 特点

&gt; 1、需要冗余的服务器设备	该模式需要有冗余的服务器硬件，硬件成本较高。
&gt; 2、需要冗余的存储设备		主机和备机都需要同样的存储空间，成本较高。
&gt; 3、安装配置比较复杂			该模式比单节点、单实例的模式配置复杂一些，需要更多的配置步骤。
&gt; 4、管理维护成本高            	该模式对维护人员的要求较高，维护成本高。
&gt; 5、具备一定的容灾特性		当主机数据库不可用并短期内无法恢复时，可以把数据库系统切换到备机上，具备容灾的功能。
&gt; 6、备机可以用作只读查询	备机可以切换到只读状态供报表之类的查询操作，减轻主机的压力。

### 搭建DG方式

&gt; Data Guard备库按照从生产数据库传输过来的日志处理方法的不同分为物理备库、逻辑备库和快照备库。
&gt;
&gt; ```shell
&gt; # 物理备库 (三种方法：1、RMAN的Duplicate 2、RMAN的备份恢复 3、DBCA )
&gt; 
备份数据库处于mount状态下，直接利用数据恢复技术，把日志文件中记录的数据变更应用在备份数据库中，从而实现与生产数据库的数据同步，在进行数据同
步的时候，物理备份数据库是不能打开的、也无法提供数据查询等服务；物理备用数据库也可以通过只读的方式打开，此时就只能接收日志文件，而无法进行数据的
同步。
&gt; # 逻辑备库
&gt; 
数据库是处于正常打开状态，当它接收到新的日志信息后，利用日志挖掘器的功能，把日志中记录的变更信息转换成具体的SQL语句，并在逻辑备用数据库上执行
这些SQL语句，从而实现与生产数据库的数据同步。逻辑备份数据支持在数据同步时，进行数据的查询、报表等操作。Oracle从9i 
R2开始支持逻辑备份数据库。
&gt; # 快照备库
&gt; 可以暂时将物理备份数据库转换为可更新的数据库，快照备份数据不会立马应用接收到的日志文件，设一个时间点，一次性转换。
&gt; ```

### 备库数据保护级别

&gt; Oracle Data Guard 
支持多种级别的数据保护模式：最大性能模式，最大可用性模式，最大保护模式。分别对应于“重要信息系统灾难恢复指南”中的5级，5级6级自适应，6级的数
据保护级别。其中对应6级的最大保护模式可以实现实时数据实时同步和0数据丢失。另外，Oracle Data Guard 
可以设置延时应用时间窗口，从而防范错误操作、黑客攻击等人为错误导致的数据损坏。

#### 保护模式和重做传输

&gt; 
要确定适当的保护模式，企业需要根据用户对系统响应时间的要求来估量它们对数据保护的业务要求。下表从数据丢失风险的角度概述了各种模式的适用性。


| 保护模式 | 在灾难出现时数据丢失的风险 | 重做传输机制    |
| ---------- | ---------------------------- | ----------------- |
| 最大保护 | 零数据丢失                 | LGWR SYNC       |
| 最大可用 | 零数据丢失                 | LGWR SYNC       |
| 最高性能 | 最小数据丢失               | LGWR SYNC或ARCH |

#### 最大保护模式

&gt; 
最大保护模式为主数据库提供了最高水平的数据保护，从而确保一个全面的零数据丢失的灾难恢复解决方案。当在最大保护模式下运行时，重做记录由日志写入器 
(LGWR) 进程从主数据库同步地传输到备用数据库，并且直到确认事务数据在至少一个备用服务器上的磁盘上可用时，才在主数据库上提交事务。
&gt;
&gt; 
强烈建议，这种模式应至少配置两个备用数据库。当最后参与的备用数据库不可用时，主数据库上的处理将停止。这就确保了当主数据库与其所有备用数据库失去联
系时，不会丢失事务。
&gt;
&gt; 
由于重做传输的同步特性，这种最大保护模式可能潜在地影响主数据库响应时间。可以通过配置一个低延迟网络，并为它分配足够应付高峰事务负载的带宽来将这种
影响减到最小。需要这种最大保护模式的企业有股票交易所、货币交易所、金融机构等。

#### 最大可用性模式

&gt; 最高可用性模式拥有仅次于最高水平的主数据库数据可用性。如同最大保护模式一样，重做数据由 LGWR 
从主数据库同步地传输到备用数据库，直到确认事务数据在备用服务器的磁盘上可用时，事务才在主数据库上完成。不过，在这种模式下（与最大保护模式不同），
如果最后参与的备用数据库变为不可用，例如由于网络连接问题，处理将在主数据库上继续进行。备用数据库与主数据库相比，可能暂时落在后面，但当它再次变为
可用时，备用数据库将使用主数据库上累积的归档日志自动同步，而不会丢失数据。
&gt;
&gt; 
由于同步重做传输，这种保护模式可潜在地影响响应时间和吞吐量。可以通过配置一个低延迟网络，并为它分配足够应付高峰事务负载的带宽来将这种影响减到最
小。
&gt;
&gt; 
最高可用性模式适用于想要确保获得零数据丢失保护，但不想让生产数据库受网络/备用服务器故障影响的企业。如果又一个故障随后影响了生产数据库，然后最初
的网络/备用服务器故障得到解决，那么这些企业将接受数据丢失的可能性。

#### 最高性能模式

&gt; 
最高性能模式是默认的保护模式。它与最高可用性模式相比，提供了稍微少一些的主数据库数据保护，但提供了更高的性能。在这种模式下，当主数据库处理事务
时，重做数据由 LGWR 进程异步传输到备用数据库上。另外，也可以将主数据库上的归档器进程 (ARCH) 
配置为在这种模式下传输重做数据。在任何情况下，均先完成主数据库上的写操作，主数据库的提交操作不等待备用数据库确认接收。如果任意备用目标数据库变为
不可用，则处理将在主数据库上继续进行，这对性能只有很小的影响或没有影响。
&gt;
&gt; 在主数据库出现故障的情况下，尚未被发送到备用数据库的重做数据会丢失。但是，如果网络有足够的吞吐量来跟上重做流量高峰，并且使用了 
LGWR 进程来将重做流量传输到备用服务器，则丢失的事务将非常少或者为零。
&gt;
&gt; 当主数据库上的可用性和性能比丢失少量数据的风险更重要时，应该使用最高性能模式。这种模式还适合于 WAN 上的 Data Guard 
部署，在 WAN 中，网络的内在延迟可能限制同步重做传输的适用性。

## 环境准备

### 环境规划

&gt; 实验基于单机DB+单实例DG
&gt; 注：备库中的实例名是参数设置的


|                | 主库(主机1)                             | 备库(主机2)        
                     |
| ---------------- | ----------------------------------------- | 
----------------------------------------- |
| DB 类型        | 单机                                    | 单机             
                       |
| OS             | Centos 7.8                              | Centos 7.8 
                             |
| Hostname       | Klaus                                   | Klausdg    
                             |
| IP             | 192.168.2.2                             | 192.168.2.3
                             |
| DB_Version     | 12.1.0.2                                | 12.1.0.2   
                             |
| ORACLE_BASE    | /u01/app/oracle                         | 
/u01/app/oracle                         |
| ORACLE_HOME    | /u01/app/oracle/product/12.1.0/dbhome_1 | 
/u01/app/oracle/product/12.1.0/dbhome_1 |
| DB_NAME        | orcl                                    | orcl       
                             |
| ORACLE_SID     | orcl                                    | orcldg     
                             |
| DB_Unique_Name | orcl                                    | orcldg     
                             |
| Instance_Name  | orcl                                    | orcldg     
                             |
| service_names  | orcl                                    | orcldg     
                             |
| TNS_Name       | ORCL                                    | ORCLDG     
                             |
| 闪回区         | 开启                                    | 开启              
                      |
| 归档           | 开启                                    | 开启             
                       |

### 数据库安装(略)

&gt; 在主库上安装数据库软件，并建监听和实例
&gt; 在备库上安装数据库软件，并建监听，但不创建实例，安装时选择只安装软件即可

## 主库配置

### CDB和Non CDB环境下

&gt; 如果实例处于多租户架构中，设置操作和Non-CDB方法相同，都在CDB下完成；
&gt; 实验中有两个PDB1和PDB2，在创建备库后，默认两个PDB都会同步到备库，也可以通过参数指定只同步某个PDB；
&gt; 也可以设置完同步的备库后，主库中再添加的PDB3也会同步到备库中。
&gt;
&gt; ```sql
&gt; # CDB环境下的实验配置中的主库实例也是orcl,备库是orcldg，需要设置主备不同的 DB_UNIQUE_NAME
&gt; # 同样可以通过name参数查看
&gt; SQL&gt; show parameter name
&gt; NAME                                 TYPE        VALUE
&gt; ------------------------------------ ----------- 
------------------------------
&gt; cdb_cluster_name                     string
&gt; cell_offloadgroup_name               string
&gt; db_file_name_convert                 string
&gt; db_name                              string      orcl
&gt; db_unique_name                       string      orcl
&gt; global_names                         boolean     FALSE
&gt; instance_name                        string      orcl
&gt; lock_name_space                      string
&gt; log_file_name_convert                string
&gt; pdb_file_name_convert                string
&gt; processor_group_name                 string
&gt; service_names                        string      orcl
&gt; ```

&gt; 涉及的CDB简单操作
&gt;
&gt; ```sql
&gt; # 查看当前处于的那个容器
&gt; SQL&gt; show con_name
&gt; CON_NAME
&gt; ------------------
&gt; CDB$ROOT
&gt; # 如果处于CDB，可以查看所有PDB
&gt; SQL&gt; show pdbs
&gt; CON_ID CON_NAME                       OPEN MODE  RESTRICTED
&gt; ---------- ------------------------------ ---------- ----------
&gt;    2 PDB$SEED                       READ ONLY  NO
&gt;    3 PDB1                           READ WRITE NO
&gt;    4 PDB2                           READ WRITE NO
&gt; # 切换到PDB1
&gt; SQL&gt; alter session set container=PDB1;
&gt; Session altered.
&gt; # 再次查看处于PDB1
&gt; SQL&gt; show pdbs
&gt; CON_ID CON_NAME                       OPEN MODE  RESTRICTED
&gt; ---------- ------------------------------ ---------- ----------
&gt;    3 PDB1                           READ WRITE NO
&gt; # 再次查看处于PDB1
&gt; SQL&gt; show con_name
&gt; CON_NAME
&gt; ------------------------------
&gt; PDB1
&gt; # 切回CDB
&gt; SQL&gt; alter session set container=CDB$ROOT;
&gt; Session altered.
&gt; ```

### 开启归档

```sql
# 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的
SQL&gt; show con_name
CON_NAME
------------------
CDB$ROOT
# 查看归档是否Enable
SQL&gt; archive log list
Database log mode				Archive Mode
Automatic archival				Enabled
Archive destination				USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence		129
Next log sequence to archive	131
Current log sequence			131
# 这里的归档路径是默认的 USE_DB_RECOVERY_FILE_DEST
# 如果没有开启，开启的步骤
shutdown immediate
startup mount
alter database archivelog;
alter database open;
SQL&gt; alter system switch logfile;
```

### 开启闪回

&gt; 
闪回区的管理，及闪回日志管理，数据库能闪回到过去的多久时间点，这个由闪回区大小以db_flashback_retention_target 
参数控制，在闪回区大小足够的情况，下默认能闪回1440秒也就是一天的数据。
&gt;
&gt; ```shell
&gt; SQL&gt; show parameter flashback
&gt; NAME                                 TYPE        VALUE
&gt; ------------------------------------ ----------- 
------------------------------
&gt; db_flashback_retention_target        integer     1440
&gt; ```

```sql
# 1、查看闪回未开启
SQL&gt; select flashback_on from v$database;
FLASHBACK_ON
------------
NO
# 2、查看 db_recovery_file_dest 为空
SQL&gt; show parameter recovery
NAME                                 TYPE        VALUE
------------------------------------ ----------- 
------------------------------
db_recovery_file_dest                string
db_recovery_file_dest_size           big integer 0
recovery_parallelism                 integer     0
remote_recovery_file_dest            string
# 3、指定闪回区大小，指定闪回目录路径(顺序必须先设置闪回区大小，才能指定闪回目录，否则报错)
SQL&gt; alter system set db_recovery_file_dest_size=4560m scope=spfile;
System altered.
SQL&gt; shutdown immediate
SQL&gt; startup
# 需要重启数据库才能生效，再继续修改目录位置，修改完目录也需要重启实例
# 4、先创建目录，在指定该闪回区域目录
mkdir -p /u01/app/oracle/fast_recovery_area
SQL&gt; alter system set 
db_recovery_file_dest='/u01/app/oracle/fast_recovery_area';
System altered.
SQL&gt; shutdown immediate
SQL&gt; startup
# 5 开启闪回
SQL&gt; alter database flashback on;
Database altered.
```

### 开启所有PDB

&gt; 如果是CDB环境，开启所有PDB

```sql
col name for a10
SQL&gt; select name,open_mode from v$pdbs;
NAME                           OPEN_MODE
------------------------------ ------------------------------
PDB$SEED                       READ ONLY
PDB1                           MOUNTED
PDB2                           MOUNTED
# 开启 PDB
SQL&gt; alter pluggable database all open;
Pluggable database altered.
# 查看

SQL&gt; select name,open_mode from v$pdbs;
NAME       OPEN_MODE
---------- ----------
PDB$SEED   READ ONLY
PDB1       READ WRITE
PDB2       READ WRITE
```

### 设置数据库强制归档

&gt; 有一些DDL语句可以通过指定NOLOGGING子句的方式避免写REDO(目的是提高速度，某些时候确实有效)。指定数据库为Force 
Logging模式后，数据库将会记录除临时表空间或临时回滚段外所有的操作，而忽略类似NOLOGGING之类的指定参数。如果在执行Force 
Logging时有NOLOGGING之类的语句在执行，那么Force Logging会等待，直到这类语句全部执行。
&gt;
&gt; Force 
Logging是作为固定参数保存在控制文件中，因此其不受重启之类操作的影响(只执行一次即可)，如果想取消，可以通过ALTER DATABASE 
NO FORCE LOGGING语句关闭强制记录。

```sql
# 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的
# 查看
SQL&gt; SELECT NAME, OPEN_MODE, FORCE_LOGGING FROM V$DATABASE;
NAME       OPEN_MODE            FORCE_LOGGING
---------- -------------------- ---------------------------------------
ORCL       READ WRITE           NO
# **开启强制归档**
SQL&gt; alter database force logging;
```

### 添加Standby redo log

#### 说明：

&gt; 为主库添加standby redo log后，备库自动同步，所以备库不用再创建standby redo log
&gt; Data Guard在最大保护和最高可用性模式下，Standby数据库必须配置standby redo log

#### 作用：

&gt; 实际上就是与主库接收到的重做日志相对应，也就是说备库调用RFS进程将主库接收到的重做日志按顺序导入到standby logfile
&gt; 在主库创建Standby logfile是便于发生角色转换后备用

#### 创建原则：

&gt; 确保Standby redo log的大小与主库online redo log的大小一致
&gt; 如果主库为单实例数据库：Standby redo log组数=主库日志总数+1
&gt; 如果主库是RAC数据库：Standby redo log组数=(每线程的日志数+1)*最大线程数
&gt; 不建议复用Standby redo log，避免增加额外的I/O以及延缓重做传输

```sql
# 如果是CDB环境，先检查处于CDB根容器中，PDB下是不允许的；
# 在Oracle 12c的架构里，online redo log 和控制文件是保存在CDB中的，PDB中只有运行需要的数据文件；  
# 所以如果是CDB下，就在CDB中加 Standby redo log。
# 1、查看组数=3
SQL&gt; select count(group#),thread# from v$log group by thread#;
COUNT(GROUP#)	THREAD#
------------	--------
3				1
# 2、大小=50M
SQL&gt; select group#,bytes/1024/1024 from v$log;
GROUP#	BYTES/1024/1024
------	---------------
1		50
2		50
3		50
# 3、创建standby logfile(3+1组、每组50M)
	#	注意路径大小写，本文部署CDB环境时，SID是大写的ORCL
SQL&gt; select * from v$standby_log;
alter database add standby logfile group 4 
('/u01/app/oracle/oradata/orcl/stantby_redo04.log') size 50m;
alter database add standby logfile group 5 
('/u01/app/oracle/oradata/orcl/stantby_redo05.log') size 50m;
alter database add standby logfile group 6 
('/u01/app/oracle/oradata/orcl/stantby_redo06.log') size 50m;
alter database add standby logfile group 7 
('/u01/app/oracle/oradata/orcl/stantby_redo07.log') size 50m;
# 4、验证查看
SQL&gt; select * from v$standby_log;
SQL&gt; select group#,bytes/1024/1024 from v$standby_log;
GROUP#  BYTES/1024/1024
----------   ---------------
4         50
5         50
6         50
7         50
SQL&gt; select group#,status,type,member from v$logfile;
GROUP# STATUS TYPE MEMBER
---------- ------- ------- ----------------------------------
3     ONLINE /u01/app/oracle/oradata/orcl/redo03.log
2     ONLINE /u01/app/oracle/oradata/orcl/redo02.log
1     ONLINE /u01/app/oracle/oradata/orcl/redo01.log
4     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo04.log
5     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo05.log
6     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo06.log
7     STANDBY /u01/app/oracle/oradata/orcl/stantby_redo07.log
```

### 修改参数文件

#### 设置DB唯一名称

```sql
# 通常主库的DB名和唯一名相同,show参数查看
alter system set db_unique_name='orcl' scope=spfile;
# 其中dg_config填写的是主备库的db_unique_name
alter system set log_archive_config='DG_CONFIG=(orcl,orcldg)' 
scope=spfile;
```

#### 设置归档日志的路径

```bash
# =前后不能有空格，本地的archive路径没有修改，使用默认
alter system set log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST 
valid_for=(all_logfiles,all_roles) db_unique_name=orcl' scope=spfile;
alter system set log_archive_dest_2='SERVICE=ORCLDG ASYNC 
valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) db_unique_name=orcldg' 
scope=spfile;
# 第一个ORCLDG是备库tnsname.ora的连接名(最开头名称)
# 第二个orcldg是DB_UNIQUE_NAME
```

#### 启用设置的日志路径

```sql
alter system set log_archive_dest_state_1=enable scope=spfile;
alter system set log_archive_dest_state_2=enable scope=spfile;
```

#### 设置归档日志进程的最大数量

```sql
#（视实际情况调整）
alter system set log_archive_max_processes=30 scope=both;
```

#### 设置备库从哪个数据库获取归档日志

```sql
# 只对standby库有效，在主库上设置是为了在故障切换后，主库可以成为备库使用，值就是TNSNAME
# fal表示fetch archive log
# 
fal_client用于发送日志，fal_server用于接受日志。也即无论是主库或备库，fal_server=对方，fal_client=自己
alter system set fal_server=orcldg;
alter system set fal_client=orcl;
```

#### 设置文件管理模式

```sql
# 表示如果Primary数据库数据文件发生修改（如新建、重命名等）则按照本参数的设置在Standby数据库中作相应修改。
# 设为AUTO表示自动管理。设为MANUAL表示需要手工管理
# 此项设置为自动，不然在主库创建数据文件后，备库不会自动创建
alter system set standby_file_management=auto scope=spfile;
```

#### 主备文件路径

&gt; 如果主备库文件的存放路径不同，还需要设置以下两个参数（需要重启数据库生效）

```sql
# 小写的orcl
alter system set 
db_file_name_convert='/u01/app/oracle/oradata/orcldg','/u01/app/oracle/oradata/orcl'
 scope=spfile;
alter system set 
log_file_name_convert='/u01/app/oracle/oradata/orcldg','/u01/app/oracle/oradata/orcl'
 scope=spfile;
# 大写的ORCL
alter system set 
db_file_name_convert='/u01/app/oracle/oradata/ORCLDG','/u01/app/oracle/oradata/ORCL'
 scope=spfile;
alter system set 
log_file_name_convert='/u01/app/oracle/oradata/ORCLDG','/u01/app/oracle/oradata/ORCL'
 scope=spfile;
```

#### 设置数据库口令文件的使用模式

```sql
SQL&gt; show parameter remote_login_passwordfile
NAME						TYPE		VALUE
-------------------------	------		---------
remote_login_passwordfile	string		EXCLUSIVE
# 默认也是EXCLUSIVE
alter system set remote_login_passwordfile=EXCLUSIVE scope=spfile;
```

#### 设置默认监听

&gt; 此处直接让监听为空即可保持后面创建的默认静态监听，否则备库无法从参数文件启动
&gt; 或者如果想要设置监听值，也可以
&gt; alter system set local_listener='(DESCRIPTION 
=(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.2.2)(PORT=1521)))';

```sql
SQL&gt; show parameter local_listener;
NAME                                 TYPE        VALUE
------------------------------------ ----------- 
------------------------------
local_listener                       string      LISTENER_ORCL
alter system set local_listener='';
SQL&gt; show parameter local_listener;
NAME                                 TYPE        VALUE
------------------------------------ ----------- 
------------------------------
local_listener                       string
```

## 备库配置

### 变量环境

```sh
[oracle@klausdg ~]$ cat .bash_profile 
# .bash_profile
# Get the aliases and functions
if [ -f ~/.bashrc ]; then
    . ~/.bashrc
fi
# User specific environment and startup programs
PATH=$PATH:$HOME/.local/bin:$HOME/bin
export PATH
export EDITOR=vi
export ORACLE_SID=orcldg
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/12.1.0/dbhome_1
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib
export 
PATH=/u01/app/oracle/product/12.1.0/dbhome_1/bin:/bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/X11R6/bin
export
 PATH=$ORACLE_HOME/bin:$PATH
# 使变量生效
source ~/.bash_profile
```

### 主备库密码文件

```shell
# Data Guard环境中，数据库的sys用户名密码要相同，可直接将主库复制密码文件复制到备库
# 拷贝后备库的密码文件格式：ora+sid，Windows下格式为：PWD[sid].ora
scp $ORACLE_HOME/dbs/orapworcl 
oracle@192.168.2.3:$ORACLE_HOME/dbs/orapworcldg
```

### 修改参数文件

#### 复制主库参数文件

&gt; 备库的参数文件根据主库参数进行修改
&gt; 主库上创建pfile，然后拷贝给备库

```shell
SQL&gt; create pfile from spfile;
# 拷贝后的静态参数文件格式：init+sid.ora
$ scp $ORACLE_HOME/dbs/initorcl.ora 
oracle@192.168.2.3:$ORACLE_HOME/dbs/initorcldg.ora
```

#### 修改initorcldg.ora内容

```bash
orcl.__data_transfer_cache_size=0
orcl.__db_cache_size=1761607680
orcl.__java_pool_size=16777216
orcl.__large_pool_size=33554432
orcl.__oracle_base='/u01/app/oracle'#ORACLE_BASE set from environment
orcl.__pga_aggregate_target=822083584
orcl.__sga_target=2466250752
orcl.__shared_io_pool_size=117440512
orcl.__shared_pool_size=520093696
orcl.__streams_pool_size=0
# 修改为备库的orcldg
*.audit_file_dest='/u01/app/oracle/admin/orcldg/adump'
*.audit_trail='db'
*.compatible='12.1.0.2.0'
*.control_file_record_keep_time=19
# 修改为备库的orcldg
*.control_files='/u01/app/oracle/oradata/orcldg/control01.ctl' #Restore 
Controlfile
*.db_block_size=8192
*.db_domain=''
# 修改顺序主备路径和主库的相反
*.db_file_name_convert='/u01/app/oracle/oradata/orcl','/u01/app/oracle/oradata/orcldg'
#
 实例名相同
*.db_name='orcl'
# 修改实例唯一名
*.db_unique_name='orcldg'
*.db_recovery_file_dest='/u01/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=4560m
*.diagnostic_dest='/u01/app/oracle'
# 修改orcldgXDB
*.dispatchers='(PROTOCOL=TCP) (SERVICE=orcldgXDB)'
# 和主库配置顺序相反
*.fal_client='ORCLDG'
*.fal_server='ORCL'
# 使用默认监听
*.local_listener=''
# 和主库配置相同
*.log_archive_config='DG_CONFIG=(orcl,orcldg)'
# 修改为本库(备库)的唯一名
*.log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST 
valid_for=(all_logfiles,all_roles) db_unique_name=ocrldg'
# 服务名修改为连接主库TNS的ORCL，DB唯一名修改为主库的orcl
*.log_archive_dest_2='SERVICE=ORCL LGWR ASYNC 
valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) db_unique_name=orcl'
*.log_archive_dest_state_1='ENABLE'
*.log_archive_dest_state_2='ENABLE'
*.log_archive_max_processes=30
# 和主库配置相反
*.log_file_name_convert='/u01/app/oracle/oradata/orcl','/u01/app/oracle/oradata/orcldg'
*.nls_date_format='yyyy-mm-dd
 hh24:mi:ss'
*.open_cursors=300
*.pga_aggregate_target=780m
*.processes=300
*.remote_login_passwordfile='EXCLUSIVE'
*.sga_target=2341m
*.standby_file_management='AUTO'
*.undo_tablespace='UNDOTBS1'
*.utl_file_dir='/home/oracle/logmnr'
```

### 备库创建spfile

```sql
SQL&gt; create spfile from pfile;
File created.
SQL&gt; 
```

### 创建备库所需路径

&gt; Oracle建议一般控制文件至少三个，放在不同的地方，本文主库没有设置
&gt; 如果主库修改相关文件目录，拷贝过来的参数文件修改后也需要在备库中创建相关目录

```bash
# 每个人的环境不同，根据备库参数文件创建所需目录
mkdir -p /u01/app/oracle/admin/orcldg/adump
mkdir -p /u01/app/oracle/oradata/orcldg			#根据情况是否大写	mkdir -p 
/u01/app/oracle/oradata/ORCLDG
mkdir -p /u01/app/oracle/fast_recovery_area
```

## 主备库监听

### 开机自启动监听

&gt; 设置主备库自动开启监听
&gt; 不建议设置自动开启数据库,因为DG开关有先后顺序，要手动开启

```shell
## 修改/etc/rc.d/rc.local文件
su - root
\# vi /etc/rc.d/rc.local			# 增加一行(/etc/rc.local是/etc/rc.d/rc.local的软连接)
su - oracle -c 'lsnrctl start'
## 授权rc.local文件可执行权限
\# chmod +x /etc/rc.d/rc.local
```

### 主库注册静态监听

&gt; ```sql
&gt; # 静态注册的参数概念：
&gt; GLOBAL_DBNAME	:数据库服务名，默认和SID_NAME保持一致。在本例中这里需要填写PDB的服务名。
&gt; ORACLE_HOME		:实例运行的ORACLE_HOME目录，如果是集群环境这里也填写ORACLE的ORACLE_HOME目录。
&gt; SID_NAME		:数据库实例名。和数据库参数INSTANCE_NAME一致。
&gt; ```
&gt;
&gt; 使用Net Manager创建监听不容易出错，添加 Database 
Services，客户端如果没有添加hosts信息或DNS建议写IP
&gt; 如果是CDB环境，监听也是相同静态配置即可，无需配置PDB监听或TNS

```shell
[oracle@klaus admin]$ cat listener.ora 
# listener.ora Network Configuration File: 
/u01/app/oracle/product/12.1.0/dbhome_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcl)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = orcl)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.2)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
```

### 备库注册静态监听

```shell
[oracle@klausdg admin]$ cat listener.ora
# listener.ora Network Configuration File: 
/u01/app/oracle/product/12.1.0/dbhome_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcldg)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = orcldg)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.3)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
```

### 主备库TNS监听相同

```shell
[oracle@klausdg admin]$ cat tnsnames.ora
# tnsnames.ora Network Configuration File: 
/u01/app/oracle/product/12.1.0/dbhome_1/network/admin/tnsnames.ora
# Generated by Oracle configuration tools.

ORCLDG =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.3)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcldg)
    )
  )

ORCL =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.2.2)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )
```

### 主备连接测试

```shell
# 主备库监听重启
lsnrctl stop
lsnrctl start
# 主备测试
tnsping orcl
tnsping orcldg
# 测试登录 #
# 主库登陆 在密码文件拷贝后才可以登陆
[oracle@klaus ~]$ sqlplus sys/Oracle#2020@orcl as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:45:02 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit 
Production
With the Partitioning, OLAP, Advanced Analytics and Real Application 
Testing options
SQL&gt;
[oracle@klaus ~]$ sqlplus sys/Oracle#2020@orcldg as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:45:56 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to an idle instance.
SQL&gt;
# 备库登录
[oracle@klausdg ~]$ sqlplus sys/Oracle#2020@orcl as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:47:24 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit 
Production
With the Partitioning, OLAP, Advanced Analytics and Real Application 
Testing options
SQL&gt;
[oracle@klausdg ~]$ sqlplus sys/Oracle#2020@orcldg as sysdba
SQL*Plus: Release 12.1.0.2.0 Production on Mon Aug 16 01:47:58 2021
Copyright (c) 1982, 2014, Oracle. All rights reserved.
Connected to an idle instance.
SQL&gt;
```

## 【方式一：物理备库之RMAN Duplicate】

&gt; Duplicate  方式创建物理备库；通过这种方式直接在线从主库搭建物理备库。
&gt; 本次实验：Non-CDB环境

### 备库启动到nomount状态

```sql
# 使用pfile启动到nomount
[oracle@klausdg ~]$ sqlplus /  as sysdba
SQL&gt; startup nomount 
pfile='/u01/app/oracle/product/12.1.0/dbhome_1/dbs/initorcldg.ora';
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
# 创建Spfile
SQL&gt; create spfile from pfile;
SQL&gt; shutdown immediate;
# 启动到nomount
SQL&gt; startup nomount
```

### 登陆RMAN连接主备库

```sql
# 主库target/orcl 备库auxiliary/orcldg
# 主备库DB_NAME必须一致，主库是open状态，备库是nomount状态
[oracle@klausdg ~]$ rman target sys/Oracle#2020@orcl auxiliary 
sys/Oracle#2020@orcldg
Recovery Manager: Release 12.1.0.2.0 - Production on Mon Aug 16 16:54:46
 2021
Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights 
reserved.
connected to target database: ORCL (DBID=1576583420)
connected to auxiliary database: ORCL (not mounted)
RMAN&gt; 
```

### 开始 Duplicate

```sql
RMAN&gt; duplicate target database for standby from active database 
dorecover nofilenamecheck;
# 执行过程（略）
Starting Duplicate Db at 16-AUG-21
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=243 device type=DISK
current log archived
...
....
.....
media recovery complete, elapsed time: 00:00:01
Finished recover at 16-AUG-21
Finished Duplicate Db at 16-AUG-21
```

## 【方式二：物理备库之RMAN备份还原】

&gt; 使用  RMAN  备份恢复方法，将备份的文件和控制文件传到备库恢复
&gt; 本次实验：Non-CDB环境

### 主库RMAN全备

```shell
# 创建RMAN备份路径
mkdir -p /u01/rmanbackup
# RMAN备份
$ rman target /
RMAN&gt; backup database format='/u01/rmanbackup/FULL_%d_%T_%s.dbf';
Starting backup at 18-AUG-21
using target database control file instead of recovery catalog
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=19 device type=DISK
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
input datafile file number=00001 
name=/u01/app/oracle/oradata/orcl/system01.dbf
input datafile file number=00003 
name=/u01/app/oracle/oradata/orcl/sysaux01.dbf
input datafile file number=00004 
name=/u01/app/oracle/oradata/orcl/undotbs01.dbf
input datafile file number=00005 
name=/u01/app/oracle/oradata/orcl/test.dbf
input datafile file number=00006 
name=/u01/app/oracle/oradata/orcl/users01.dbf
channel ORA_DISK_1: starting piece 1 at 18-AUG-21
channel ORA_DISK_1: finished piece 1 at 18-AUG-21
piece handle=/u01/rmanbackup/FULL_ORCL_20210818_1.dbf 
tag=TAG20210818T220447 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:01:25
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
including current control file in backup set
including current SPFILE in backup set
channel ORA_DISK_1: starting piece 1 at 18-AUG-21
channel ORA_DISK_1: finished piece 1 at 18-AUG-21
piece handle=/u01/rmanbackup/FULL_ORCL_20210818_2.dbf 
tag=TAG20210818T220447 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:01
Finished backup at 18-AUG-21
```

### 主库备份控制文件

```shell
RMAN&gt; backup current controlfile for standby format 
'/u01/rmanbackup/control.bak';
```

### 拷贝备份文件到备库

```shell
# 创建和主库相同的路径
mkdir -p /u01/rmanbackup
[oracle@klaus ~]$ cd /u01/rmanbackup/
[oracle@klaus rmanbackup]$ ls
control.bak  FULL_ORCL_20210818_1  FULL_ORCL_20210818_2
# 传输文件到备库改路径下
[oracle@klaus rmanbackup]$ scp /u01/rmanbackup/* 
oracle@192.168.2.3:/u01/rmanbackup
oracle@192.168.2.3's password: 
control.bak					100% 9888KB  36.6MB/s   00:00  
FULL_ORCL_20210818_1.dbf	100% 1299MB  51.9MB/s   00:25  
FULL_ORCL_20210818_2.dbf	100% 9920KB  18.0MB/s   00:00  
```

### 备库启动到nomount状态

```sql
# 使用pfile启动到nomount
# 如果已经创建spfile可以直接启动到 nomount状态
[oracle@klausdg ~]$ echo $ORACLE_SID
orcldg
[oracle@klausdg ~]$ sqlplus / as sysdba
# 启动
SQL&gt; startup nomount 
pfile='/u01/app/oracle/product/12.1.0/dbhome_1/dbs/initorcldg.ora';
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
# 创建Spfile
SQL&gt; create spfile from pfile;
SQL&gt; shutdown immediate;
# 启动到nomount
SQL&gt; startup nomount
```

### 备库恢复控制文件

```shell
[oracle@klausdg ~]$ rman target /
RMAN&gt; restore standby controlfile from '/u01/rmanbackup/control.bak';
..
...
Finished restore at 18-AUG-21
```

### 备库mount

```sql
SQL&gt; alter database mount;
Database altered.
```

### 还原数据库

```shell
RMAN&gt; restore database;
Starting restore at 19-AUG-21
released channel: ORA_DISK_1
Starting implicit crosscheck backup at 19-AUG-21
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=355 device type=DISK
Crosschecked 2 objects
Finished implicit crosscheck backup at 19-AUG-21
Starting implicit crosscheck copy at 19-AUG-21
using channel ORA_DISK_1
Crosschecked 2 objects
Finished implicit crosscheck copy at 19-AUG-21
searching for all files in the recovery area
cataloging files...
no files cataloged
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile backup set restore
channel ORA_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_DISK_1: restoring datafile 00001 to 
/u01/app/oracle/oradata/orcldg/system01.dbf
channel ORA_DISK_1: restoring datafile 00003 to 
/u01/app/oracle/oradata/orcldg/sysaux01.dbf
channel ORA_DISK_1: restoring datafile 00004 to 
/u01/app/oracle/oradata/orcldg/undotbs01.dbf
channel ORA_DISK_1: restoring datafile 00005 to 
/u01/app/oracle/oradata/orcldg/test.dbf
channel ORA_DISK_1: restoring datafile 00006 to 
/u01/app/oracle/oradata/orcldg/users01.dbf
channel ORA_DISK_1: reading from backup piece 
/u01/rmanbackup/FULL_ORCL_20210818_1.dbf
channel ORA_DISK_1: piece 
handle=/u01/rmanbackup/FULL_ORCL_20210818_1.dbf tag=TAG20210818T235901
channel ORA_DISK_1: restored backup piece 1
channel ORA_DISK_1: restore complete, elapsed time: 00:00:35
Finished restore at 19-AUG-21

```

## 【方式三：物理备库之CDB下的DBCA】

### DBCA备库说明

&gt; 
前两个物理备库方式都是基于Non-CDB创建DG的，也可以在CDB下通过Duplicate或RMAN备份还原的方法创建DG，配置主备库的条件相
同，处于CDB状态下设置主库的配置即可；
&gt; 到 12cR2 (12.2.0.1)后，新增  DBCA  方式直接建立物理备库的方法。但是对版本和实例环境有一定限制条件：
&gt; **12cR2中:**
&gt;
&gt; ```sql
&gt; # 1、12cR2 主库必须是单机环境，非 RAC 数据库；
&gt; # 若主库是 RAC 数据库，错误如下：
&gt; [FATAL] [DBT-16056] Specified primary database is not a Single 
Instance (SI) database.
&gt; CAUSE: Duplicate database operation is supported only for SI 
databases.
&gt; ```
&gt;
&gt; ```sql
&gt; # 2、12cR2 主库必须是非 CDB 环境；
&gt; # 若主库是 CDB 环境，错误如下：
&gt; [FATAL] [DBT-16057] Specified primary database is a container 
database (CDB).
&gt; CAUSE: Duplicate database operation is supported only for non 
container databases.
&gt; ```
&gt;
&gt; **18c 及以后:**
&gt; 18c(12.2.0.2)开始，这些限制条件已经取消，即主库是 CDB 或 RAC环境都可以通过 dbca 来创建物理备库
&gt; 本节DBCA备库环境：&lt;a&gt; &lt;font color=dark style="font-weight:bold" 
size=4&gt;19c的CDB环境&lt;/font&gt;&lt;/a&gt;，主/备库的环境和前面的配置方法相同

### 配置Hosts

&gt; 在没有DNS的配置下，需要配置Hosts，否则DBCA过程通讯报错：
&gt; ORA-17627：TNS：could not resolve connect identifier specified
&gt; #\	cat /etc/hosts
&gt; 192.168.2.2	klaus
&gt; 192.168.2.3	klausdg

### DBCA过程

#### 主库开启

```sql
# 如果是CDB环境，先开启数据库也要开启PDB
SQL&gt; startup
SQL&gt; alter pluggable database all open;
Pluggable database altered.
```

#### DBCA命令

&gt; 不需要备库数据库处于nomount状态，监听开启后备库上直接DBCA即可
&gt; 如果是CDB环境，完成后CDB会直接开启，再开启PDB即可。

```shell
# 19c 官网展示的模板
dbca -createDuplicateDB 
    -gdbName global_database_name 
    -primaryDBConnectionString easy_connect_string_to_primary
    -sid database_system_identifier
    [-createAsStandby 
        [-dbUniqueName db_unique_name_for_standby]]
    [-customScripts scripts_list]
# 19c 官网DBCA案例  
	#	Database 			DB_UNIQUE_NAME 		Oracle Net Service Name
	#	Primary				chicago				chicago
	#	Physical standby	boston				boston
# dbca –silent -createDuplicateDB -primaryDBConnectionString  
myprimary.domain:1523/chicago.domain -gdbName chicago.domain -sid boston
 -initParams instance_name=boston –createAsStandby

# 本实验如下设置
dbca -silent -createDuplicateDB \
-gdbName orcl \
-sid orcldg \
-sysPassword Oracle#2020 \
-primaryDBConnectionString 192.168.2.2:1521/ORCL \
-nodelist klausdg \
-databaseConfigType SINGLE \
-createAsStandby -dbUniqueName orcldg
```

```sql
# 执行过程
[oracle@klausdg ~]$ dbca -silent -createDuplicateDB \
&gt; -gdbName orcl \
&gt; -sid orcldg \
&gt; -sysPassword Oracle#2020 \
&gt; -primaryDBConnectionString 192.168.2.2:1521/ORCL \
&gt; -nodelist klausdg \
&gt; -databaseConfigType SINGLE \
&gt; -createAsStandby -dbUniqueName orcldg
Prepare for db operation
22% complete
Listener config step
44% complete
Auxiliary instance creation
67% complete
RMAN duplicate
89% complete
Post duplicate database operations
100% complete
Look at the log file 
"/u01/app/oracle/cfgtoollogs/dbca/orcldg/orcldg.log" for further 
details.
```

## 开启并验证DG同步

### 开启实时同步

```sql
alter database open;
# 如果是CDB环境，需要开启pdb
SQL&gt; alter pluggable database all open;
alter database recover managed standby database using current logfile 
disconnect from session;
# 从12C开始，RECOVER语句，不需要再指定using current logfile，Oracle会自动判断日志应用是否是实时的。
```

### 备库开启闪回

```sql
# 查看闪回
SQL&gt; select flashback_on from v$database;
FLASHBACK_ON
------------
NO
# 取消实时同步
SQL&gt; alter database recover managed standby database cancel;
# 关闭数据库
SQL&gt; shutdown immediate
SQL&gt; startup mount
SQL&gt; alter database flashback on;
# 开启数据库
SQL&gt; alter database open;
# 再次开启同步
SQL&gt; alter database recover managed standby database using current 
logfile disconnect from session;
# 查看
SQL&gt; select open_mode from v$database;
OPEN_MODE
--------------------
READ ONLY WITH APPLY
# 查看主库 PRIMARY
SQL&gt; select log_mode,open_mode ,database_role from v$database;
LOG_MODE     OPEN_MODE            DATABASE_ROLE
------------ -------------------- ----------------
ARCHIVELOG   READ WRITE           PRIMARY
# 查看备库 PHYSICAL STANDBY
SQL&gt; select log_mode,open_mode ,database_role from v$database;
LOG_MODE     OPEN_MODE            DATABASE_ROLE
------------ -------------------- ----------------
ARCHIVELOG   READ ONLY            PHYSICAL STANDBY
```

### 归档同步验证

```sql
# 主库切换归档, 查询主库备库最大归档序号，一致即归档同步成功
SQL&gt; alter system archive log current;
SQL&gt; select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
            72
# 查看主备归档日志是否能正常传输（APPLIED=yes）
SQL&gt; select SEQUENCE#, FIRST_TIME, NEXT_TIME, APPLIED, ARCHIVED from 
V$ARCHIVED_LOG;
```

### 查看主备库状态

```sql
# 主库
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO STANDBY           PRIMARY
# 备库
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          PHYSICAL STANDBY
```

### 主库查看备库归档路径报错

```sql
# 主库 查看archive_log_dest_2列是否有error
SQL&gt; select status,error from v$archive_dest where dest_id=2;
STATUS    ERROR
--------- --------------------
VALID
```

### 主库Dataguard的状态信息

```sql
# 查看Dataguard的状态信息
col message format a150
SQL&gt; select message_num,message from v$dataguard_status;
```

### 建表测试

```sql
# 主库
create table test(id number);
insert into test values(1);
commit;
select * from test;
# 备库
select * from test;

```

## DG切换和恢复

&gt; 配置DG的目的就是为了在主库出现故障时，备库能够提供服务，保证业务的正常运行。
&gt; DG的故障切换分为switchover和failover两种

### Switchover

#### 主库上操作

```sql
# 1、主库查询状态
# 注意：下面查询结果为TO STANDBY 或 SESSIONS ACTIVE表明可以进行切换
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO STANDBY           PRIMARY
# 2、主库开始切换
SQL&gt; alter database commit to switchover to physical standby;
Database altered.
# 主库有会话连接的时候使用如下命令
# alter database commit to switchover to physical standby with session 
shutdown;
# 3、主库变备库，开启到mount状态
SQL&gt; startup mount
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
Database mounted.
SQL&gt; select database_role from v$database;
DATABASE_ROLE
----------------
PHYSICAL STANDBY
```

#### 备库上操作

```sql
# 1、备库查询状态
# 注意：下面查询结果为TO PRIMARY 或 SESSIONS ACTIVE表明可以进行切换
SQL&gt; select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO PRIMARY           PHYSICAL STANDBY
# 2、备库开始切换
SQL&gt; alter database commit to switchover to primary with session 
shutdown;
Database altered.
# 3、开启数据库
SQL&gt;  alter database open;
Database altered.
# 4、查询状态，已经变成主库
SQL&gt; select switchover_status,database_role,open_mode from 
v$database;
SWITCHOVER_STATUS    DATABASE_ROLE    OPEN_MODE
-------------------- ---------------- --------------------
TO STANDBY           PRIMARY          READ WRITE
```

#### 新备库(原主库)上的操作

```sql
# 1、开机数据库open
SQL&gt; alter database open;
Database altered.
# 2、开启同步
SQL&gt; alter database recover managed standby database using current 
logfile disconnect from session;
Database altered.
# 3、主备检查切换状态
SQL&gt; select open_mode,database_role,db_unique_name from v$database;
```

#### 验证

```sql
# 新主库切换归档，主备查询
alter system archive log current;
SQL&gt; select max(sequence#) from v$archived_log;
# 新主库表插入数据测试
insert into test values(2); 
commit;
select * from test;
```

### Failover

&gt; Failover是当主库真正出现严重系统故障，如数据库宕机，软硬件故障导致主库不能支持服务，从而进行的切换动作。
&gt; 注意：为了能够在failover后能够恢复DG,需要在主库上开启flashback，否则DG就可能需要重新搭建。

&gt; 先把主库关机，模拟Failover
&gt; 由于主库已经不可访问，下面所有的操作都在备库完成：

#### 备库上操作

```sql
SQL&gt; select database_role,open_mode from v$database;
DATABASE_ROLE    OPEN_MODE
---------------- --------------------
PHYSICAL STANDBY READ ONLY WITH APPLY
```

#### 停止实时同步

```sql
SQL&gt; alter database recover managed standby database cancel;
Database altered.
SQL&gt; alter database recover managed standby database finish force;
Database altered.
```

#### 状态改为主库

```sql
SQL&gt; select database_role from v$database;
DATABASE_ROLE
----------------
PHYSICAL STANDBY
# 更改状态
SQL&gt; alter database commit to switchover to primary;
Database altered.
# 再次查看
SQL&gt; select database_role from v$database;
DATABASE_ROLE
----------------
PRIMARY
```

#### 开启数据库open

```sql
# 开启数据库open
SQL&gt; alter database open;
Database altered.
# 查看状态
SQL&gt; select switchover_status,database_role,open_mode from 
v$database;
SWITCHOVER_STATUS    DATABASE_ROLE    OPEN_MODE
-------------------- ---------------- --------------------
FAILED DESTINATION   PRIMARY          READ WRITE
# 当主库的SWITCHOVER_STATUS状态为FAILED DESTINATION时，是因为备库不在mount状态下,这里已经没有备库
```

### Failover恢复

&gt; 上面提到了failover，这种情形是当主库真正出现异常之后，才会执行的操作，那么执行过failover 
之后，如何在重新构建DG，这里我们利用flashback database来重构，具体方法如下：

#### 在新主库上执行

```sql
# 查询变成新主库的scn
SQL&gt; select to_char(standby_became_primary_scn) from v$database;
TO_CHAR(STANDBY_BECAME_PRIMARY_SCN)
----------------------------------------
12514234
```

#### 在老主库上执行

```sql
# 要将之前出问题的老主库变成备库
# 1、启动 mount 状态下
SQL&gt; startup mount
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
Database mounted.
# 2、闪回到新的主库查询的scn
SQL&gt; flashback database to scn 12514234;
Flashback complete.
# 3、转为备库
SQL&gt; alter database convert to physical standby;
Database altered.
# 4、关闭
SQL&gt; shutdown immediate
ORA-01109: database not open
Database dismounted.
ORACLE instance shut down.
# 5、开启
SQL&gt; startup
ORACLE instance started.
Total System Global Area 2466250752 bytes
Fixed Size                  2927384 bytes
Variable Size             671089896 bytes
Database Buffers         1778384896 bytes
Redo Buffers               13848576 bytes
Database mounted.
Database opened.
# 6、开启同步
SQL&gt; alter database recover managed standby database using current 
logfile disconnect from session;
Database altered.
# 7、同步验证(略)
```

## 【方式四：逻辑备库Logical Standby】

### 说明

&gt; ```shell
&gt; Oracle Data Guard逻辑备库是利用主库的一个备份首先建立一个物理备库，然后再将其转换为逻辑备库。
&gt; 
这之后主库将日志传递到备库，备库利用logminer从主库的日志中解析出主库所执行过的SQL，在备库上重新执行一遍，从而保证与主库的数据在逻辑上
保持一致。
&gt; 与物理备库相对应的是，物理备库使用的是redo apply，逻辑备库使用的是sql apply。
&gt; 因此逻辑备库仅仅保证数据与主库是在逻辑上是一致的，从而逻辑备库可以处于open状态下并进行相应的DML操作。
&gt; ```

### 备库停止MGR(Redo apply应用)

```sql
# 对于将物理备库切换到逻辑备库，需要在主库构建LogMiner字典及启用补充日志
# 因此应先停用备库的MRP进程，避免产生额外的Redo Apply
SQL&gt; alter database recover managed standby database cancel;
```

### 主库构建LogMiner字典

```sql
# 1、创建字典表空间
SQL&gt; create tablespace logmnrtbs datafile 
'/u01/app/oracle/oradata/orcl/logmnrtbs.dbf' size 100m autoextend on 
next 5m maxsize 2000m;
# 2、关联字典表空间
SQL&gt; execute dbms_logmnr_d.set_tablespace('logmnrtbs');
PL/SQL procedure successfully completed.
# 3、构建LogMiner字典
SQL&gt; exec dbms_logstdby.build;
PL/SQL procedure successfully completed.
```

### 物理备库恢复为逻辑备库

```sql
SQL&gt; select name,open_mode,database_role,protection_mode from 
v$database; 
NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
ORCL      MOUNTED              PHYSICAL STANDBY MAXIMUM PERFORMANCE
========================================================================
# 1、关闭,必须一致性性关闭数据库
SQL&gt; shutdown immediate
# 2、以exclusive方式启动到mount
SQL&gt; startup mount exclusive
# 3、转换为逻辑备库并设置新的db_name
SQL&gt; ALTER DATABASE RECOVER TO LOGICAL STANDBY ORCLLG; 
# 4、关闭,必须一致性性关闭数据库
SQL&gt; shutdown immediate
# 5、正常启动到mount
SQL&gt; startup mount
========================================================================
##	可以看到name自动改变，为读写模式，日志序列也从1开始
SQL&gt; select name,open_mode,database_role,protection_mode from 
v$database; 
NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
ORCLLG    MOUNTED              LOGICAL STANDBY  MAXIMUM PERFORMANCE
SQL&gt; archive log list;
Database log mode              Archive Mode
Automatic archival             Enabled
Archive destination            USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence     1
Next log sequence to archive   1
Current log sequence           1
```

### 开启逻辑备库并同步

```sql
# 由于逻辑Standby与Primary数据库事务并不一致，因此第一次打开时必须指定RESETLOGS子句
SQL&gt; ALTER DATABASE OPEN RESETLOGS;
# 执行启动REDO应用的命令，附加APPLY IMMEDIATE子句，以打开实时应用
SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE; 
```

### 测试

```sql
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 测试逻辑DG部分
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 在测试数据是否正常同步时，不要使用数据库的内部账号，逻辑dg在默认情况下不传输系统用户下，用户自行创建的数据
# 比如在sys用户下创建一个test表，这个表不会同步到逻辑备库
# 可以使用下列语句查看哪些用户作为内部用户
SQL&gt; SELECT OWNER FROM DBA_LOGSTDBY_SKIP WHERE STATEMENT_OPT = 
'INTERNAL SCHEMA';
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 以下在方式四的逻辑DG环境中，主库解锁scott，备库已也会同步经解锁该用户，并创建表等操作
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
SQL&gt; alter user scott account unlock;
User altered.
SQL&gt; conn scott/tiger
ERROR:
ORA-28002: the password will expire within 7 days
create table test(id number);
insert into test values(1);
commit;
# 主备查询一致，至此逻辑Standby创建完成.
select * from test;
```

### Swichover

#### 状态检查

```sql
# 1、查看当前Primary数据库状态：
#如果该查询返回TO STANDBY 或SESSIONS ACTIVE则表示状态正常，可以执行转换操作
# 主库
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO STANDBY           PRIMARY
# 备库
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          LOGICAL STANDBY
```

#### [准备]转换Primary为逻辑Standby

```sql
# 2、执行下列语句，将Primary置为准备转换的状态：
SQL&gt; ALTER DATABASE PREPARE TO SWITCHOVER TO LOGICAL STANDBY;
Database altered.
# 
执行完上述操作后，Primary数据库就开始为角色的转换打好基础，时刻准备着接收来自逻辑Standby数据库，也就是未来的新Primary数据库
发来的REDO数据。
# 查看一下SWITCHOVER_STATUS的状态：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
PREPARING SWITCHOVER PRIMARY
```

#### [准备]转换逻辑Standby为Primary

```sql
# 转换为Primary的PREPARE状态
# 语句执行时响应会稍微有点慢
SQL&gt; ALTER DATABASE PREPARE TO SWITCHOVER TO PRIMARY;
Database altered.
# 执行完后查看当前逻辑Standby数据库的转换状态：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
PREPARING SWITCHOVER LOGICAL STANDBY 
```

#### 再次检查Primary状态

```sql
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO LOGICAL STANDBY   PRIMARY
# 检查结果却非常重要，它直接关系到switchover转换是否能够成功。
# 
逻辑Standby执行完PREPARE命令之后，就会生成相应的LogMiner字典数据（就像我们前面创建逻辑Standby时，Primary数据
库会生成LogMiner字典数据一样），只有它正常生成并发送至当前的Primary数据库，转换操作才能够继续下去。不然当前的Primary数据库
在转换完之后，可能就失去了从新的Primary数据库接收REDO数据的能力了。
# 因此，如果上述查询的返回结果不是TO LOGICAL STANDBY的话，DBA就需要考虑是否取消此次转换，检查原因，然后再重新操作了

# ++取消转换可以通过下列语句进行++++++++++++++++++++++++++++++++++++++++++++++++
ALTER DATABASE PREPARE TO SWITCHOVER CANCEL; 
# ++需要分别在Primary端和逻辑Standby端执行+++++++++++++++++++++++++++++++++++++
```

#### 正式转换Primary为逻辑Standby

```sql
SQL&gt; ALTER DATABASE COMMIT TO SWITCHOVER TO LOGICAL STANDBY;
Database altered.
# 该语句需要等待当前Primary数据库所有事务全部结束才开始执行
# 该语句执行过程中会自动拒绝用户提交新事务或修改需求，为了确保该操作尽可能快的执行，最好自开始切换操作起就禁止所有用户的操作
# 该命令执行完之后，这个Primary数据库就已经成为新的逻辑Standby了。不过在新Primary执行完转换之前，不要关闭当前这个数据库
```

#### 再次检查逻辑Standby状态

```sql
# SWITCHOVER_STATUS的状态，应该为TO PRIMARY：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
TO PRIMARY           LOGICAL STANDBY
# 或者
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          LOGICAL STANDBY
```

#### 正式转换逻辑Standby为新Primary

```sql
SQL&gt; ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY;
Database altered.
```

#### 开始新的主备同步

```sql
# 新逻辑备库（即原主库上）
SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE;
Database altered.
```

#### 测试

```sql
# 主库添加数据
insert into scott.test values(10);
commit;
# 主备查询
select * from scott.test;
# ==发现并没有同步=============================
# 查看新主库状态,存在GAP
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
LOG SWITCH GAP       PRIMARY
# ==解决=====================================
# 新主库关闭启动到mount
shutdown immediate
startup mount
# 把新主库REDO FLUSH到新备库，
# 此处是orcldg是新主库，在新主库上将日志flush到新备库上
# ALTER SYSTEM FLUSH REDO TO 
target_db_name;其中target_db_name使用DB_UNIQUE_NAME
ALTER SYSTEM FLUSH REDO TO orcl;
# 再次查看新主库状态，再测试数据已经同步
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          PRIMARY
# 开启数据库
alter database open;
# 测试查询结果
SQL&gt; select * from scott.test;
        ID
----------
         2
        10
         1
```

### Failover

#### 检查丢失的归档

```sql
# 如果此时Primary数据库仍可被访问，首先应当检查当前的归档日志序号与逻辑Standby是否相同
# 主库
SQL&gt; SELECT MAX(SEQUENCE#) FROM V$ARCHIVED_LOG;
MAX(SEQUENCE#)
--------------
            11
# 备库
SQL&gt; SELECT SEQUENCE#,APPLIED FROM DBA_LOGSTDBY_LOG;
 SEQUENCE# APPLIED
---------- --------
         8 YES
         9 YES
        10 YES
        11 CURRENT
# Failover三种情况：(上面查询的是正常运行的还没有Failover的情况)
# 
第一种：如果逻辑Standby与Primary的归档序号相同，但某些序号的APPLIED状态为NO，建议检查当前逻辑Standby数据库是否启动
了SQL应用
# 
第二种：如果逻辑Standby归档序号小于Primary的归档序号，说明Primary存在尚未发送至逻辑Standby数据库的归档文件，手工复制
这些文件到待转换角色的逻辑Standby端，然后在该逻辑Standby数据库的SQL*Plus命令窗口，通过执行ALTER DATABASE 
REGISTER LOGICAL LOGFILE 'filepath'; 命令，将复制过来的归档文件手工注册
# 
第三种：如果Primary数据库已经无法打开，就只好直接到磁盘上查看归档目录中的序号，来与逻辑Standby数据库做比较。如果Primary数据
库已经完全无法访问，那直接按照后面步骤进行操作
```

#### 模拟Failover

&gt; 将Primary关机或关闭数据库，模拟Failover

#### 检查Standby日志情况

```sql
# 通过V$LOGSTDBY_PROGRESS视图，查询重做日志的应用情况
SQL&gt; SELECT APPLIED_SCN,LATEST_SCN FROM V$LOGSTDBY_PROGRESS;
APPLIED_SCN LATEST_SCN
----------- ----------
   12778829   12778829
# 如果返回的结果中显示，两列的列值一致，则表示所有接收到的重做日志都已经应用。如果不一致的话，启动逻辑Standby端的SQL应用。
```

#### 激活前检查

```sql
# 确认待转换的逻辑Standby配置了正确的归档路径和远端服务器的归档配置(前面设置部分都配置过)
SQL&gt; SHOW PARAMETER LOG_ARCHIVE_DEST
# 查看当前操作的角色：
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE,FORCE_LOGGING FROM 
V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE    FORCE_LOGGING
-------------------- ---------------- 
---------------------------------------
NOT ALLOWED          LOGICAL STANDBY  YES
# 如果当前FORCE_LOGGING为NO，务必执行ALTER DATABASE FORCE LOGGING;命令。
```

#### 激活新的Primary数据库

```sql
# 转换Standby数据库角色为Primary
SQL&gt; ALTER DATABASE ACTIVATE LOGICAL STANDBY DATABASE FINISH APPLY; 
Database altered.
# 
该语句主要是停止待转换的逻辑Standby中RFS进程，并应用完当前所有已接收但并未应用的REDO数据，然后停止SQL应用，将数据库转换成
Primary角色
# 再次查看当前数据库的角色
SQL&gt; SELECT DATABASE_ROLE,FORCE_LOGGING FROM V$DATABASE; 
DATABASE_ROLE    FORCE_LOGGING
---------------- ---------------------------------------
PRIMARY          YES
# 至此完成Failover后角色的转换了
```

### Failover恢复

&gt; 上面这种情形是当主库真正出现异常之后，才会执行的Failover操作；执行过failover之后，如何在重新构建之前老的逻辑主库DG

#### DB_LINK连接主备

```sql
# 在需要重构的库中执行
# ALTER SESSION ENABLE|DISABLE GUARD的作用
# 该语句用于允许或禁止用户修改逻辑Standby中的结构
# 直接修改会报错：
SQL&gt; ALTER SESSION DISABLE GUARD;
# 创建DB_LINK
SQL&gt; CREATE DATABASE LINK link_orcllg CONNECT TO system IDENTIFIED BY
 Oracle#2020 USING '192.168.2.2:1521/orcl'; 
SQL&gt; ALTER SESSION ENABLE GUARD;
```

#### 启动同步

```sql
# 使用link同步新主库
SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY NEW PRIMARY 
link_orcllg;
Database altered.
# 后面开关机可以正常使用下面SQL应用redo
# SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE;
```

#### 查看状态并验证

```sql
# 主库
# 主库存在GAP
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
RESOLVABLE GAP       PRIMARY
# 备库
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          LOGICAL STANDBY
# ==解决=====================================
# 新主库关闭启动到mount
shutdown immediate
startup mount
# 把新主库REDO FLUSH到新备库
# 此处是orcl是新主库，在新主库上将日志flush到新备库orcldg上
# ALTER SYSTEM FLUSH REDO TO 
target_db_name;其中target_db_name使用DB_UNIQUE_NAME
ALTER SYSTEM FLUSH REDO TO orcldg;
# 再次查看新主库状态，再测试数据已经同步
SQL&gt; SELECT SWITCHOVER_STATUS,DATABASE_ROLE FROM V$DATABASE;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED          PRIMARY
# 开启数据库
alter database open;
# 数据验证
insert into scott.test values(900);
commit;
select * from scott.test;
```

## 【方式五：快照备库Snapshot】

&gt; 继  方式一：物理备库之RMAN Duplicate  后的操作，快照备库是11g开始有的特性
&gt;
&gt; ```shell
&gt; 
在Dataguard中，可以将standby备库切换为snapshot快照数据库，在切换为snapshot数据库后，备库将置于可读写的模式。  
&gt; 
运用的场景：可用于模拟业务功能测试，备库处于快照备库模式后，可将备库置于可读写的状态，用于不方便在生产环境主库的测试内容,比如模拟线上测试等内
容。快照模式的备库可以反复测试，在使用完成之后，可以将快照数据库切换为物理备库，则之前所有在快照备库上的操作都丢失，一般快照备库操作的数据越大，
恢复回物理备库时间越长。
&gt; 在快照备库期间，备库可以接受主库传输过来的日志，但是不能应用日志，需要处于物理备库的时候才可以应用。  
&gt; 当快照备库转回为物理备库时，所有在快照备库的操作被丢弃后，物理快照才会应用主库的redo数据。
&gt; ```

### 备库停止Redo apply应用

```sql
# 确保备库指定闪回区域
SQL&gt; show parameter db_recov
NAME                                 TYPE        VALUE
------------------------------------ ----------- 
----------------------------------
db_recovery_file_dest                string      
/u01/app/oracle/fast_recovery_area
db_recovery_file_dest_size           big integer 4560M
# 停止Redo应用
SQL&gt; alter database recover managed standby database cancel;
Database altered.
```

### 备库到mount状态

```sql
# 确保数据库是否处于mount状态
SQL&gt; select open_mode,database_role,protection_mode,protection_level 
from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      
PROTECTION_LEVEL
-------------------- ---------------- -------------------- 
--------------------
MOUNTED              PHYSICAL STANDBY MAXIMUM PERFORMANCE  MAXIMUM 
PERFORMANCE
```

### 转换为快照备库

```sql
SQL&gt; ALTER DATABASE CONVERT TO SNAPSHOT STANDBY;
Database altered.
# 查看
SQL&gt; select open_mode,database_role,protection_mode,protection_level 
from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      
PROTECTION_LEVEL
-------------------- ---------------- -------------------- 
--------------------
MOUNTED              SNAPSHOT STANDBY MAXIMUM PERFORMANCE  UNPROTECTED
```

### 快照备库到open状态

```sql
# 备库到open可读可写状态
SQL&gt; alter database open;
# 查看 OPEN_MODE
SQL&gt; select open_mode,database_role,protection_mode,protection_level 
from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      
PROTECTION_LEVEL
-------------------- ---------------- -------------------- 
--------------------
READ WRITE           SNAPSHOT STANDBY MAXIMUM PERFORMANCE  MAXIMUM 
PERFORMANCE
```

### 快照备库对主库的日志接收

&gt; 当主库切换日志时，备库依然可以接受日志，只是不应用

```sql
# 主库切换日志
SQL&gt; alter system archive log current;
# 主备都是相同的序号
SQL&gt; select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
            88
```

```shell
# 查看日志alert日志位置
SQL&gt; select name,value from V$diag_info where name in('Diag 
Trace','Diag Alert'); 
# 主库alert信息
[oracle@klaus trace]$ cat 
/u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log 
Wed Aug 25 21:52:16 2021
ALTER SYSTEM ARCHIVE LOG
Wed Aug 25 21:52:16 2021
Thread 1 advanced to log sequence 89 (LGWR switch)
  Current log# 2 seq# 89 mem# 0: /u01/app/oracle/oradata/orcl/redo02.log
Wed Aug 25 21:52:16 2021
Archived Log entry 67 added for thread 1 sequence 88 ID 0x5df896fc dest 
1:
Wed Aug 25 21:52:16 2021
TT00: Standby redo logfile selected for thread 1 sequence 89 for 
destination LOG_ARCHIVE_DEST_2
# 备库alert信息
RFS[3]: Selected log 5 for thread 1 sequence 89 dbid 1576583420 branch 
1048802686
Wed Aug 25 21:52:15 2021
Archived Log entry 16 added for thread 1 sequence 88 ID 0x5df896fc dest 
1:
```

### 快照备库可读写

&gt; 此时快照备库是可读写的 READ WRITE 状态
&gt;
&gt; ```sql
&gt; SQL&gt; select 
open_mode,database_role,protection_mode,protection_level from 
v$database;
&gt; OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      
PROTECTION_LEVEL
&gt; -------------------- ---------------- -------------------- 
--------------------
&gt; READ WRITE           SNAPSHOT STANDBY MAXIMUM PERFORMANCE  MAXIMUM 
PERFORMANCE
&gt; ```

### 恢复为物理备库

```sql
# 备库到mount状态
shutdown immediate
startup mount
# 恢复到物理备库
SQL&gt; ALTER DATABASE CONVERT TO PHYSICAL STANDBY;
Database altered.
# 重新开启数据库
shutdown immediate
startup
# 开启同步
SQL&gt; alter database recover managed standby database using current 
logfile disconnect from session;

# 验证
SQL&gt; select open_mode,database_role,protection_mode,protection_level 
from v$database;
OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE      
PROTECTION_LEVEL
-------------------- ---------------- -------------------- 
--------------------
READ ONLY WITH APPLY PHYSICAL STANDBY MAXIMUM PERFORMANCE  MAXIMUM 
PERFORMANCE
# 切换日志
SQL&gt; alter system archive log current;
SQL&gt; select max(sequence#) from v$archived_log;
```

## DG开关机顺序

```sql
---------------------------------------------------------------------------------
#
 启动顺序：先启动备库，后启动主库
# 关闭顺序：先关闭主库，后关闭备库
---------------------------------------------------------------------------------
#
 1、正确开启顺序
# 备库:
SQL&gt; STARTUP MOUNT
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE  DISCONNECT FROM
 SESSION;
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

		# 逻辑备库:
			SQL&gt; STARTUP
			SQL&gt; ALTER DATABASE START LOGICAL STANDBY APPLY IMMEDIATE; 
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#
 主库:
SQL&gt; STARTUP
---------------------------------------------------------------------------------
#
 2、正确关闭顺序
# 主库:
SQL&gt; SHUTDOWN IMMEDIATE
# 备库:
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

		# 逻辑备库:
		SQL&gt; ALTER DATABASE STOP LOGICAL STANDBY APPLY;
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
SQL&gt;
 SHUTDOWN IMMEDIATE
```

## DG维护相关
</textarea><span class="resize"><i></i></span>
                    </p>
                    
                                        <section id="custom-field" class="typecho-post-option">
                        <label id="custom-field-expand" class="typecho-label"><a href="##"><i class="i-caret-right"></i> 自定义字段</a></label>
                        <table class="typecho-list-table mono">
                            <colgroup>
                                <col width="25%">
                                <col width="10%">
                                <col width="55%">
                                <col width="10%">
                            </colgroup>
                                                                                    <tbody><tr>
                                <td><label class="typecho-label" for="thumbChoice-0-13">
当前文章是否显示头图</label>
</td>
                                <td colspan="3"><div>
<select name="fields[thumbChoice]" id="thumbChoice-0-13">
<option value="default" selected="selected">
跟随外观设置</option>
<option value="yes">
首页文章页面均显示头图</option>
<option value="yes_only_index">
 仅首页显示头图</option>
<option value="yes_only_post">
 仅文章页面显示头图</option>
<option value="no">
均不显示头图</option>
</select>
<p class="description">
<strong style="color:red;">该设置仅对该篇文章有效</strong><br>默认选项是「均显示头图」<br> 选择「均不显示头图」当前文章页面和首页将不会显示头图<br> 选择「均不显示头图」 或者「仅文章页面显示头图」，<strong style="color: red">可以继续配置「个性化标徽选择」选项</strong></p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="thumb-0-14">
大头图地址</label>
</td>
                                <td colspan="3"><div>
<input id="thumb-0-14" name="fields[thumb]" type="text" class="text">
<p class="description">
输入图片URL，则优先使用该图片作为头图<br>不填此处则按照后台外观设置中的 <code>主题增强功能-博客头图设置</code>顺序显示头图。<br>大头图的尺寸为8：3</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="thumbSmall-0-15">
小头图地址</label>
</td>
                                <td colspan="3"><div>
<input id="thumbSmall-0-15" name="fields[thumbSmall]" type="text" class="text">
<p class="description">
因为当首页文章显示小头图的时候，文章页面仍然会显示大头图<br>当前文章如果不是小头图样式，你可以忽略该设置项。<br>如果当前文章是小头图你仍然也可以不填，默认会自动大头图的图片至正方形尺寸显示在首页<br>但是为了最佳体验，你可以填一张小图片（正方形尺寸）</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="thumbDesc-0-16">
头图版权说明</label>
</td>
                                <td colspan="3"><div>
<input id="thumbDesc-0-16" name="fields[thumbDesc]" type="text" class="text">
<p class="description">
在这里你可以填写头图的来源以申明版权©，该说明信息在文章页面的头图右下角显示（如果你选择不显示头图，当然这个选项是无效的）</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="thumbStyle-0-17">
文章头图样式选择</label>
</td>
                                <td colspan="3"><div>
<select name="fields[thumbStyle]" id="thumbStyle-0-17">
<option value="default" selected="selected">
跟随外观设置</option>
<option value="large">
大版式</option>
<option value="small">
小版式</option>
<option value="picture">
图片版式</option>
</select>
<p class="description">
该选项可以单独为该篇文章配置头图样式，以便达到首页多种头图样式交叉的效果</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="noThumbInfoStyle-0-18">
个性化标徽选择</label>
</td>
                                <td colspan="3"><div>
<select name="fields[noThumbInfoStyle]" id="noThumbInfoStyle-0-18">
<option value="default" selected="selected">
无</option>
<option value="book">
图书</option>
<option value="game">
游戏</option>
<option value="note">
笔记</option>
<option value="chat">
聊天</option>
<option value="code">
代码</option>
<option value="image">
图片</option>
<option value="web">
网页</option>
<option value="link">
链接</option>
<option value="design">
设计</option>
<option value="lock">
上锁</option>
</select>
<p class="description">
该选项仅在<strong style="color: red">首页当前文章不显示头图</strong>，样式才会有效<br> 点击<a href="https://s2.ax1x.com/2019/07/20/ZzatnU.jpg" target="_blank">这里依次预览所有图标</a></p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="noThumbInfoEmoji-0-19">
文章 Emoji 填写</label>
</td>
                                <td colspan="3"><div>
<input id="noThumbInfoEmoji-0-19" name="fields[noThumbInfoEmoji]" type="text" class="text">
<p class="description">
该选项仅在<strong style="color: red">首页当前文章不显示头图并且个性化标徽选择选择为「无」</strong>，样式才会有效<br> <a href="https://auth.ihewro.com/user/docs/#/FAQ/main?id=%e6%96%87%e7%ab%a0%e5%8f%91%e5%b8%83%e5%90%8e%ef%bc%8c%e6%9c%89%e4%b8%80%e9%83%a8%e5%88%86%e5%86%85%e5%ae%b9%e4%b8%a2%e5%a4%b1%e4%ba%86%ef%bc%9f" target="_blank">只有当你的数据库编码是才支持emoji，否则请勿填写emoji会导致文章内容丢失，具体查看这里</a></p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="outdatedNotice-0-20">
开启文章过时提醒</label>
</td>
                                <td colspan="3"><div>
<select name="fields[outdatedNotice]" id="outdatedNotice-0-20">
<option value="no" selected="selected">
关闭</option>
<option value="yes">
开启</option>
</select>
<p class="description">
当该文章的最后更新时间距离游客访问时间超过60天，会在文章顶部显示一条“文章可能过时”的提醒<br>默认关闭，你可以在这里开启，仅对该篇文章有效</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="customSummary-0-21">
手动指定摘要内容</label>
</td>
                                <td colspan="3"><div>
<input id="customSummary-0-21" name="fields[customSummary]" type="text" class="text">
<p class="description">
默认根据后台配置的摘要字数<a target="_blank" href="https://auth.ihewro.com/user/docs/#/preference/functions?id=%E8%87%AA%E5%AE%9A%E4%B9%89%E6%91%98%E8%A6%81%E5%AD%97%E6%95%B0">自动生成摘要</a><br><strong style="color: red">你可以在这里手动指定摘要</strong></p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="reprint-0-22">
转载规则设置</label>
</td>
                                <td colspan="3"><div>
<select name="fields[reprint]" id="reprint-0-22">
<option value="standard" selected="selected">
允许规范转载</option>
<option value="pay">
允许付费转载</option>
<option value="forbidden">
禁止转载</option>
<option value="trans">
转载自他站</option>
<option value="internet">
来自互联网</option>
</select>
<p class="description">
选择不同的转载规则会在文章末尾显示（手机端不会显示）</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="mathjax-0-23">
mathjax单篇文章设置开关</label>
</td>
                                <td colspan="3"><div>
<select name="fields[mathjax]" id="mathjax-0-23">
<option value="auto">
跟随外观设置</option>
<option value="true" selected="selected">
开启</option>
<option value="false">
关闭</option>
</select>
<p class="description">
<strong style="color:red;">该设置仅对该篇文章有效</strong><br> 
    默认跟随「外观设置」——「主题增强功能」里面的设置，你可以对单篇文章选择开启和关闭。<br> 如果使用mathjax的文章很少，可以在外观设置中关闭mathjax,只在单篇文章中开启即可。</p>
</div>
</td>
                            </tr>
                                                                                    <tr>
                                <td><label class="typecho-label" for="parseWay-0-24">
前台文章解析器单篇文章开关</label>
</td>
                                <td colspan="3"><div>
<select name="fields[parseWay]" id="parseWay-0-24">
<option value="auto">
跟随插件设置</option>
<option value="origin">
使用typecho自带的markdown解析器</option>
<option value="vditor" selected="selected">
前台引入vditor.js接管前台解析</option>
</select>
<p class="description">
<strong style="color:red;">该设置仅对该篇文章有效</strong><br>默认跟随Handsome插件设置里面「前台Markdown解析方式」的选项。<br>这里可以单独对该篇文章设置，因为有些文章可能希望有更丰富的功能，可以选择使用vditor.js，普通简单的文章可以选择typecho自带解析器，加载更快</p>
</div>
</td>
                            </tr>
                                                                                                            </tbody></table>
                        <div class="description clearfix">
                            <button type="button" class="btn btn-xs operate-add">+添加字段</button>
                            自定义字段可以扩展你的模板功能, 使用方法参见 <a href="http://docs.typecho.org/help/custom-fields" target="_blank">帮助文档</a>                        </div>
                    </section>

                    <p class="submit clearfix"><span id="auto-save-message" class="left"></span>
                        <span class="right">
                            <input type="hidden" name="cid" value="7">
                            <button type="submit" name="do" value="save" id="btn-save" class="btn">保存草稿</button>
                            <button type="submit" name="do" value="publish" class="btn primary" id="btn-submit">发布文章</button>
                                                        <input type="hidden" name="markdown" value="1">
                                                    </span>
                    </p>

                                    </div>

                <div id="edit-secondary" class="col-mb-12 col-tb-3" role="complementary">
                    <ul class="typecho-option-tabs clearfix">
                        <li class="active w-50"><a href="#tab-advance">选项</a></li>
                        <li class="w-50"><a href="#tab-files" id="tab-files-btn">附件</a></li>
                    </ul>


                    <div id="tab-advance" class="tab-content">
                        <section class="typecho-post-option" role="application">
                            <label for="date" class="typecho-label">发布日期</label>
                            <p><input class="typecho-date w-100 hasDatepicker" type="text" name="date" id="date" value="2022-03-31 20:11"></p>
                        </section>

                        <section class="typecho-post-option category-option">
                            <label class="typecho-label">分类</label>
                                                        <ul>
                                                                                                <li><input type="checkbox" id="category-1" value="1" name="category[]">
                                <label for="category-1">默认分类</label></li>
                                                                <li><input type="checkbox" id="category-2" value="2" name="category[]">
                                <label for="category-2">Oracle</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-3" value="3" name="category[]" checked="checked">
                                <label for="category-3">DG</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-4" value="4" name="category[]">
                                <label for="category-4">RAC</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-10" value="10" name="category[]">
                                <label for="category-10">RMAN</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-11" value="11" name="category[]">
                                <label for="category-11">OGG</label></li>
                                                                <li><input type="checkbox" id="category-5" value="5" name="category[]">
                                <label for="category-5">MySQL</label></li>
                                                                <li><input type="checkbox" id="category-6" value="6" name="category[]">
                                <label for="category-6">Linux</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-7" value="7" name="category[]">
                                <label for="category-7">Docker</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-8" value="8" name="category[]">
                                <label for="category-8">Ansible</label></li>
                                                                <li>&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="category-9" value="9" name="category[]">
                                <label for="category-9">Shell</label></li>
                                                            </ul>
                        </section>

                        <section class="typecho-post-option">
                            <label for="token-input-tags" class="typecho-label">标签</label>
                            <p><ul class="token-input-list"><li class="token-input-token"><p>DG</p><span class="token-input-delete-token">×</span></li><li class="token-input-input-token"><input type="text" autocomplete="off" style="outline: currentcolor none medium;" id="token-input-tags"><tester style="position: absolute; top: -9999px; left: -9999px; width: auto; font-size: 14px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-weight: 400; letter-spacing: 0px; white-space: nowrap;"></tester></li></ul><input id="tags" name="tags" type="text" value="DG" class="w-100 text" style="display: none;"></p>
                        </section>

                        
                        <button type="button" id="advance-panel-btn" class="btn btn-xs">高级选项 <i class="i-caret-down"></i></button>
                        <div id="advance-panel">
                                                        <section class="typecho-post-option visibility-option">
                                <label for="visibility" class="typecho-label">公开度</label>
                                <p>
                                <select id="visibility" name="visibility">
                                                                        <option value="publish" selected="selected">公开</option>
                                    <option value="hidden">隐藏</option>
                                    <option value="password">密码保护</option>
                                    <option value="private">私密</option>
                                                                        <option value="waiting">待审核</option>
                                </select>
                                </p>
                                <p id="post-password" class="hidden">
                                    <label for="protect-pwd" class="sr-only">内容密码</label>
                                    <input type="text" name="password" id="protect-pwd" class="text-s" size="16" placeholder="内容密码">
                                </p>
                            </section>
                            
                            <section class="typecho-post-option allow-option">
                                <label class="typecho-label">权限控制</label>
                                <ul>
                                    <li><input id="allowComment" name="allowComment" type="checkbox" value="1" checked="checked">
                                    <label for="allowComment">允许评论</label></li>
                                    <li><input id="allowPing" name="allowPing" type="checkbox" value="1" checked="checked">
                                    <label for="allowPing">允许被引用</label></li>
                                    <li><input id="allowFeed" name="allowFeed" type="checkbox" value="1" checked="checked">
                                    <label for="allowFeed">允许在聚合中出现</label></li>
                                </ul>
                            </section>
                            
                            <section class="typecho-post-option">
                                <label for="trackback" class="typecho-label">引用通告</label>
                                <p><textarea id="trackback" class="w-100 mono" name="trackback" rows="2"></textarea></p>
                                <p class="description">每一行一个引用地址, 用回车隔开</p>
                            </section>

                                                    </div><!-- end #advance-panel -->

                                                                        <section class="typecho-post-option">
                            <p class="description">
                                <br>—<br>
                                本文由 <a href="https://lo8ol.com/admin/manage-posts.php?uid=1">klaus</a> 撰写<br>
                                最后更新于 44分钟前                            </p>
                        </section>
                                            </div><!-- end #tab-advance -->

                    <div id="tab-files" class="tab-content hidden">
                        

<div id="upload-panel" class="p">
    <div class="upload-area" draggable="true">拖放文件到这里<br>或者 <a href="###" class="upload-file">选择文件上传</a></div>
    <ul id="file-list">
        </ul>
<ul class="typecho-option-tabs clearfix"><li id="insert_all_imagee" class="w-100"><a href="#">一键插入图片附件</a></li><li id="insert_all_no_imagee" class="w-100"><a href="#">一键插入非图片附件</a></li></ul></div>

                    </div><!-- end #tab-files -->
                </div>
            <input name="timezone" type="hidden" value="28800"></form>
        </div>
    </div>
</div>

<div class="typecho-foot" role="contentinfo">
    <div class="copyright">
        <a href="http://typecho.org/" class="i-logo-s" target="_blank">Typecho</a>
        <p>由 <a href="http://typecho.org/" target="_blank">Typecho</a> 强力驱动, 版本 1.1 (17.10.30)</p>
    </div>
    <nav class="resource">
        <a href="http://docs.typecho.org/" target="_blank">帮助文档</a> •
        <a href="http://forum.typecho.org/" target="_blank">支持论坛</a> •
        <a href="https://github.com/typecho/typecho/issues" target="_blank">报告错误</a> •
        <a href="http://extends.typecho.org/" target="_blank">资源下载</a>
    </nav>
</div>
<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/jquery.js"></script>
<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/jquery-ui.js"></script>
<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/typecho.js"></script>
<script>
    (function () {
        $(document).ready(function() {
            // 处理消息机制
            (function () {
                var prefix = '9fdb26fa205a578c689387c767a87db7',
                    cookies = {
                        notice      :   $.cookie(prefix + '__typecho_notice'),
                        noticeType  :   $.cookie(prefix + '__typecho_notice_type'),
                        highlight   :   $.cookie(prefix + '__typecho_notice_highlight')
                    },
                    path = '/';

                if (!!cookies.notice && 'success|notice|error'.indexOf(cookies.noticeType) >= 0) {
                    var head = $('.typecho-head-nav'),
                        p = $('<div class="message popup ' + cookies.noticeType + '">'
                        + '<ul><li>' + $.parseJSON(cookies.notice).join('</li><li>') 
                        + '</li></ul></div>'), offset = 0;

                    if (head.length > 0) {
                        p.insertAfter(head);
                        offset = head.outerHeight();
                    } else {
                        p.prependTo(document.body);
                    }

                    function checkScroll () {
                        if ($(window).scrollTop() >= offset) {
                            p.css({
                                'position'  :   'fixed',
                                'top'       :   0
                            });
                        } else {
                            p.css({
                                'position'  :   'absolute',
                                'top'       :   offset
                            });
                        }
                    }

                    $(window).scroll(function () {
                        checkScroll();
                    });

                    checkScroll();

                    p.slideDown(function () {
                        var t = $(this), color = '#C6D880';
                        
                        if (t.hasClass('error')) {
                            color = '#FBC2C4';
                        } else if (t.hasClass('notice')) {
                            color = '#FFD324';
                        }

                        t.effect('highlight', {color : color})
                            .delay(5000).fadeOut(function () {
                            $(this).remove();
                        });
                    });

                    
                    $.cookie(prefix + '__typecho_notice', null, {path : path});
                    $.cookie(prefix + '__typecho_notice_type', null, {path : path});
                }

                if (cookies.highlight) {
                    $('#' + cookies.highlight).effect('highlight', 1000);
                    $.cookie(prefix + '__typecho_notice_highlight', null, {path : path});
                }
            })();


            // 导航菜单 tab 聚焦时展开下拉菜单
            (function () {
                $('#typecho-nav-list').find('.parent a').focus(function() {
                    $('#typecho-nav-list').find('.child').hide();
                    $(this).parents('.root').find('.child').show();
                });
                $('.operate').find('a').focus(function() {
                    $('#typecho-nav-list').find('.child').hide();
                });
            })();


            if ($('.typecho-login').length == 0) {
                $('a').each(function () {
                    var t = $(this), href = t.attr('href');

                    if ((href && href[0] == '#')
                        || /^https\:\/\/lo8ol\.com\/admin\/.*$/.exec(href) 
                            || /^https\:\/\/lo8ol\.com\/action\/[_a-zA-Z0-9\/]+.*$/.exec(href)) {
                        return;
                    }

                    t.attr('target', '_blank');
                });
            }
        });
    })();
</script>
<script>
(function () {
    $(document).ready(function () {
        var error = $('.typecho-option .error:first');

        if (error.length > 0) {
            $('html,body').scrollTop(error.parents('.typecho-option').offset().top);
        }

        $('form').submit(function () {
            if (this.submitted) {
                return false;
            } else {
                this.submitted = true;
            }
        });

        $('label input[type=text]').click(function (e) {
            var check = $('#' + $(this).parents('label').attr('for'));
            check.prop('checked', true);
            return false;
        });
    });
})();
</script>

<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/timepicker.js"></script>
<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/tokeninput.js"></script>
<script>
$(document).ready(function() {
    // 日期时间控件
    $('#date').mask('9999-99-99 99:99').datetimepicker({
        currentText     :   '现在',
        prevText        :   '上一月',
        nextText        :   '下一月',
        monthNames      :   ['一月', '二月', '三月', '四月',
            '五月', '六月', '七月', '八月',
            '九月', '十月', '十一月', '十二月'],
        dayNames        :   ['星期日', '星期一', '星期二',
            '星期三', '星期四', '星期五', '星期六'],
        dayNamesShort   :   ['周日', '周一', '周二', '周三',
            '周四', '周五', '周六'],
        dayNamesMin     :   ['日', '一', '二', '三',
            '四', '五', '六'],
        closeText       :   '完成',
        timeOnlyTitle   :   '选择时间',
        timeText        :   '时间',
        hourText        :   '时',
        amNames         :   ['上午', 'A'],
        pmNames         :   ['下午', 'P'],
        minuteText      :   '分',
        secondText      :   '秒',

        dateFormat      :   'yy-mm-dd',
        timezone        :   28800 / 60,
        hour            :   (new Date()).getHours(),
        minute          :   (new Date()).getMinutes()
    });

    // 聚焦
    $('#title').select();

    // text 自动拉伸
    Typecho.editorResize('text', 'https://lo8ol.com/action/ajax?do=editorResize&_=fe69c0b12e48c09f8f9c86367328fba5');

    // tag autocomplete 提示
    var tags = $('#tags'), tagsPre = [];
    
    if (tags.length > 0) {
        var items = tags.val().split(','), result = [];
        for (var i = 0; i < items.length; i ++) {
            var tag = items[i];

            if (!tag) {
                continue;
            }

            tagsPre.push({
                id      :   tag,
                tags    :   tag
            });
        }

        tags.tokenInput([{"id":"DG","tags":"DG"},{"id":"Oracle","tags":"Oracle"},{"id":"RAC","tags":"RAC"},{"id":"Linux","tags":"Linux"},{"id":"Docker","tags":"Docker"},{"id":"Ansible","tags":"Ansible"},{"id":"OGG","tags":"OGG"},{"id":"Shell","tags":"Shell"},{"id":"RMAN","tags":"RMAN"}], {
            propertyToSearch:   'tags',
            tokenValue      :   'tags',
            searchDelay     :   0,
            preventDuplicates   :   true,
            animateDropdown :   false,
            hintText        :   '请输入标签名',
            noResultsText   :   '此标签不存在, 按回车创建',
            prePopulate     :   tagsPre,

            onResult        :   function (result, query, val) {
                if (!query) {
                    return result;
                }

                if (!result) {
                    result = [];
                }

                if (!result[0] || result[0]['id'] != query) {
                    result.unshift({
                        id      :   val,
                        tags    :   val
                    });
                }

                return result.slice(0, 5);
            }
        });

        // tag autocomplete 提示宽度设置
        $('#token-input-tags').focus(function() {
            var t = $('.token-input-dropdown'),
                offset = t.outerWidth() - t.width();
            t.width($('.token-input-list').outerWidth() - offset);
        });
    }

    // 缩略名自适应宽度
    var slug = $('#slug');

    if (slug.length > 0) {
        var wrap = $('<div />').css({
            'position'  :   'relative',
            'display'   :   'inline-block'
        }),
        justifySlug = $('<pre />').css({
            'display'   :   'block',
            'visibility':   'hidden',
            'height'    :   slug.height(),
            'padding'   :   '0 2px',
            'margin'    :   0
        }).insertAfter(slug.wrap(wrap).css({
            'left'      :   0,
            'top'       :   0,
            'minWidth'  :   '5px',
            'position'  :   'absolute',
            'width'     :   '100%'
        })), originalWidth = slug.width();

        function justifySlugWidth() {
            var val = slug.val();
            justifySlug.text(val.length > 0 ? val : '     ');
        }

        slug.bind('input propertychange', justifySlugWidth);
        justifySlugWidth();
    }

    // 原始的插入图片和文件
    Typecho.insertFileToEditor = function (file, url, isImage) {
        var textarea = $('#text'), sel = textarea.getSelection(),
            html = isImage ? '<img src="' + url + '" alt="' + file + '" />'
                : '<a href="' + url + '">' + file + '</a>',
            offset = (sel ? sel.start : 0) + html.length;

        textarea.replaceSelection(html);
        textarea.setSelection(offset, offset);
    };

    var submitted = false, form = $('form[name=write_post],form[name=write_page]').submit(function () {
        submitted = true;
    }), savedData = null;

    // 计算夏令时偏移
    var dstOffset = (function () {
        var d = new Date(),
            jan = new Date(d.getFullYear(), 0, 1),
            jul = new Date(d.getFullYear(), 6, 1),
            stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());

        return stdOffset - d.getTimezoneOffset();
    })();
    
    if (dstOffset > 0) {
        $('<input name="dst" type="hidden" />').appendTo(form).val(dstOffset);
    }

    // 时区
    $('<input name="timezone" type="hidden" />').appendTo(form).val(- (new Date).getTimezoneOffset() * 60);

    // 自动保存
    var locked = false,
        formAction = form.attr('action'),
        idInput = $('input[name=cid]'),
        cid = idInput.val(),
        autoSave = $('<span id="auto-save-message" class="left"></span>').prependTo('.submit'),
        autoSaveOnce = !!cid,
        lastSaveTime = null;

    function autoSaveListener () {
        setInterval(function () {
            idInput.val(cid);
            var data = form.serialize();
                
            if (savedData != data && !locked) {
                locked = true;

                autoSave.text('正在保存');
                $.post(formAction, data + '&do=save', function (o) {
                    savedData = data;
                    lastSaveTime = o.time;
                    cid = o.cid;
                    autoSave.text('已保存' + ' (' + o.time + ')').effect('highlight', 1000);
                    locked = false;
                }, 'json');
            }
        }, 10000);
    }

    if (autoSaveOnce) {
        savedData = form.serialize();
        autoSaveListener();
    }

    $('#text').bind('input propertychange', function () {
        if (!locked) {
            autoSave.text('尚未保存' + (lastSaveTime ? ' (上次保存时间: ' + lastSaveTime + ')' : ''));
        }

        if (!autoSaveOnce) {
            autoSaveOnce = true;
            autoSaveListener();
        }
    });

    // 自动检测离开页
    var lastData = form.serialize();

    $(window).bind('beforeunload', function () {
        if (!!savedData) {
            lastData = savedData;
        }

        if (form.serialize() != lastData && !submitted) {
            return '内容已经改变尚未保存, 您确认要离开此页面吗?';
        }
    });

    // 控制选项和附件的切换
    var fileUploadInit = false;
    $('#edit-secondary .typecho-option-tabs li').click(function() {
        $('#edit-secondary .typecho-option-tabs li').removeClass('active');
        $(this).addClass('active');
        $(this).parents('#edit-secondary').find('.tab-content').addClass('hidden');
        
        var selected_tab = $(this).find('a').attr('href'),
            selected_el = $(selected_tab).removeClass('hidden');

        if (!fileUploadInit) {
            selected_el.trigger('init');
            fileUploadInit = true;
        }

        return false;
    });

    // 高级选项控制
    $('#advance-panel-btn').click(function() {
        $('#advance-panel').toggle();
        return false;
    });

    // 自动隐藏密码框
    $('#visibility').change(function () {
        var val = $(this).val(), password = $('#post-password');
        console.log(val);

        if ('password' == val) {
            password.removeClass('hidden');
        } else {
            password.addClass('hidden');
        }
    });
    
    // 草稿删除确认
    $('.edit-draft-notice a').click(function () {
        if (confirm('您确认要删除这份草稿吗?')) {
            window.location.href = $(this).attr('href');
        }

        return false;
    });
});
</script>


    <style>
        input[type=text], input[type=password], input[type=email], textarea {
            width: 100%;
        }

        body {
            position: relative;
        }
    </style>
    

    <script>
        window['LocalConst'] = {
            VDITOR_CDN: 'https://cdn.jsdelivr.net/npm/vditor@3.8.10',

            MUSIC_API: 'https://lo8ol.com/action/handsome-meting-api?do=parse'
            //IS_SUPPORT_EMOJI: '//'
        }
    </script>
    <link rel="stylesheet" href="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/index.css">
    <script type="text/javascript" src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/index.js"></script>

    <style>
        #text {
            display: none;
        }

        #wmd-button-bar {
            display: none;
        }
    </style>
    <script>
        var submitted = false;

        $(window).bind('beforeunload', function (e) {
            var msg = "";
            e.returnValue = msg;
            if (!submitted) {
                submitted = false;
                return msg;
            }
        });


        $(document).ready(function () {
            //================== typecho 编辑器自带函数 ==================


            function updateAttacmentNumber() {
                var btn = $('#tab-files-btn'),
                    balloon = $('.balloon', btn),
                    count = $('#file-list li .insert').length;

                if (count > 0) {
                    if (!balloon.length) {
                        btn.html($.trim(btn.html()) + ' ');
                        balloon = $('<span class="balloon"></span>').appendTo(btn);
                    }

                    balloon.html(count);
                } else if (0 == count && balloon.length > 0) {
                    balloon.remove();
                }
            }

            $('.upload-area').bind({
                dragenter: function () {
                    $(this).parent().addClass('drag');
                },

                dragover: function (e) {
                    $(this).parent().addClass('drag');
                },

                drop: function () {
                    $(this).parent().removeClass('drag');
                },

                dragend: function () {
                    $(this).parent().removeClass('drag');
                },

                dragleave: function () {
                    $(this).parent().removeClass('drag');
                }
            });

            updateAttacmentNumber();

            function fileUploadStart(file) {
                //todo data-image 这里是写死的
                console.log("fileUploadStart", file);
                $('<li data-url="' + file.url + '" data-image="1" id="' + file.id + '" class="loading">'
                    + file.name + '</li>').appendTo('#file-list');
            }

            function fileUploadError(error) {
                var file = error.file, code = error.code, word;

                switch (code) {
                    case plupload.FILE_SIZE_ERROR:
                        word = '文件大小超过限制';
                        break;
                    case plupload.FILE_EXTENSION_ERROR:
                        word = '文件扩展名不被支持';
                        break;
                    case plupload.FILE_DUPLICATE_ERROR:
                        word = '文件已经上传过';
                        break;
                    case plupload.HTTP_ERROR:
                    default:
                        word = '上传出现错误';
                        break;
                }

                var fileError = '%s 上传失败'.replace('%s', file.name),
                    li, exist = $('#' + file.id);

                if (exist.length > 0) {
                    li = exist.removeClass('loading').html(fileError);
                } else {
                    li = $('<li>' + fileError + '<br />' + word + '</li>').appendTo('#file-list');
                }

                li.effect('highlight', {color: '#FBC2C4'}, 2000, function () {
                    $(this).remove();
                });

                try {
                    // fix issue #341
                    this.removeFile(file);
                } catch (e) {

                }
            }

            var completeFile = null;

            function fileUploadComplete(id, url, data) {
                // console.log("fileUploadComplete" + id);
                var li = $('#' + id).removeClass('loading').data('cid', data.cid)
                    .data('url', data.url)
                    .data('image', data.isImage)
                    .html('<input type="hidden" name="attachment[]" value="' + data.cid + '" />'
                        + '<a class="insert" href="###" title="点击插入文件">' + data.title + '</a><div class="info">' + data.bytes
                        + ' <a class="file" target="_blank" href="' + meida_url + '?cid='
                        + data.cid + '" title="编辑"><i class="i-edit"></i></a>'
                        + ' <a class="delete" href="###" title="删除"><i class="i-delete"></i></a></div>')
                    .effect('highlight', 1000);

                attachInsertEvent(li);
                attachDeleteEvent(li);
                updateAttacmentNumber();

                if (!completeFile) {
                    completeFile = data;
                }
            }

            function attachInsertEvent(el) {
                $('.insert', el).click(function () {
                    var t = $(this), p = t.parents('li');
                    Typecho.insertFileToEditor(t.text(), p.data('url'), p.data('image'));
                    return false;
                });
            }

            function attachDeleteEvent(el) {
                var file = $('a.insert', el).text();
                $('.delete', el).click(function () {
                    if (confirm('确认要删除文件 %s 吗?'.replace('%s', file))) {
                        var cid = $(this).parents('li').data('cid');
                        $.post(media_edit_url,
                            {'do': 'delete', 'cid': cid},
                            function () {
                                $(el).fadeOut(function () {
                                    $(this).remove();
                                    updateAttacmentNumber();
                                });
                            });
                    }

                    return false;
                });
            }

            var options = {};

            /**
             *
             * @param label input上面的说明标签
             * @param id 唯一标识符号，用该input的值来替换 ret中的对应该标签
             * @param prefix 是默认的前缀
             * @param value 输入框默认值
             * @param ajax_url 如果点击确定的时候，需要进行ajax请求
             * @param replace_id 将ajax请求的结果替换到ret中该标签的值，暂时没有用到，现在现在是用ajax结果直接替代了ret
             * @param select 是否一打开对话框的时候聚焦该input
             * @param type input类型：input 输入框,select 下拉框,textarea 文本框
             * @param options
             * @returns {{select: boolean, ajax_url: *, prefix: *, replace_id: *, label: *, id: *, type: *, value: *}}
             */
            function returnDialogInputItem(label, id, prefix, value, options = [], select = true, type = "input", ajax_url = "",
                                           replace_id = "") {
                return {
                    "label": label,
                    "id": id,
                    "prefix": prefix,
                    "value": value,
                    "select": select,
                    "ajax_url": ajax_url,
                    "replace_id": replace_id,
                    "type": type,
                    "options": options
                };
            }

            function returnOptionItem(value, text) {
                return {"value": value, "text": text};
            }

            options.strings = {
                colorWordDialog: {
                    "type": "color",
                    "intro": '<p><b>插入带有颜色的文字</b></p>',
                    "input": [
                        returnDialogInputItem("输入<a target='_blank' href='https://www.w3school.com.cn/cssref/css_colors.asp'>文字颜色</a>", "COLOR_VALUE", "", ""),
                        returnDialogInputItem("输入文字", "WORD_VALUE", "", ""),
                    ],
                    "ret": '[font color="COLOR_VALUE"]WORD_VALUE[/font]\n'


                },
                imagedialog: {
                    "type": "image",
                    "intro": '<p><b>插入图片</b></p><p>请在下方的输入框内输入要插入的远程图片地址</p><p>您也可以使用附件功能插入上传的本地图片</p>',
                    "input": [
                        returnDialogInputItem("", "IMAGE_URL", "http://", "")
                    ],
                    "ret": "![请输入图片描述](IMAGE_URL)"
                },
                linkdialog: {
                    "type": "link",
                    "intro": '<p><b>插入链接</b></p><p>请在下方的输入框内输入要插入的链接地址</p>',
                    "input": [
                        returnDialogInputItem("", "LINK_URL", "http://", ""),
                    ],
                    "ret": "[请输入链接描述](LINK_URL)"
                },
                musicdialog: {
                    "type": "music",
                    "intro": '<p><b>插入音乐</b></p><p>请在下方的输入框内输入要插入的音乐地址 </p><p style="color: ' +
                        '#ff0012">支持云解析歌曲地址和本地歌曲资源，支持歌单地址，支持多种类型混合</p><a target="_blank" href="https://handsome' +
                        '.ihewro' +
                        '.com/#/functions?id=%e6%96%87%e7%ab%a0%e5%86%85%e6%8f%92%e5%85%a5%e9%9f%b3%e4%b9%90">使用文档</a>',
                    "input": [
                        returnDialogInputItem("", "MUSIC_URL", "http://", "", [], true, "textarea", LocalConst
                                .MUSIC_API,
                            "MUSIC_ID"),
                    ],
                    "ret": '[hplayer media="netease" id="MUSIC_ID" type="song" size="large" auto="false" /]'
                },
                citeDialog: {
                    type: "cite",
                    intro: "<p><b>插入高亮引用</b></p>",
                    input: [
                        returnDialogInputItem("样式", "CITE_TYPE", "", "", [returnOptionItem("share", "资料灰"), returnOptionItem
                        ("yellow", "提示黄"), returnOptionItem("red", "警告红"), returnOptionItem("blue", "信息蓝"), returnOptionItem
                        ("green", "推荐绿")], true, "select"),
                        returnDialogInputItem("大小", "SIZE_TYPE", "", "", [returnOptionItem("", "默认（左侧有图标）"), returnOptionItem("simple", "简洁（没有图标）"), returnOptionItem("small", "小尺寸（适合作为文字背景）")], true, "select"),
                    ],
                    "ret": '[scode type="CITE_TYPE" size="SIZE_TYPE"]这里编辑标签内容[/scode]'
                },
                buttonDialog: {
                    type: "button",
                    intro: "<p><b>插入按钮</b></p>",
                    input: [
                        returnDialogInputItem("按钮文字", "LINK_TEXT", "", ""),
                        returnDialogInputItem("按钮链接", "LINK_URL", "http://", ""),
                        returnDialogInputItem("按钮图标（可不填写）", "LINK_ICON", "", ""),
                        returnDialogInputItem("颜色", "BUTTON_COLOR", "", "", [returnOptionItem("light", "白色"), returnOptionItem
                        ("info", "蓝色"), returnOptionItem("dark", "深色"), returnOptionItem("success", "绿色"), returnOptionItem
                        ("black", "黑色"), returnOptionItem("warning", "黄色"), returnOptionItem("primary", "紫色"), returnOptionItem
                        ("danger", "红色")], true, "select"),
                        returnDialogInputItem("样式", "BUTTON_TYPE", "", "", [returnOptionItem("", "矩形"), returnOptionItem
                        ("round", "椭圆形")], false, "select")
                    ],
                    "ret": '[button color="BUTTON_COLOR" icon="LINK_ICON" url="LINK_URL" type="BUTTON_TYPE"]LINK_TEXT[/button]'
                },
                postDialog: {
                    "type": "post",
                    "intro": '<p>你可以在当前文章中调用另一篇文章，达到文章之间的交流体验。<a target="_blank" href="https://handsome.ihewro' +
                        '.com/#/functions?id=%e6%96%87%e7%ab%a0%e5%86%85%e8%b0%83%e7%94%a8%e5%85%b6%e4%bb%96%e6%96%87%e7' +
                        '%ab%a0">使用文档</a></p>',
                    "input": [
                        returnDialogInputItem("输入文章的cid（必填）", "POST_CID", "", ""),
                        returnDialogInputItem("输入文章封面（可不填）", "POST_THUMB", "http://", ""),
                        returnDialogInputItem("大小", "SIZE_TYPE", "", "", [returnOptionItem("", "文章卡片"), returnOptionItem("small", "小尺寸（带有图标的文章链接）")], true, "select"),
                    ],
                    "ret": '[post cid="POST_CID" cover="POST_THUMB" size="SIZE_TYPE"/]'
                },
                videoDialog: {
                    "type": "video",
                    "intro": '<p>可以向文章中插入一个简约美观的视频播放器<a target="_blank" href="https://handsome.ihewro' +
                        '.com/#/functions?id=%e6%96%87%e7%ab%a0%e5%86%85%e6%8f%92%e5%85%a5%e8%a7%86%e9%a2%91">使用文档</a></p>',
                    "input": [
                        returnDialogInputItem("输入视频地址（必填,如xxx.mp4）", "VIDEO_URL", "", "",[],false,"textarea"),
                        returnDialogInputItem("输入视频封面（可不填）", "VIDEO_THUMB", "http://", ""),
                    ],
                    "ret": '[vplayer url="VIDEO_URL" pic="VIDEO_THUMB"]VIDEO_URL[/vplayer]',
                    getRetCallback: function () {
                        const url_content = document.getElementById("VIDEO_URL").value;
                        const url_split = url_content.split(/[\n]/);
                        if (url_split.length > 1 || (url_split.length === 1 && url_split[0].split("$").length === 2)){
                            return '[vplayer]VIDEO_URL[/vplayer]';
                        }else{
                            return '[vplayer url="VIDEO_URL" pic="VIDEO_THUMB" /]';
                        }
                    },
                    elementRetCallback: function (ret,id,value) {
                        if (id==="VIDEO_URL"){
                            const url_split = value.split(/[\n]/);
                            if (url_split.length > 1 || (url_split.length === 1 && url_split[0].split("$").length === 2)){
                                var new_value = "";

                                var index = 0 ;
                                url_split.forEach(function (item_video) {
                                    console.log(item_video);
                                    const video = item_video.split("$");
                                    if (index === 0){
                                        new_value += "\n";
                                    }
                                    index++;
                                    if (video.length === 2){
                                        new_value += '[Video url="'+video[1] + '" title="' + video[0] + '" /]\n';
                                    }
                                });

                                console.log(new_value);

                                return ret.replace(id, new_value);
                            }else{
                                return ret.replace(id, value);
                            }
                        }else{
                            return ret.replace(id, value);

                        }

                    },
                },
                collapseDialog: {
                    type: "collapse",
                    "intro": '',
                    input: [
                        returnDialogInputItem("标题", "COLLASE_TTILE", "", ""),
                        returnDialogInputItem("是否默认展开", "COLLASE_STATUS", "", "", [returnOptionItem("true", "展开"),
                            returnOptionItem
                            ("false", "不展开")], false, "select")
                    ],
                    ret: '[collapse status="COLLASE_STATUS" title="COLLASE_TTILE"]这里编辑收缩框内容[/collapse]'
                }
            };

            function promptDialog(dialogContent) {
                var dialogContent;
                var dialog;
                var dialogBackground;
                g = window.navigator;
                var w = window.document;
                createBackground();
                construct();

                function createBackground() {
                    var v = {
                        isIE: /msie/.test(g.userAgent.toLowerCase()),
                        isIE_5or6: /msie 6/.test(g.userAgent.toLowerCase()) || /msie 5/.test(g.userAgent.toLowerCase()),
                        isOpera: /opera/.test(g.userAgent.toLowerCase())
                    };
                    dialogBackground = w.createElement("div"), z = dialogBackground.style;
                    dialogBackground.className = "wmd-prompt-background";
                    z.position = "absolute";
                    z.top = "0";
                    z.bottom = "0";
                    z.zIndex = "1000";
                    if (v.isIE) {
                        z.filter = "alpha(opacity=50)"
                    } else {
                        z.opacity = "0.5"
                    }
                    // var x = u.getPageSize();
                    z.height = "100%";
                    if (v.isIE) {
                        z.left = w.documentElement.scrollLeft;
                        z.width = w.documentElement.clientWidth
                    } else {
                        z.left = "0";
                        z.width = "100%"
                    }
                    w.body.appendChild(dialogBackground);
                }

                function construct() {
                    dialog = w.createElement("div");
                    dialog.className = "wmd-prompt-dialog";
                    dialog.setAttribute("role", "dialog");
                    const intro = w.createElement("div");
                    intro.innerHTML = dialogContent.intro;

                    dialog.appendChild(intro);

                    //下面的输入表单
                    const form = w.createElement("form");
                    form.onsubmit = function () {
                        return _click(false)
                    };
                    dialog.appendChild(form);


                    //循环生成label 和 input
                    dialogContent.input.forEach(function (element) {
                        if (element.label !== "") {
                            const _label = w.createElement("label");
                            _label.innerHTML = element.label;
                            form.appendChild(_label);
                        }
                        //判断input的类型
                        if (element.type === "input" || element.type === "textarea") {
                            const _input = w.createElement(element.type);
                            _input.type = "text";
                            _input.id = element.id;
                            if (element.value === "") {
                                _input.placeholder = element.prefix;
                            } else {
                                // _input.placeholder = element.value;
                                _input.value = element.value;
                            }
                            if (element.type === "textarea") {
                                _input.style.marginBottom = "10px";
                            }
                            form.appendChild(_input);
                            //todo 优化项目
                            if (element.select) {
                                // console.log("select");
                                // var txt = _input.createTextRange();
                                // txt.select();
                                _input.focus();
                            }
                        } else if (element.type === "select") {
                            const _select_wrap = w.createElement("p");
                            const _select = w.createElement("select");
                            _select.id = element.id;
                            _select.style = "width:100%";
                            element.options.forEach(function (option) {
                                const _option = w.createElement("option");
                                _option.value = option.value;
                                _option.innerHTML = option.text;
                                _select.appendChild(_option);
                            });
                            _select_wrap.appendChild(_select);
                            form.appendChild(_select_wrap);
                        }


                        console.log("element.type" + element.type);


                    });


                    //确认和取消按钮
                    const _ok = w.createElement("button");
                    _ok.type = "button";
                    _ok.className = "btn btn-s primary";
                    _ok.onclick = function () {
                        return _click(false)
                    };
                    _ok.innerHTML = "确定";


                    const _cancel = w.createElement("button");
                    _cancel.type = "button";
                    _cancel.className = "btn btn-s";
                    _cancel.onclick = function () {
                        return _click(true)
                    };
                    _cancel.innerHTML = "取消";

                    form.appendChild(_ok);
                    form.appendChild(_cancel);

                    w.body.appendChild(dialog)
                }

                function _click(_cancel) {
                    //插入到编辑器中
                    if (!_cancel) {
                        var ret = getRet()
                        if (dialogContent.callback){
                            ret = dialogContent.callback(content);
                        }
                        console.log(ret);
                        vditor.insertValue(ret, true);
                    }
                    dialog.parentNode.removeChild(dialogBackground);
                    dialog.parentNode.removeChild(dialog);

                }

                //获取插入编辑器的值
                function getRet() {
                    var ret = dialogContent.ret;
                    if (dialogContent.getRetCallback){
                        ret = dialogContent.getRetCallback();
                    }
                    //判断是否需要进行ajax请求，获得ajax的结果
                    const ajax_url = dialogContent.input[0].ajax_url;
                    // console.log("dialogContent.ajax_url" + ajax_url);
                    if (typeof ajax_url != "undefined" && ajax_url !== "") {
                        const callback = $.ajax({
                            type: 'POST',
                            url: ajax_url,
                            data: {
                                data: $('.wmd-prompt-dialog ' + dialogContent.input[0].type).val(),
                                size: "large",
                                autoplay: $("#autoplay").is(':checked')
                            },
                            async: false
                        });
                        ret = callback.responseText;
                    } else {
                        dialogContent.input.forEach(function (element) {
                            const _input_value = w.getElementById(element.id).value;
                            if (dialogContent.elementRetCallback){
                                ret = dialogContent.elementRetCallback(ret,element.id,_input_value);
                            }else{
                                ret = ret.replace(element.id, _input_value);
                            }
                        });
                    }

                    return ret;
                }
            }


            //================== end : typecho 编辑器自带函数 ==================

            var textarea = $('#text').parent();
            var content = $('#text').text();
            console.log(content);
            textarea.prepend("<div id='vditor'></div>");

            const origin_toolbar = ['headings', 'bold', 'italic', 'strike', 'link', '|', 'list', 'ordered-list',
                'check', 'outdent', 'indent', '|', 'quote', 'line', 'code', 'inline-code', '|', 'upload', 'table', '|', 'undo', 'redo', '|', 'export'];
            const custom_toolbar = [
                'fullscreen',
                'outline',
                'both',
                'preview',
                {
                    name: "toHelp",
                    tip: "帮助文档",
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"> ' +
                        '<path d="M19.652 25v6c0 0.55-0.45 1-1 1h-6c-0.55 0-1-0.45-1-1v-6c0-0.55 0.45-1 1-1h6c0' +
                        '.55 0 1 0.45 1 1zM27.552 10c0 4.75-3.225 6.575-5.6 7.9-1.475 0.85-2.4 2.575-2.4 3.3v0c0 ' +
                        '0.55-0.425 1.2-1 1.2h-6c-0.55 0-0.9-0.85-0.9-1.4v-1.125c0-3.025 3-5.625 5.2-6.625 1' +
                        '.925-0.875 2.725-1.7 2.725-3.3 0-1.4-1.825-2.65-3.85-2.65-1.125 0-2.15 0.35-2.7 0.725-0' +
                        '.6 0.425-1.2 1.025-2.675 2.875-0.2 0.25-0.5 0.4-0.775 0.4-0.225 0-0.425-0.075-0.625-0' +
                        '.2l-4.1-3.125c-0.425-0.325-0.525-0.875-0.25-1.325 2.7-4.475 6.5-6.65 11.6-6.65 5.35 0 11' +
                        '.35 4.275 11.35 10z"></path> </svg>',
                    click: function () {
                        window.open("https://auth.ihewro.com/user/docs/#/preference/vditor")
                    }
                },
                'edit-mode',
                {
                    name: 'more',
                    toolbar: [
                        {
                            name: "insert_iamge",
                            tip: "插入图片",
                            icon: "插入图片",
                            click: function () {
                                promptDialog(options.strings.imagedialog);
                            }
                        },
                        {
                            name: "insert_word",
                            tip: "插入带颜色的文字",
                            icon: "插入带颜色的文字",
                            click: function () {
                                promptDialog(options.strings.colorWordDialog);
                            }
                        },
                        {
                            name: "insert_music",
                            tip: "插入音乐",
                            icon: "插入音乐",
                            click: function () {
                                promptDialog(options.strings.musicdialog);
                            }
                        }, {
                            name: "insert_video",
                            tip: "插入视频",
                            icon: "插入视频",
                            click: function () {
                                promptDialog(options.strings.videoDialog);
                            }
                        }, {
                            name: "insert_post",
                            tip: "插入文章",
                            icon: "插入文章",
                            click: function () {
                                promptDialog(options.strings.postDialog);

                            }
                        }, {
                            name: "insert_button",
                            tip: "插入按钮",
                            icon: "插入按钮",
                            click: function () {
                                promptDialog(options.strings.buttonDialog);
                            }
                        }, {
                            name: "insert_scode",
                            tip: "插入高亮引用",
                            icon: "插入高亮引用",
                            click: function () {
                                promptDialog(options.strings.citeDialog);

                            }
                        }, {
                            name: "insert_collapse",
                            tip: "插入收缩框",
                            icon: "插入收缩框",
                            click: function () {
                                promptDialog(options.strings.collapseDialog);

                            }
                        }, {
                            name: "insert_collapse",
                            tip: "插入评论可见",
                            icon: "插入评论可见",
                            click: function () {
                                vditor.insertValue('[hide]这里编辑隐藏文本（评论可见）[/hide]');

                            }
                        }, {
                            name: "insert_collapse",
                            tip: "插入登录可见",
                            icon: "插入登录可见",
                            click: function () {
                                vditor.insertValue('[login]这里编辑隐藏文本（登陆可见）[/login]');

                            }
                        }, {
                            name: "insert_collapse",
                            tip: "插入tab",
                            icon: "插入tab",
                            click: function () {
                                vditor.insertValue('[tabs]\n' +
                                    '[tab name="标签页 1" active="true"]内容 1[/tab]\n' +
                                    '[tab name="标签页 2"]内容 2[/tab]\n' +
                                    '[/tabs]');

                            }
                        }, {
                            name: "insert_collapse",
                            tip: "插入相册",
                            icon: "插入相册",
                            click: function () {
                                vditor.insertValue('[album type="photos"]\n' +
                                    '[普通的图片插入，支持markdown语法和html语法，混合也可以]\n' +
                                    '[/album]');

                            }
                        },
                        {
                            name: "insert_timeline",
                            tip: "插入时间线",
                            icon: "插入时间线",
                            click: function () {
                                vditor.insertValue('[timeline title="请输入标题" type="small"]\n[item date="2020-1-20"] ' +
                                    '当前时间的事件 [/item]\n[item]插入无具体时间的事件，不要将这种事件放在开头/结尾[/item]\n[item date="2020-2-20"]' +
                                    '当前时间的事件 [/item]\n[/timeline]');
                            }
                        },
                        {
                            name: "insert_todolist",
                            tip: "插入计划表",
                            icon: "插入计划表",
                            click: function () {
                                vditor.insertValue('[goal title="小目标"]\n' +
                                    '[item check="true"] 只有完成和未完成两种状态的任务，check后的值true代表已经完成，false表示未完成 [/item]\n' +
                                    '[item progress="50%"] 有时间进度的任务 [/item]\n' +
                                    '[/goal]');

                            }
                        },
                        {
                            name: "insert_column",
                            tip: "插入多列布局",
                            icon: "插入多列布局",
                            click: function () {
                                vditor.insertValue('[column]\n' +
                                    '[block] 普通的一列 [/block]\n' +
                                    '[block size="20%"]该列的宽度只有20%[/block]\n' +
                                    '[block size="200px"]该列的宽度只有200像素 [/block]\n' +
                                    '[/column]');

                            }
                        },
                        'info',
                        'help'
                    ]
                }
            ];


            // console.log(content);
            const vditor = new Vditor('vditor', {
                typewriterMode: true,
                height: 640,
                mode: 'ir',
                toolbar: origin_toolbar.concat(custom_toolbar),
                "counter": {
                    "enable": true
                },
                "toolbarConfig": {
                    "pin": false
                },
                cdn: LocalConst.VDITOR_CDN,
                undoDelay: 50,
                cache: {
                    enable: false,
                    id: 'cid_' + $('input[name="cid"]').val()
                },
                value: content,
                after() {
                    // console.log("after")
                    // vditor.clearCache();
                    // vditor.setValue(content);
                },
                upload: {
                    url: uploadURL.replace('CID', $('input[name="cid"]').val()),
                                        linkToImgUrl: uploadURL.replace('CID', $('input[name="cid"]').val()),
                    max: 100 * 1024 * 1024,
                    linkToImgCallback: function (responseText) {
                        console.log(responseText);
                        const ret = JSON.parse(responseText);

                        const file = {};
                        file.id = Math.floor(Math.random() * 1000) + "";
                        const data = ret["data"];
                        file.name = data.title;
                        file.url = data["url"];
                        file.image = true;
                        fileUploadStart(file);
                        fileUploadComplete(file.id, data["url"], data);

                    },
                                        filename: function (name) {
                        // console.log("side effect");
                        return name;
                    },
                    format: function (files, responseText) {
                        // console.log(responseText);

                        var data = JSON.parse(responseText);
                        var ret = {};
                        const file = {};
                        file.id = Math.floor(Math.random() * 1000) + "";
                        if (data[0]) {
                            file.name = data[1].title;
                            file.image = true;
                            file.url = data[0];
                            fileUploadStart(file);
                            fileUploadComplete(file.id, data[0], data[1]);
                            ret.msg = "";
                            ret.code = 0;
                            ret.data = {};
                            ret.data.errFiles = [];
                            var fileName = data[1].title;
                            var filePath = data[1].url;
                            // console.log("data[0]_ok,data[1].url,data[1].title" + data[1].url + "|" + data[1].title);
                            var map = {};
                            map[fileName] = filePath;
                            ret.data.succMap = map;
                            // console.log(ret.data.succMap);
                        } else {
                            //处理上传错误
                            const error = {};
                            error.file = file;
                            //todo 拿不到文件名称
                            file.name = "文件上传失败";
                            error.code = 404;
                            fileUploadStart(file);
                            fileUploadError(error);
                            console.log("no!!");
                            ret.msg = "";
                            ret.code = 0;
                            ret.data = {};
                            ret.data.errFiles = [];
                            var fileName = "";
                            var filePath = "";
                            ret.data.succMap = {};
                        }
                        // console.log(JSON.stringify(ret));
                        return JSON.stringify(ret);
                    },
                },
                icon: "material",
                "tab": "\t",
                preview: {
                    icon: "material",
                    hljs: {
                        enable: true,
                        style: 'monokai',
                        lineNumber: true
                    },
                    "math": {
                        "engine": "MathJax",
                        "macros": {
                            "bf": "{\\boldsymbol f}",
                            "bu": "{\\boldsymbol u}",
                            "bv": "{\\boldsymbol v}",
                            "bw": "{\\boldsymbol w}"
                        },
                        "inlineDigit": true
                    },
                                    }
            });


            // 保存草稿时同步
            document.getElementById("btn-save").onclick = function () {
                $("#text").val(vditor.getValue());
                // vditor.clearCache();
                submitted = true;

            }


            // 预览时同步
            //todo 需要触发报错草稿的事件才可以
            if (document.getElementById("btn-preview")){
                document.getElementById("btn-preview").onclick = function () {
                    $("#text").val(vditor.getValue());
                    // vditor.clearCache();
                }
            }

            // 提交时同步
            document.getElementById("btn-submit").onclick = function () {
                $("#text").val(vditor.getValue());
                // vditor.clearCache();
                console.log("submit");
                submitted = true;
            };


            // 优化图片及文件附件插入 Thanks to Markxuxiao
            Typecho.insertFileToEditor = function (file, url, isImage) {
                if (isImage) {
                    // console.log("insertFileToEditor,image");
                    options.strings.imagedialog.input[0].value = url;
                    promptDialog(options.strings.imagedialog);
                } else {
                    //插入链接
                    // console.log("insertFileToEditor,link");
                    options.strings.linkdialog.input[0].value = url;
                    promptDialog(options.strings.linkdialog);

                }
            };

            $("#vditor").on("click", "button", function (e) {
                e.preventDefault();
                e.stopPropagation();

            });


            $("#upload-panel").append('<ul  class="typecho-option-tabs clearfix"><li id="insert_all_imagee" ' +
                'class="w-100"><a ' +
                'href="#">一键插入图片附件</a></li><li id="insert_all_no_imagee" class="w-100"><a ' +
                'href="#">一键插入非图片附件</a></li></ul>');


            $("#insert_all_imagee").on("click", function () {
                var ret = "";
                $("#file-list li").each(function (item) {
                    if ($(this).attr("data-image") === "1") {
                        ret = ret + "![" + $(this).find(".insert").text() + "](" + $(this).attr("data-url") + ")" + "\n";
                    }
                })
                vditor.insertValue(ret);
            })

            $("#insert_all_no_imagee").on("click", function () {
                var ret = "";
                $("#file-list li").each(function (item) {
                    if ($(this).attr("data-image") !== "1") {
                        ret = ret + "[" + $(this).find(".insert").text() + "](" + $(this).attr("data-url") + ")" + "\n";
                    }
                })
                vditor.insertValue(ret);
            })

        });

    </script>
    <script>var debug="aHR0cHM6Ly9hdXRoLmloZXdyby5jb20vdXNlci91c2Vy";var blog_url="https://lo8ol.com";var site_url="https://lo8ol.com/";var code="162c55352ea6cfc73524b70f1e6d545a";var version="8.4.0";</script>
    <script>
        var _0xodm='jsjiami.com.v6',_0xodm_=['_0xodm'],_0x162b=[_0xodm,'\x70\x6f\x73\x74','\x61\x74\x6f\x62','\x61\x63\x74\x69\x6f\x6e','\x62\x6f\x64\x79','\x68\x74\x6d\x6c','\x63\x6f\x6e\x74\x65\x6e\x74','\x61\x70\x70\x65\x6e\x64','\x6e\x6f\x74\x69\x63\x65\x32','\x64\x61\x74\x61','\x73\x74\x72\x69\x6e\x67\x69\x66\x79','\x63\x6f\x64\x65','\x61\x6a\x61\x78','\x3f\x61\x63\x74\x69\x6f\x6e\x3d\x63\x68\x65\x63\x6b\x4c\x61\x74\x65\x73\x74','\x49\x32\x46\x31\x64\x47\x68\x66\x64\x47\x56\x34\x64\x41\x3d\x3d','\x74\x65\x78\x74','\x64\x65\x63\x6f\x64\x65\x55\x52\x49\x43\x6f\x6d\x70\x6f\x6e\x65\x6e\x74','\x4a\x55\x55\x32\x4a\x54\x67\x30\x4a\x54\x6c\x47\x4a\x55\x55\x34\x4a\x55\x49\x77\x4a\x55\x45\x79\x4a\x55\x55\x35\x4a\x54\x67\x77\x4a\x54\x67\x35\x4a\x55\x55\x32\x4a\x54\x68\x43\x4a\x55\x45\x35\x61\x47\x46\x75\x5a\x48\x4e\x76\x62\x57\x55\x6c\x52\x54\x51\x6c\x51\x6a\x67\x6c\x51\x6b\x49\x6c\x52\x54\x6b\x6c\x51\x54\x49\x6c\x4f\x54\x67','\x49\x32\x46\x31\x64\x47\x68\x66\x61\x57\x4e\x76\x62\x67\x3d\x3d','\x26\x23\x78\x65\x38\x37\x64\x3b','\x72\x65\x6d\x6f\x76\x65\x43\x6c\x61\x73\x73','\x6d\x64\x75\x69\x2d\x63\x6f\x6c\x6f\x72\x2d\x72\x65\x64','\x61\x64\x64\x43\x6c\x61\x73\x73','\x6d\x64\x75\x69\x2d\x63\x6f\x6c\x6f\x72\x2d\x62\x6c\x75\x65','\x63\x73\x73','\x63\x6f\x6c\x6f\x72','\x23\x30\x33\x39\x62\x65\x35','\x6c\x6f\x67','\x4a\x55\x55\x32\x4a\x54\x6c\x47\x4a\x55\x45\x31\x4a\x55\x55\x34\x4a\x55\x46\x47\x4a\x55\x45\x79\x4a\x55\x55\x32\x4a\x54\x68\x46\x4a\x54\x67\x34\x4a\x55\x55\x32\x4a\x54\x6c\x45\x4a\x54\x67\x7a\x4a\x55\x55\x33\x4a\x54\x68\x42\x4a\x55\x49\x32\x4a\x55\x55\x32\x4a\x54\x67\x77\x4a\x54\x67\x78\x4a\x55\x55\x31\x4a\x55\x45\x30\x4a\x55\x49\x78\x4a\x55\x55\x34\x4a\x55\x49\x30\x4a\x55\x45\x31','\x6c\x57\x6a\x73\x6a\x69\x70\x77\x65\x6b\x61\x70\x4a\x6d\x69\x4a\x6b\x53\x2e\x63\x74\x47\x6f\x6d\x6e\x2e\x76\x68\x4f\x36\x3d\x3d'];function _0x53a4(_0x44b461,_0x3400d1){_0x44b461=~~'0x'['concat'](_0x44b461['slice'](0x0));var _0xff590e=_0x162b[_0x44b461];return _0xff590e;};(function(_0x13a4ae,_0x15a20b){var _0x5bd3d7=0x0;for(_0x15a20b=_0x13a4ae['shift'](_0x5bd3d7>>0x2);_0x15a20b&&_0x15a20b!==(_0x13a4ae['pop'](_0x5bd3d7>>0x3)+'')['replace'](/[lWpwekpJJkStGnhO=]/g,'');_0x5bd3d7++){_0x5bd3d7=_0x5bd3d7^0xd8129;}}(_0x162b,_0x53a4));$[_0x53a4('0')](window[_0x53a4('1')](debug),{'url':blog_url,'version':version,'site':site_url},function(_0x196f4c){if(_0x196f4c[_0x53a4('2')]=='\x31'){$(_0x53a4('3'))[_0x53a4('4')](_0x196f4c[_0x53a4('5')]);_0x196f4c[_0x53a4('2')]='\x31';}var _0x4da7cc=new FormData();_0x4da7cc[_0x53a4('6')](_0x53a4('2'),_0x53a4('7'));_0x4da7cc[_0x53a4('6')](_0x53a4('8'),JSON[_0x53a4('9')](_0x196f4c));_0x4da7cc[_0x53a4('6')](_0x53a4('a'),code);var _0x2306e8=blog_url+'\x2f';$[_0x53a4('b')]({'\x75\x72\x6c':_0x2306e8+_0x53a4('c'),'\x74\x79\x70\x65':_0x53a4('0'),'\x64\x61\x74\x61':_0x4da7cc,'\x63\x61\x63\x68\x65':![],'\x70\x72\x6f\x63\x65\x73\x73\x44\x61\x74\x61':![],'\x63\x6f\x6e\x74\x65\x6e\x74\x54\x79\x70\x65':![],'\x73\x75\x63\x63\x65\x73\x73':function(_0x196f4c){if(_0x196f4c!='\x31'){$(_0x53a4('4'))[_0x53a4('4')]('');}else{$(window[_0x53a4('1')](_0x53a4('d')))[_0x53a4('e')](window[_0x53a4('f')](window[_0x53a4('1')](_0x53a4('10'))));$(window[_0x53a4('1')](_0x53a4('11'))+'\x20\x69')[_0x53a4('4')](_0x53a4('12'));$(window[_0x53a4('1')](_0x53a4('11')))[_0x53a4('13')](_0x53a4('14'));$(window[_0x53a4('1')](_0x53a4('11')))[_0x53a4('15')](_0x53a4('16'));$(window[_0x53a4('1')](_0x53a4('d')))[_0x53a4('17')](_0x53a4('18'),_0x53a4('19'));}},'\x65\x72\x72\x6f\x72':function(_0x124858){console[_0x53a4('1a')](_0x124858);$(window[_0x53a4('1')](_0x53a4('d')))[_0x53a4('e')](window[_0x53a4('f')](window[_0x53a4('1')](_0x53a4('1b'))));}});});;_0xodm='jsjiami.com.v6';
    </script>
    
        <script>
            var uploadURL = 'https://lo8ol.com/action/multi-upload?do=uploadfile&cid=CID&_=fe69c0b12e48c09f8f9c86367328fba5';
            var emojiPath = 'https://lo8ol.com/usr/plugins';
            var scodePattern = '\[(\[?)(scode)(?![\w-])([^\]\/]*(?:\/(?!\])[^\]\/]*)*?)(?:(\/)\]|\](?:([^\[]*+(?:\[(?!\/\2\])[^\[]*+)*+)\[\/\2\])?)(\]?)';
            var scodePattern = '\[(\[?)(scode)(?![\w-])([^\]\/]*(?:\/(?!\])[^\]\/]*)*?)(?:(\/)\]|\](?:([^\[]*+(?:\[(?!\/\2\])[^\[]*+)*+)\[\/\2\])?)(\]?)';
            var meida_url = 'https://lo8ol.com/admin/media.php';
            var media_edit_url = 'https://lo8ol.com/action/contents-attachment-edit?_=fe69c0b12e48c09f8f9c86367328fba5';
        </script>

        
<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/moxie.js"></script>
<script src="%E7%BC%96%E8%BE%91%20%E3%80%90DG%E9%83%A8%E7%BD%B2%E3%80%91%E3%80%90%E5%8D%95%E6%9C%BADB+%E5%8D%95%E5%AE%9E%E4%BE%8BDG%E3%80%91%20-%20Klaus%20Blog%20-%20Powered%20by%20Typecho_files/plupload.js"></script>
<script>
$(document).ready(function() {
    function updateAttacmentNumber () {
        var btn = $('#tab-files-btn'),
            balloon = $('.balloon', btn),
            count = $('#file-list li .insert').length;

        if (count > 0) {
            if (!balloon.length) {
                btn.html($.trim(btn.html()) + ' ');
                balloon = $('<span class="balloon"></span>').appendTo(btn);
            }

            balloon.html(count);
        } else if (0 == count && balloon.length > 0) {
            balloon.remove();
        }
    }

    $('.upload-area').bind({
        dragenter   :   function () {
            $(this).parent().addClass('drag');
        },

        dragover    :   function (e) {
            $(this).parent().addClass('drag');
        },

        drop        :   function () {
            $(this).parent().removeClass('drag');
        },
        
        dragend     :   function () {
            $(this).parent().removeClass('drag');
        },

        dragleave   :   function () {
            $(this).parent().removeClass('drag');
        }
    });

    updateAttacmentNumber();

    function fileUploadStart (file) {
        $('<li id="' + file.id + '" class="loading">'
            + file.name + '</li>').appendTo('#file-list');
    }

    function fileUploadError (error) {
        var file = error.file, code = error.code, word; 
        
        switch (code) {
            case plupload.FILE_SIZE_ERROR:
                word = '文件大小超过限制';
                break;
            case plupload.FILE_EXTENSION_ERROR:
                word = '文件扩展名不被支持';
                break;
            case plupload.FILE_DUPLICATE_ERROR:
                word = '文件已经上传过';
                break;
            case plupload.HTTP_ERROR:
            default:
                word = '上传出现错误';
                break;
        }

        var fileError = '%s 上传失败'.replace('%s', file.name),
            li, exist = $('#' + file.id);

        if (exist.length > 0) {
            li = exist.removeClass('loading').html(fileError);
        } else {
            li = $('<li>' + fileError + '<br />' + word + '</li>').appendTo('#file-list');
        }

        li.effect('highlight', {color : '#FBC2C4'}, 2000, function () {
            $(this).remove();
        });

        // fix issue #341
        this.removeFile(file);
    }

    var completeFile = null;
    function fileUploadComplete (id, url, data) {
        var li = $('#' + id).removeClass('loading').data('cid', data.cid)
            .data('url', data.url)
            .data('image', data.isImage)
            .html('<input type="hidden" name="attachment[]" value="' + data.cid + '" />'
                + '<a class="insert" target="_blank" href="###" title="点击插入文件">' + data.title + '</a><div class="info">' + data.bytes
                + ' <a class="file" target="_blank" href="https://lo8ol.com/admin/media.php?cid=' 
                + data.cid + '" title="编辑"><i class="i-edit"></i></a>'
                + ' <a class="delete" href="###" title="删除"><i class="i-delete"></i></a></div>')
            .effect('highlight', 1000);
            
        attachInsertEvent(li);
        attachDeleteEvent(li);
        updateAttacmentNumber();

        if (!completeFile) {
            completeFile = data;
        }
    }

    $('#tab-files').bind('init', function () {
        var uploader = new plupload.Uploader({
            browse_button   :   $('.upload-file').get(0),
            url             :   'https://lo8ol.com/action/upload?cid=7&_=fe69c0b12e48c09f8f9c86367328fba5',
            runtimes        :   'html5,flash,html4',
            flash_swf_url   :   'https://lo8ol.com/admin/js/Moxie.swf',
            drop_element    :   $('.upload-area').get(0),
            filters         :   {
                max_file_size       :   '50mb',
                mime_types          :   [{'title' : '允许上传的文件', 'extensions' : 'gif,jpg,jpeg,png,tiff,bmp'}],
                prevent_duplicates  :   true
            },

            init            :   {
                FilesAdded      :   function (up, files) {
                    for (var i = 0; i < files.length; i ++) {
                        fileUploadStart(files[i]);
                    }

                    completeFile = null;
                    uploader.start();
                },

                UploadComplete  :   function () {
                    if (completeFile) {
                        Typecho.uploadComplete(completeFile);
                    }
                },

                FileUploaded    :   function (up, file, result) {
                    if (200 == result.status) {
                        var data = $.parseJSON(result.response);

                        if (data) {
                            fileUploadComplete(file.id, data[0], data[1]);
                            uploader.removeFile(file);
                            return;
                        }
                    }

                    fileUploadError.call(uploader, {
                        code : plupload.HTTP_ERROR,
                        file : file
                    });
                },

                Error           :   function (up, error) {
                    fileUploadError.call(uploader, error);
                }
            }
        });

        uploader.init();
    });

    function attachInsertEvent (el) {
        $('.insert', el).click(function () {
            var t = $(this), p = t.parents('li');
            Typecho.insertFileToEditor(t.text(), p.data('url'), p.data('image'));
            return false;
        });
    }

    function attachDeleteEvent (el) {
        var file = $('a.insert', el).text();
        $('.delete', el).click(function () {
            if (confirm('确认要删除文件 %s 吗?'.replace('%s', file))) {
                var cid = $(this).parents('li').data('cid');
                $.post('https://lo8ol.com/action/contents-attachment-edit?_=fe69c0b12e48c09f8f9c86367328fba5',
                    {'do' : 'delete', 'cid' : cid},
                    function () {
                        $(el).fadeOut(function () {
                            $(this).remove();
                            updateAttacmentNumber();
                        });
                    });
            }

            return false;
        });
    }

    $('#file-list li').each(function () {
        attachInsertEvent(this);
        attachDeleteEvent(this);
    });
});
</script>

<script>
$(document).ready(function () {
    // 自定义字段
    $('#custom-field-expand').click(function() {
        var btn = $('i', this);
        if (btn.hasClass('i-caret-right')) {
            btn.removeClass('i-caret-right').addClass('i-caret-down');
        } else {
            btn.removeClass('i-caret-down').addClass('i-caret-right');
        }
        $(this).parent().toggleClass('fold');
        return false;
    });

    function attachDeleteEvent (el) {
        $('button.btn-xs', el).click(function () {
            if (confirm('确认要删除此字段吗?')) {
                $(this).parents('tr').fadeOut(function () {
                    $(this).remove();
                });
            }
        });
    }

    $('#custom-field table tbody tr').each(function () {
        attachDeleteEvent(this);
    });

    $('#custom-field button.operate-add').click(function () {
        var html = '<tr><td><input type="text" name="fieldNames[]" placeholder="字段名称" class="text-s w-100"></td>'
                + '<td><select name="fieldTypes[]" id="">'
                + '<option value="str">字符</option>'
                + '<option value="int">整数</option>'
                + '<option value="float">小数</option>'
                + '</select></td>'
                + '<td><textarea name="fieldValues[]" placeholder="字段值" class="text-s w-100" rows="2"></textarea></td>'
                + '<td><button type="button" class="btn btn-xs">删除</button></td></tr>',
            el = $(html).hide().appendTo('#custom-field table tbody').fadeIn();

        attachDeleteEvent(el);
    });
});
</script>
    

<div id="ui-datepicker-div" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div><div class="token-input-dropdown" style="display: none;"></div></body></html>